import sys
import os
import re
import logging
import hashlib
import shutil
import traceback
import time  # æ–°å¢å¯¼å…¥

# Add the project root directory to Python path
current_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.append(current_dir)
sys.path.append(os.path.join(current_dir, "GPT_SoVITS"))

from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QVBoxLayout, QHBoxLayout, QFrame, QGroupBox,
    QLabel, QPushButton, QFileDialog, QTextEdit, QLineEdit, QComboBox,
    QMessageBox, QGridLayout, QTableWidget, QHeaderView, QCheckBox,
    QScrollArea, QTableWidgetItem, QSlider, QSizePolicy, QStackedLayout,
    QWidget, QStackedWidget, QSpinBox, QDoubleSpinBox, QProgressBar, 
    QRadioButton, QProgressDialog)
from PyQt6.QtCore import (
    Qt, QUrl, QSize, QPoint, QTimer, QSettings
)
from PyQt6.QtGui import QColor, QPalette, QIcon, QFont, QTextCharFormat, QTextCursor
from PyQt6.QtMultimedia import QMediaPlayer, QAudioOutput, QMediaDevices
from text_processor import TextProcessor
from gpt_sovits import GPTSoVITS
from preset_manager import PresetManager
from preset_order_manager import PresetOrderManager
from model_cache import get_global_model_cache
from swipe_selector import SwipeSelector
from typing import List, Dict, Optional, Tuple
import jieba

logger = logging.getLogger(__name__)

class ReplaceHistoryManager:
    """ç®¡ç†æ›¿æ¢å†å²è®°å½•ï¼Œæ”¯æŒæŒä¹…åŒ–åˆ°æ–‡ä»¶"""
    
    def __init__(self):
        """åˆå§‹åŒ–æ›¿æ¢å†å²ç®¡ç†å™¨"""
        self.replace_history = {}
        self.history_file = os.path.join(current_dir, "replace_history.txt")
        self.load_from_file()
    
    def add_replace_record(self, search_text: str, replace_text: str):
        """æ·»åŠ æ›¿æ¢è®°å½•"""
        if not search_text:
            return
        
        # æ·»åŠ åˆ°å†å²ä¸­
        self.replace_history[search_text] = replace_text
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        self.save_to_file()
    
    def delete_replace_record(self, search_text: str):
        """åˆ é™¤æ›¿æ¢è®°å½•"""
        if search_text in self.replace_history:
            del self.replace_history[search_text]
            self.save_to_file()
    
    def get_all_history(self) -> Dict[str, str]:
        """è·å–æ‰€æœ‰æ›¿æ¢å†å²"""
        return self.replace_history
    
    def apply_all_replacements(self, text: str) -> str:
        """åº”ç”¨æ‰€æœ‰æ›¿æ¢è§„åˆ™åˆ°ç»™å®šæ–‡æœ¬"""
        if not text or not self.replace_history:
            return text
            
        result = text
        for search_text, replace_text in self.replace_history.items():
            result = result.replace(search_text, replace_text)
            
        return result
    
    def save_to_file(self):
        """ä¿å­˜æ›¿æ¢å†å²åˆ°æ–‡ä»¶"""
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                # ä½¿ç”¨ç®€å•çš„æ ¼å¼ï¼š"åŸæ–‡-æ›¿æ¢æ–‡æœ¬/åŸæ–‡-æ›¿æ¢æ–‡æœ¬"
                replacements = []
                for search_text, replace_text in self.replace_history.items():
                    replacements.append(f"{search_text}-{replace_text}")
                
                f.write("/".join(replacements))
                
            logger.info(f"æˆåŠŸä¿å­˜æ›¿æ¢å†å²åˆ°æ–‡ä»¶: {self.history_file}")
        except Exception as e:
            logger.error(f"ä¿å­˜æ›¿æ¢å†å²åˆ°æ–‡ä»¶å¤±è´¥: {str(e)}")
    
    def load_from_file(self):
        """ä»æ–‡ä»¶åŠ è½½æ›¿æ¢å†å²"""
        if not os.path.exists(self.history_file):
            logger.info(f"æ›¿æ¢å†å²æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶: {self.history_file}")
            return
            
        try:
            with open(self.history_file, 'r', encoding='utf-8') as f:
                content = f.read().strip()
                
                if not content:
                    return
                    
                # è§£ææ–‡ä»¶å†…å®¹
                replacements = content.split('/')
                for replacement in replacements:
                    if '-' in replacement:
                        parts = replacement.split('-', 1)  # ä½¿ç”¨1ç¡®ä¿åªåˆ†å‰²ç¬¬ä¸€ä¸ª'-'
                        if len(parts) == 2:
                            search_text, replace_text = parts
                            self.replace_history[search_text] = replace_text
                
            logger.info(f"æˆåŠŸä»æ–‡ä»¶åŠ è½½æ›¿æ¢å†å²: {self.history_file}")
            logger.info(f"åŠ è½½äº† {len(self.replace_history)} æ¡æ›¿æ¢è§„åˆ™")
        except Exception as e:
            logger.error(f"ä»æ–‡ä»¶åŠ è½½æ›¿æ¢å†å²å¤±è´¥: {str(e)}")

# åˆ›å»ºå…¨å±€æ›¿æ¢å†å²ç®¡ç†å™¨å®ä¾‹
replace_history_manager = ReplaceHistoryManager()

class StyleSheet:
    MAIN_STYLE = """
    QMainWindow {
        background-color: #faf6f1;
    }
    
    QPushButton {
        background-color: #C5D8EC;
        border: 1px solid #d4c5b9;
        border-radius: 6px;
        padding: 6px 12px;
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        font-weight: 500;
    }
    
    QPushButton:hover {
        background-color: #B5C8DC;
        border-color: #c4b5a9;
    }
    
    QPushButton#generate_btn {
        background-color: #C67A8A;
        color: white;
        border: none;
    }
    
    QPushButton#generate_btn:hover {
        background-color: #B56A7A;
    }
    
    QLabel {
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        font-weight: 450;
        letter-spacing: 0.2px;
    }
    
    QComboBox {
        background-color: #faf6f1;
        border: 1px solid #d4c5b9;
        border-radius: 6px;
        padding: 5px 8px;
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        font-weight: 450;
        min-width: 120px;
    }
    
    QComboBox:hover {
        border-color: #c4b5a9;
        background-color: #f7f3ee;
    }

    QComboBox:focus {
        border-color: #C67A8A;
    }
    
    QComboBox::drop-down {
        border: none;
        width: 30px;
    }
    
    QComboBox::down-arrow {
        image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQgNkw4IDEwTDEyIDYiIHN0cm9rZT0iIzRhNTU2OCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+);
        width: 16px;
        height: 16px;
    }

    QComboBox::down-arrow:hover {
        image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQgNkw4IDEwTDEyIDYiIHN0cm9rZT0iI0QwNUE2RSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+);
    }

    QComboBox QAbstractItemView {
        background-color: #faf6f1;
        border: 2px solid #d4c5b9;
        border-radius: 10px;
        padding: 4px;
        selection-background-color: #f7f3ee;
        selection-color: #4a5568;
    }

    QComboBox QAbstractItemView::item {
        background-color: #faf6f1;
        color: #4a5568;
        padding: 8px 12px;
        margin: 2px;
        border-radius: 6px;
        min-height: 20px;
    }

    QComboBox QAbstractItemView::item:hover {
        background-color: #f7f3ee;
    }

    QComboBox QAbstractItemView::item:selected {
        background-color: #f0ece7;
    }

    /* ç§»é™¤æ»šåŠ¨æ¡ */
    QComboBox QScrollBar:vertical {
        width: 0px;
        background: transparent;
    }

    /* ç¡®ä¿ä¸‹æ‹‰æ¡†æ‰“å¼€æ—¶çš„æ ·å¼ */
    QComboBox:on {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        border-color: #C67A8A;
    }

    QComboBox::drop-down:on {
        border: none;
    }

    /* ä¸‹æ‹‰åˆ—è¡¨çš„æ ·å¼ */
    QListView {
        background-color: #faf6f1;
        outline: none;
        border: none;
    }

    QListView::item {
        background-color: #faf6f1;
        color: #4a5568;
    }

    QListView::item:hover {
        background-color: #f7f3ee;
    }

    QListView::item:selected {
        background-color: #f0ece7;
        color: #4a5568;
    }

    QTextEdit {
        background-color: #ffffff;
        border: 1px solid #d4c5b9;
        border-radius: 6px;
        padding: 5px;
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        selection-background-color: #C5D8EC;
        selection-color: #4a5568;
    }

    QTextEdit:focus {
        border-color: #C67A8A;
    }

    /* æ·»åŠ æ»šåŠ¨æ¡æ ·å¼ */
    QTextEdit QScrollBar:vertical {
        border: none;
        background: #f0f0f0;
        width: 10px;
        border-radius: 5px;
    }

    QTextEdit QScrollBar::handle:vertical {
        background: #C67A8A;
        border-radius: 5px;
        min-height: 20px;
    }

    QTextEdit QScrollBar::add-line:vertical,
    QTextEdit QScrollBar::sub-line:vertical {
        height: 0px;
    }

    QTextEdit QScrollBar::add-page:vertical,
    QTextEdit QScrollBar::sub-page:vertical {
        background: none;
    }

    QDoubleSpinBox {
        background-color: #ffffff;
        border: 1px solid #d4c5b9;
        border-radius: 4px;
        padding: 3px 5px;
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        min-width: 80px;
        min-height: 30px;
    }

    QDoubleSpinBox:hover {
        border-color: #c4b5a9;
        background-color: #fafafa;
    }

    QDoubleSpinBox:focus {
        border-color: #C67A8A;
    }

    QDoubleSpinBox::up-button {
        border: none;
        background-color: transparent;
        width: 20px;
        padding-right: 2px;
        image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgOEw2IDRMMTAgOCIgc3Ryb2tlPSIjNGE1NTY4IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=);
    }

    QDoubleSpinBox::down-button {
        border: none;
        background-color: transparent;
        width: 20px;
        padding-right: 2px;
        image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgNEw2IDhMMTAgNCIgc3Ryb2tlPSIjNGE1NTY4IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=);
    }

    QDoubleSpinBox::up-button:hover, QDoubleSpinBox::down-button:hover {
        background-color: #C5D8EC;
        border-radius: 4px;
    }

    QDoubleSpinBox::up-button:pressed, QDoubleSpinBox::down-button:pressed {
        background-color: #B5C8DC;
    }
    
    .card {
        background-color: #ffffff;
        border-radius: 16px;
        padding: 24px;
        border: 1px solid #f0f0f0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    QProgressBar {
        background-color: #ffffff;
        border: 2px solid #d4c5b9;
        border-radius: 10px;
        text-align: center;
        color: #4a5568;
        font-size: 12px;
        min-height: 24px;
        max-height: 24px;
        padding: 0px;
    }

    QProgressBar::chunk {
        background-color: #C67A8A;
        border-radius: 8px;
        margin: 2px;
    }

    QLineEdit {
        background-color: #ffffff;
        border: 1px solid #d4c5b9;
        border-radius: 6px;
        padding: 5px;
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        min-height: 30px;
    }

    QLineEdit:hover {
        border-color: #c4b5a9;
        background-color: #fafafa;
    }

    QLineEdit:focus {
        border-color: #C67A8A;
    }

    QSpinBox {
        background-color: #ffffff;
        border: 1px solid #d4c5b9;
        border-radius: 4px;
        padding: 3px 5px;
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        min-width: 80px;
        min-height: 30px;
    }

    QSpinBox:hover {
        border-color: #c4b5a9;
        background-color: #fafafa;
    }

    QSpinBox:focus {
        border-color: #C67A8A;
    }

    QSpinBox::up-button {
        border: none;
        background-color: transparent;
        width: 20px;
        padding-right: 2px;
        image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgOEw2IDRMMTAgOCIgc3Ryb2tlPSIjNGE1NTY4IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=);
    }

    QSpinBox::down-button {
        border: none;
        background-color: transparent;
        width: 20px;
        padding-right: 2px;
        image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgNEw2IDhMMTAgNCIgc3Ryb2tlPSIjNGE1NTY4IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=);
    }

    QSpinBox::up-button:hover, QSpinBox::down-button:hover {
        background-color: #C5D8EC;
        border-radius: 4px;
    }

    QSpinBox::up-button:pressed, QSpinBox::down-button:pressed {
        background-color: #B5C8DC;
    }

    QGroupBox {
        border: 1px solid #d4c5b9;
        border-radius: 8px;
        margin-top: 0.8em;
        padding: 8px;
        color: #4a5568;
        font-weight: bold;
    }



    QCheckBox {
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        spacing: 4px;
    }

    QCheckBox::indicator {
        width: 14px;
        height: 14px;
        border: 1px solid #d4c5b9;
        border-radius: 3px;
        background-color: #ffffff;
    }

    QCheckBox::indicator:hover {
        border-color: #c4b5a9;
        background-color: #fafafa;
    }

    QCheckBox::indicator:checked {
        background-color: #C67A8A;
        border-color: #C67A8A;
        image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgNkw1IDlMMTAgMyIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+);
    }

    QRadioButton {
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        spacing: 4px;
    }

    QRadioButton::indicator {
        width: 14px;
        height: 14px;
        border: 1px solid #d4c5b9;
        border-radius: 10px;
        background-color: #ffffff;
    }

    QRadioButton::indicator:hover {
        border-color: #c4b5a9;
        background-color: #fafafa;
    }

    QRadioButton::indicator:checked {
        background-color: #C67A8A;
        border-color: #C67A8A;
        width: 10px;
        height: 10px;
        margin: 4px;
    }

    /* ä¿®æ”¹è¿›åº¦æ¡æ ·å¼ */
    QSlider::groove:horizontal {
        border: none;
        height: 4px;
        background: #C5D8EC;  /* æµ…è“è‰²èƒŒæ™¯ */
        margin: 2px 0;
    }

    QSlider::handle:horizontal {
        background: #C67A8A;  /* å¼ºè°ƒè‰²æ‰‹æŸ„ */
        border: none;
        width: 12px;
        height: 12px;
        margin: -4px 0;
        border-radius: 6px;
    }

    QSlider::sub-page:horizontal {
        background: #C67A8A;  /* å¼ºè°ƒè‰²å·²æ’­æ”¾éƒ¨åˆ† */
        border-radius: 2px;
    }

    QSlider::add-page:horizontal {
        background: #C5D8EC;  /* æµ…è“è‰²æœªæ’­æ”¾éƒ¨åˆ† */
        border-radius: 2px;
    }

    QSlider::handle:horizontal:hover {
        background: #B56A7A;  /* æ‰‹æŸ„hoveræ—¶çš„é¢œè‰² */
    }

    /* ğŸ”§ æ·»åŠ QTableWidgetæ ·å¼ï¼Œè§£å†³é»‘è‰²èƒŒæ™¯é—®é¢˜ */
    QTableWidget {
        background-color: transparent;  /* é€æ˜èƒŒæ™¯æ˜¾ç¤ºåº•å±‚ç™½è‰²å¡ç‰‡ */
        alternate-background-color: #faf6f1;
        selection-background-color: #C5D8EC;
        selection-color: #4a5568;
        border: none;  /* ç§»é™¤è¾¹æ¡†è®©èƒŒæ™¯é€æ˜ */
        border-radius: 8px;
        gridline-color: #e5e5e5;
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
    }

    QTableWidget::item {
        background-color: transparent;  /* é€æ˜èƒŒæ™¯ */
        color: #4a5568;
        border: none;
        padding: 8px;
    }

    QTableWidget::item:alternate {
        background-color: #faf6f1;
    }

    QTableWidget::item:selected {
        background-color: #C5D8EC;
        color: #4a5568;
    }

    QTableWidget::item:hover {
        background-color: #f7f3ee;
    }

    /* ğŸ”§ ä¿®å¤é€‰ä¸­è¡Œçš„æ‚¬åœæ•ˆæœ - é€‰ä¸­çŠ¶æ€ä¼˜å…ˆçº§æ›´é«˜ */
    QTableWidget::item:selected:hover {
        background-color: #C5D8EC;  /* é€‰ä¸­è¡Œæ‚¬åœæ—¶ä¿æŒè“è‰² */
        color: #4a5568;
    }

    QTableWidget QAbstractItemView {
        background-color: transparent;  /* è§†å›¾èƒŒæ™¯é€æ˜ */
        selection-background-color: #C5D8EC;
        selection-color: #4a5568;
    }

    QTableWidget QHeaderView::section {
        background-color: transparent;  /* è¡¨å¤´èƒŒæ™¯é€æ˜ */
        color: #4a5568;
        padding: 8px;
        border: none;
        border-bottom: 1px solid #d4c5b9;
        font-weight: 500;
    }

    QTableWidget QHeaderView::section:hover {
        background-color: #f7f3ee;
    }

    /* ğŸ”§ å¤„ç†è¡¨æ ¼å·¦ä¸Šè§’äº¤æ±‡å¤„çš„"é»‘å—"é—®é¢˜ */
    QTableWidget QTableCornerButton::section {
        background-color: transparent;  /* å·¦ä¸Šè§’é€æ˜ */
        border: none;
    }

    /* ğŸ”§ è¡¨æ ¼å•å…ƒæ ¼å®¹å™¨æ ·å¼ - å»æ‰é»‘è‰²è¾¹æ¡† */
    QWidget#cell-widget-container {
        background-color: transparent;
        border: none;
    }

    /* ğŸ”§ ä¼˜åŒ–QComboBoxæ ·å¼ - è®¾ç½®å›ºå®šé«˜åº¦å’Œå±…ä¸­å¯¹é½ */
    QComboBox {
        background-color: #faf6f1 !important;
        border: 1px solid #d4c5b9 !important;
        border-radius: 6px !important;
        padding-left: 8px !important;
        padding-right: 8px !important;  /* å³è¾¹è·ä¿æŒä¸€è‡´ï¼Œå› ä¸ºå·²éšè—ä¸‹æ‹‰æŒ‰é’® */
        padding-top: 4px !important;    /* å¢åŠ é¡¶éƒ¨å†…è¾¹è·æ”¹å–„å‚ç›´å±…ä¸­ */
        padding-bottom: 4px !important; /* å¢åŠ åº•éƒ¨å†…è¾¹è·æ”¹å–„å‚ç›´å±…ä¸­ */
        height: 28px !important;        /* è®¾ç½®å›ºå®šé«˜åº¦ */
        max-height: 28px !important;    /* ç¡®ä¿é«˜åº¦å›ºå®š */
        min-height: 28px !important;    /* ç¡®ä¿æœ€å°é«˜åº¦ */
        color: #4a5568 !important;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif !important;
        font-size: 11px !important;
        text-align: left !important;    /* æ–‡å­—å·¦å¯¹é½ */
        line-height: 20px !important;   /* è®¾ç½®è¡Œé«˜æ”¹å–„æ–‡å­—å‚ç›´å±…ä¸­ */
    }

    /* ğŸ”§ è¡¨æ ¼ä¸­çš„QComboBoxç‰¹å®šæ ·å¼ - ç¡®ä¿ç”Ÿæ•ˆå¹¶ä¼˜åŒ–å¯¹é½ */
    QTableWidget QComboBox, 
    QWidget#cell-widget-container QComboBox {
        background-color: #faf6f1 !important;
        border: 1px solid #d4c5b9 !important;
        border-radius: 6px !important;
        padding-left: 8px !important;
        padding-right: 8px !important;
        padding-top: 4px !important;    /* ä¸å…¨å±€æ ·å¼ä¸€è‡´ */
        padding-bottom: 4px !important; /* ä¸å…¨å±€æ ·å¼ä¸€è‡´ */
        height: 28px !important;
        max-height: 28px !important;
        min-height: 28px !important;
        color: #4a5568 !important;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif !important;
        font-size: 11px !important;
        text-align: left !important;
        line-height: 20px !important;
    }

    QComboBox:hover, 
    QTableWidget QComboBox:hover, 
    QWidget#cell-widget-container QComboBox:hover {
        background-color: #f7f3ee !important;
        border-color: #C67A8A !important;
    }

    QComboBox:focus, 
    QTableWidget QComboBox:focus, 
    QWidget#cell-widget-container QComboBox:focus {
        border-color: #C67A8A !important;
        outline: none !important;
    }

    /* ğŸ”§ å®Œå…¨éšè—ä¸‹æ‹‰æŒ‰é’®åŒºåŸŸ - å»æ‰é»‘è‰²å°é•¿æ–¹å— */
    QComboBox::drop-down, 
    QTableWidget QComboBox::drop-down, 
    QWidget#cell-widget-container QComboBox::drop-down {
        border: none !important;
        background: transparent !important;
        width: 0px !important;  /* è®¾ç½®ä¸º0å®½åº¦å®Œå…¨éšè— */
    }

    QComboBox::down-arrow, 
    QTableWidget QComboBox::down-arrow, 
    QWidget#cell-widget-container QComboBox::down-arrow {
        image: none !important;
        border: none !important;
        background: transparent !important;
        width: 0 !important;
        height: 0 !important;
    }

    /* ğŸ”§ ä¸‹æ‹‰èœå•æ ·å¼ - è§£å†³å˜é»‘é—®é¢˜ */
    QComboBox QAbstractItemView {
        background-color: #faf6f1;  /* ç±³ç™½è‰²èƒŒæ™¯ */
        border: 1px solid #d4c5b9;
        border-radius: 6px;
        selection-background-color: #C5D8EC;  /* æ·¡è“è‰²é€‰ä¸­ */
        selection-color: #4a5568;
        color: #4a5568;
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        font-size: 11px;
        padding: 2px;
    }

    QComboBox QAbstractItemView::item {
        background-color: #faf6f1;  /* ç±³ç™½è‰²èƒŒæ™¯ */
        color: #4a5568;
        padding: 6px 12px;
        border: none;
        min-height: 24px;
    }

    QComboBox QAbstractItemView::item:hover {
        background-color: #f7f3ee;  /* æ‚¬æµ®æ—¶çš„æµ…è‰² */
        color: #4a5568;
    }

    QComboBox QAbstractItemView::item:selected {
        background-color: #C5D8EC;  /* é€‰ä¸­æ—¶çš„æ·¡è“è‰² */
        color: #4a5568;
    }

    /* ğŸ”§ åŒºåŸŸæ ‡é¢˜QGroupBoxçš„titleä½¿ç”¨ç²‰çº¢è‰²å¼ºè°ƒ */
    QGroupBox::title {
        subcontrol-origin: margin;
        subcontrol-position: top left;
        left: 10px;
        padding: 0 5px;
        color: #C67A8A;
        font-weight: 600;
    }
    """

class Card(QFrame):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setObjectName("card")
        self.setStyleSheet("""
            .card { 
                background-color: #ffffff;
                border-radius: 16px;
                padding: 24px;
                border: 1px solid #f0f0f0;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }
        """)
        self.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Preferred)

class PresetSettingCard(Card):
    def __init__(self, preset_manager: PresetManager, preset_order_manager: PresetOrderManager, preset_name: str = None, source_page: str = "main", parent=None):
        super().__init__(parent)
        self.preset_manager = preset_manager
        self.preset_order_manager = preset_order_manager  # æ·»åŠ é¢„è®¾æ’åºç®¡ç†å™¨
        self.preset_name = preset_name
        self.source_page = source_page  # è®°å½•æ¥æºé¡µé¢
        self.init_ui()
        self.preset_saved = False
        self.save_btn.clicked.connect(self.save_preset)
        self.audio_tags = []  # [(audio_path, emotion_tag, text), ...]
        
        # ğŸ”§ ç§»é™¤å›ºå®šé«˜åº¦é™åˆ¶ï¼Œå…è®¸å†…å®¹æ ¹æ®éœ€è¦æ‰©å±•
        # çˆ¶çª—å£ä¼šé€šè¿‡æ»šåŠ¨åŒºåŸŸå¤„ç†å†…å®¹è¿‡é•¿çš„æƒ…å†µ
        
        # åŠ è½½æ‰€æœ‰é¢„è®¾åˆ°åˆ—è¡¨
        self.load_presets_list()
        
        if preset_name:
            self.load_preset(preset_name)
    
    def init_ui(self):
        # ğŸ”§ ä½¿ç”¨å›ºå®šçš„æ§ä»¶å°ºå¯¸å’Œé—´è·
        base_font_size = 12  # å›ºå®šå­—ä½“å¤§å°
        control_height = 32  # å›ºå®šæ§ä»¶é«˜åº¦
        spacing = 10  # å›ºå®šé—´è·
        
        layout = QVBoxLayout(self)
        layout.setSpacing(spacing)
        layout.setContentsMargins(15, 15, 15, 15)  # å›ºå®šè¾¹è·
        
        # è¿”å›æŒ‰é’®
        nav_layout = QHBoxLayout()
        back_btn = QPushButton("è¿”å›")
        back_btn.clicked.connect(self.go_back)
        back_btn.setFixedHeight(control_height)
        back_btn.setFixedWidth(80)  # å›ºå®šæŒ‰é’®å®½åº¦
        back_btn.setStyleSheet(f"font-size: {base_font_size}px;")
        nav_layout.addWidget(back_btn)
        nav_layout.addStretch()
        
        # æ·»åŠ ç°æœ‰é¢„è®¾ç®¡ç†åŒºåŸŸ
        presets_group = QGroupBox("ç°æœ‰é¢„è®¾")
        presets_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {base_font_size + 1}px;
                font-weight: 500;
                padding-top: 15px;
                margin-top: 10px;
            }}
        """)
        presets_layout = QVBoxLayout(presets_group)
        presets_layout.setSpacing(spacing)
        
        # é¢„è®¾åˆ—è¡¨å’Œæ“ä½œæŒ‰é’®
        presets_list_layout = QHBoxLayout()
        presets_list_layout.setSpacing(spacing)
        
        self.presets_list = QComboBox()
        self.presets_list.setFixedHeight(control_height)
        self.presets_list.setMinimumWidth(300)  # è®¾ç½®æœ€å°å®½åº¦ä»¥å®Œæ•´æ˜¾ç¤ºé¢„è®¾å
        self.presets_list.setStyleSheet(f"font-size: {base_font_size}px;")
        # è¿æ¥é¢„è®¾é€‰æ‹©å˜åŒ–äº‹ä»¶
        self.presets_list.currentTextChanged.connect(self.on_preset_selection_changed)
        
        edit_preset_btn = QPushButton("ç¼–è¾‘")
        edit_preset_btn.setFixedHeight(control_height)
        edit_preset_btn.setFixedWidth(60)
        edit_preset_btn.setStyleSheet(f"font-size: {base_font_size}px;")
        edit_preset_btn.clicked.connect(self.edit_selected_preset)
        
        delete_preset_btn = QPushButton("åˆ é™¤")
        delete_preset_btn.setFixedHeight(control_height)
        delete_preset_btn.setFixedWidth(60)
        delete_preset_btn.setStyleSheet(f"font-size: {base_font_size}px;")
        delete_preset_btn.clicked.connect(self.delete_selected_preset)
        
        presets_list_layout.addWidget(self.presets_list)
        presets_list_layout.addWidget(edit_preset_btn)
        presets_list_layout.addWidget(delete_preset_btn)
        presets_list_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        
        # æ·»åŠ ç”·ä¸»/å¥³ä¸»é€‰æ‹©åŒºåŸŸ
        role_layout = QHBoxLayout()
        role_layout.setSpacing(spacing)
        
        role_label = QLabel("è§’è‰²æ ‡è®°:")
        role_label.setFixedWidth(80)
        role_label.setStyleSheet(f"font-size: {base_font_size}px;")
        
        self.male_lead_check = QCheckBox("ç”·ä¸»")
        self.male_lead_check.setStyleSheet(f"font-size: {base_font_size}px;")
        self.male_lead_check.clicked.connect(self.on_male_lead_changed)
        
        self.female_lead_check = QCheckBox("å¥³ä¸»")
        self.female_lead_check.setStyleSheet(f"font-size: {base_font_size}px;")
        self.female_lead_check.clicked.connect(self.on_female_lead_changed)
        
        role_note = QLabel("(ä¸‹æ¬¡å¯åŠ¨æ—¶ç”Ÿæ•ˆï¼Œç”·ä¸»æ’å‰ï¼Œå¥³ä¸»æ’å)")
        role_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.8)}px;")
        
        role_layout.addWidget(role_label)
        role_layout.addWidget(self.male_lead_check)
        role_layout.addWidget(self.female_lead_check)
        role_layout.addWidget(role_note)
        role_layout.addStretch()
        
        presets_layout.addLayout(presets_list_layout)
        presets_layout.addLayout(role_layout)
        
        # åŸºæœ¬ä¿¡æ¯
        basic_group = QGroupBox("åŸºæœ¬ä¿¡æ¯")
        basic_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {base_font_size + 1}px;
                font-weight: 500;
                padding-top: 15px;
                margin-top: 10px;
            }}
        """)
        basic_info = QVBoxLayout(basic_group)
        basic_info.setSpacing(spacing)
        
        # é¢„è®¾åç§°
        name_layout = QHBoxLayout()
        name_layout.setSpacing(spacing)
        
        name_label = QLabel("é¢„è®¾åç§°")
        name_label.setFixedWidth(80)  # å›ºå®šæ ‡ç­¾å®½åº¦ä»¥å¯¹é½
        name_label.setStyleSheet(f"font-size: {base_font_size}px;")
        
        self.name_input = QLineEdit()
        self.name_input.setPlaceholderText("è¾“å…¥é¢„è®¾åç§°...")
        self.name_input.setStyleSheet(f"font-size: {base_font_size}px;")
        self.name_input.setFixedHeight(control_height)
        self.name_input.setMinimumWidth(250)  # è®¾ç½®æœ€å°å®½åº¦
        
        name_layout.addWidget(name_label)
        name_layout.addWidget(self.name_input)
        name_layout.addStretch()  # æ·»åŠ å¼¹æ€§ç©ºé—´
        
        # GPTæ¨¡å‹è·¯å¾„
        ckpt_layout = QHBoxLayout()
        ckpt_layout.setSpacing(spacing)
        
        ckpt_label = QLabel("GPTæ¨¡å‹")
        ckpt_label.setFixedWidth(80)  # å›ºå®šæ ‡ç­¾å®½åº¦å¯¹é½
        ckpt_label.setStyleSheet(f"font-size: {base_font_size}px;")
        
        self.ckpt_input = QLineEdit()
        self.ckpt_input.setPlaceholderText("é€‰æ‹©GPTæ¨¡å‹è·¯å¾„...")
        self.ckpt_input.setStyleSheet(f"font-size: {base_font_size}px;")
        self.ckpt_input.setFixedHeight(control_height)
        self.ckpt_input.setMinimumWidth(200)
        
        self.ckpt_btn = QPushButton("é€‰æ‹©")
        self.ckpt_btn.setStyleSheet(f"font-size: {base_font_size}px;")
        self.ckpt_btn.setFixedHeight(control_height)
        self.ckpt_btn.setFixedWidth(60)
        self.ckpt_btn.clicked.connect(lambda: self.select_model_path(self.ckpt_input, "ckpt"))
        
        ckpt_layout.addWidget(ckpt_label)
        ckpt_layout.addWidget(self.ckpt_input)
        ckpt_layout.addWidget(self.ckpt_btn)
        ckpt_layout.addStretch()
        
        # SoVITSæ¨¡å‹è·¯å¾„
        pth_layout = QHBoxLayout()
        pth_layout.setSpacing(spacing)
        
        pth_label = QLabel("SoVITSæ¨¡å‹")
        pth_label.setFixedWidth(80)  # å›ºå®šæ ‡ç­¾å®½åº¦å¯¹é½
        pth_label.setStyleSheet(f"font-size: {base_font_size}px;")
        
        self.pth_input = QLineEdit()
        self.pth_input.setPlaceholderText("é€‰æ‹©SoVITSæ¨¡å‹è·¯å¾„...")
        self.pth_input.setStyleSheet(f"font-size: {base_font_size}px;")
        self.pth_input.setFixedHeight(control_height)
        self.pth_input.setMinimumWidth(200)
        
        self.pth_btn = QPushButton("é€‰æ‹©")
        self.pth_btn.setStyleSheet(f"font-size: {base_font_size}px;")
        self.pth_btn.setFixedHeight(control_height)
        self.pth_btn.setFixedWidth(60)
        self.pth_btn.clicked.connect(lambda: self.select_model_path(self.pth_input, "pth"))
        
        pth_layout.addWidget(pth_label)
        pth_layout.addWidget(self.pth_input)
        pth_layout.addWidget(self.pth_btn)
        pth_layout.addStretch()
        
        # å‚è€ƒéŸ³é¢‘åŒºåŸŸ
        audio_layout = QVBoxLayout()
        
        # éŸ³é¢‘é€‰æ‹©å’Œæƒ…ç»ªæ ‡ç­¾è¡Œ
        audio_header = QHBoxLayout()
        audio_header.setSpacing(spacing)
        
        audio_label = QLabel("å‚è€ƒéŸ³é¢‘")
        audio_label.setFixedWidth(80)
        audio_label.setStyleSheet(f"font-size: {base_font_size}px;")
        
        self.add_audio_btn = QPushButton("ğŸµ")
        self.add_audio_btn.setFixedWidth(35)
        self.add_audio_btn.setFixedHeight(control_height)
        self.add_audio_btn.clicked.connect(self.add_audio_file)
        
        self.emotion_input = QLineEdit()
        self.emotion_input.setPlaceholderText("æƒ…ç»ªæ ‡ç­¾")
        self.emotion_input.setFixedWidth(120)
        self.emotion_input.setFixedHeight(control_height)
        self.emotion_input.setStyleSheet(f"font-size: {base_font_size}px;")
        
        audio_header.addWidget(audio_label)
        audio_header.addWidget(self.add_audio_btn)
        audio_header.addWidget(self.emotion_input)
        audio_header.addStretch()
        
        # éŸ³é¢‘æ–‡æœ¬è¾“å…¥è¡Œ
        audio_text_layout = QHBoxLayout()
        audio_text_layout.setSpacing(spacing)
        
        audio_text_label = QLabel("éŸ³é¢‘æ–‡æœ¬")
        audio_text_label.setFixedWidth(80)
        audio_text_label.setStyleSheet(f"font-size: {base_font_size}px;")
        
        self.audio_text_input = QLineEdit()
        self.audio_text_input.setPlaceholderText("è¾“å…¥å‚è€ƒéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬å†…å®¹")
        self.audio_text_input.setFixedHeight(control_height)
        self.audio_text_input.setMinimumWidth(200)
        self.audio_text_input.setStyleSheet(f"font-size: {base_font_size}px;")
        self.audio_text_input.returnPressed.connect(self.add_audio_tag)
        
        add_tag_btn = QPushButton("æ·»åŠ ")
        add_tag_btn.setFixedHeight(control_height)
        add_tag_btn.setFixedWidth(60)
        add_tag_btn.setStyleSheet(f"font-size: {base_font_size}px;")
        add_tag_btn.clicked.connect(self.add_audio_tag)
        
        audio_text_layout.addWidget(audio_text_label)
        audio_text_layout.addWidget(self.audio_text_input)
        audio_text_layout.addWidget(add_tag_btn)
        audio_text_layout.addStretch()
        
        # éŸ³é¢‘åˆ—è¡¨è¡Œ
        audio_list_layout = QHBoxLayout()
        audio_list_layout.setSpacing(spacing)
        
        list_label = QLabel("éŸ³é¢‘åˆ—è¡¨")
        list_label.setFixedWidth(80)
        list_label.setStyleSheet(f"font-size: {base_font_size}px;")
        
        self.audio_list = QComboBox()
        self.audio_list.setPlaceholderText("å·²æ·»åŠ çš„å‚è€ƒéŸ³é¢‘...")
        self.audio_list.setMinimumWidth(200)
        self.audio_list.setFixedHeight(control_height)
        self.audio_list.setStyleSheet(f"font-size: {base_font_size}px;")
        
        delete_btn = QPushButton("åˆ é™¤")
        delete_btn.setStyleSheet(f"font-size: {base_font_size}px;")
        delete_btn.setFixedHeight(control_height)
        delete_btn.setFixedWidth(60)
        delete_btn.clicked.connect(self.delete_selected_audio)
        
        audio_list_layout.addWidget(list_label)
        audio_list_layout.addWidget(self.audio_list)
        audio_list_layout.addWidget(delete_btn)
        audio_list_layout.addStretch()
        
        audio_layout.addLayout(audio_header)
        audio_layout.addLayout(audio_text_layout)
        audio_layout.addLayout(audio_list_layout)
        
        # æ·»åŠ æ‰€æœ‰åŸºæœ¬ä¿¡æ¯ç»„ä»¶
        basic_info.addLayout(name_layout)
        basic_info.addLayout(ckpt_layout)
        basic_info.addLayout(pth_layout)
        basic_info.addLayout(audio_layout)
        
        # èŠ‚å¥è®¾ç½®
        rhythm_group = QGroupBox("èŠ‚å¥è®¾ç½®")
        rhythm_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {base_font_size + 1}px;
                font-weight: 500;
                padding-top: 15px;
                margin-top: 10px;
            }}
        """)
        rhythm_layout = QGridLayout()
        rhythm_layout.setSpacing(spacing)
        rhythm_layout.setContentsMargins(15, 15, 15, 15)
        
        # è¯­é€Ÿè®¾ç½®
        speed_factor_label = QLabel("è¯­é€Ÿ")
        speed_factor_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.speed_factor_spin = QDoubleSpinBox()
        self.speed_factor_spin.setRange(0.5, 2.0)
        self.speed_factor_spin.setSingleStep(0.1)
        self.speed_factor_spin.setValue(1.0)
        self.speed_factor_spin.setMinimumHeight(control_height)
        self.speed_factor_spin.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        speed_factor_note = QLabel("è°ƒèŠ‚è¯­éŸ³ç”Ÿæˆçš„é€Ÿåº¦ï¼Œ1.0ä¸ºæ­£å¸¸è¯­é€Ÿ")
        speed_factor_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        rhythm_layout.addWidget(speed_factor_label, 0, 0)
        rhythm_layout.addWidget(self.speed_factor_spin, 0, 1)
        rhythm_layout.addWidget(speed_factor_note, 0, 2)
        
        # æ–‡æœ¬åˆ‡åˆ†è®¾ç½®
        split_label = QLabel("æ–‡æœ¬åˆ‡åˆ†")
        split_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.split_combo = QComboBox()
        self.split_combo.setMaximumWidth(200)
        self.split_combo.setMinimumHeight(control_height)
        self.split_combo.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        split_options = [
            "cut0ï¼ˆä¸åˆ‡åˆ†ï¼Œé€‚åˆçŸ­å¥ï¼‰",
            "cut1ï¼ˆæ¯4å¥ä¸€åˆ‡ï¼Œé€‚åˆå¯¹è¯ï¼‰",
            "cut2ï¼ˆæ¯50å­—ä¸€åˆ‡ï¼Œé€‚åˆé•¿å¥ï¼‰",
            "cut3ï¼ˆæŒ‰ä¸­æ–‡å¥å·ã€‚åˆ‡åˆ†ï¼Œé€‚åˆæ­£å¸¸æœ—è¯»ï¼‰",
            "cut4ï¼ˆæŒ‰è‹±æ–‡å¥å·.åˆ‡åˆ†ï¼Œé€‚åˆè‹±æ–‡ï¼‰",
            "cut5ï¼ˆæŒ‰æ ‡ç‚¹ç¬¦å·åˆ‡åˆ†ï¼Œæ¨èï¼‰"
        ]
        self.split_combo.addItems(split_options)
        self.split_combo.setCurrentIndex(1)  # ğŸ”§ é»˜è®¤é€‰æ‹© cut1ï¼ˆæ¯4å¥ä¸€åˆ‡ï¼Œé€‚åˆå¯¹è¯ï¼‰
        split_note = QLabel("é€‰æ‹©åˆé€‚çš„åˆ‡åˆ†æ–¹å¼å¯ä»¥è®©æœ—è¯»æ›´è‡ªç„¶ï¼Œæ˜¾å­˜ä¸å¤Ÿæ—¶è¯·é€‰æ‹©æ›´å°çš„åˆ‡åˆ†é•¿åº¦")
        split_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        rhythm_layout.addWidget(split_label, 1, 0)
        rhythm_layout.addWidget(self.split_combo, 1, 1)
        rhythm_layout.addWidget(split_note, 1, 2)
        
        # æ®µé—´éš”è®¾ç½®
        interval_label = QLabel("åˆ†æ®µé—´éš”")
        interval_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.interval_spin = QDoubleSpinBox()
        self.interval_spin.setRange(0.01, 1.0)
        self.interval_spin.setSingleStep(0.01)
        self.interval_spin.setValue(0.3)
        self.interval_spin.setMaximumWidth(80)
        self.interval_spin.setMinimumHeight(control_height)
        self.interval_spin.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        interval_note = QLabel("åˆ†æ®µåˆæˆæ—¶çš„é—´éš”æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œæ¨è0.3ç§’ï¼Œæœ€å°0.01ç§’")
        interval_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        rhythm_layout.addWidget(interval_label, 2, 0)
        rhythm_layout.addWidget(self.interval_spin, 2, 1)
        rhythm_layout.addWidget(interval_note, 2, 2)
        
        rhythm_group.setLayout(rhythm_layout)
        
        # æ¨ç†è®¾ç½®
        infer_group = QGroupBox("æ¨ç†è®¾ç½®")
        infer_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(self.window().height() * 0.02)}px;
                margin-top: {int(self.window().height() * 0.014)}px;
            }}
        """)
        infer_layout = QGridLayout()
        infer_layout.setSpacing(int(self.window().width() * 0.015))
        infer_layout.setVerticalSpacing(int(self.window().height() * 0.02))
        
        # æ¸©åº¦å‚æ•°
        temp_label = QLabel("æ¸©åº¦")
        temp_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.temp_spin = QDoubleSpinBox()
        self.temp_spin.setRange(0.1, 2.0)
        self.temp_spin.setValue(0.6)  # ğŸ”§ æ›´æ–°é»˜è®¤å€¼ä¸º0.6
        self.temp_spin.setSingleStep(0.1)
        self.temp_spin.setDecimals(1)
        self.temp_spin.setMinimumHeight(control_height)
        
        # Top-Kå‚æ•°
        topk_label = QLabel("Top-K")
        topk_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.topk_spin = QSpinBox()
        self.topk_spin.setRange(1, 100)
        self.topk_spin.setValue(15)  # v4ç‰ˆæœ¬æ¨èå€¼
        self.topk_spin.setSingleStep(1)
        self.topk_spin.setMinimumHeight(control_height)
        
        # Top-På‚æ•°
        topp_label = QLabel("Top-P")
        topp_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.topp_spin = QDoubleSpinBox()
        self.topp_spin.setRange(0.1, 1.0)
        self.topp_spin.setValue(1.0)  # v4ç‰ˆæœ¬æ¨èå€¼
        self.topp_spin.setSingleStep(0.1)
        self.topp_spin.setDecimals(1)
        self.topp_spin.setMinimumHeight(control_height)
        
        # é‡å¤æƒ©ç½šå‚æ•°
        penalty_label = QLabel("é‡å¤æƒ©ç½š")
        penalty_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.penalty_spin = QDoubleSpinBox()
        self.penalty_spin.setRange(1.0, 3.0)
        self.penalty_spin.setValue(1.35)  # v4ç‰ˆæœ¬æ¨èå€¼
        self.penalty_spin.setSingleStep(0.01)
        self.penalty_spin.setDecimals(2)
        self.penalty_spin.setMinimumHeight(control_height)
        
        # æ–‡æœ¬è¯­è¨€è®¾ç½®
        lang_label = QLabel("æ–‡æœ¬è¯­è¨€")
        lang_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.lang_combo = QComboBox()
        self.lang_combo.addItems(["all_zh", "zh", "en", "ja", "auto"])
        self.lang_combo.setCurrentText("all_zh")  # é»˜è®¤ä¸ºall_zh
        self.lang_combo.setMinimumHeight(control_height)
        
        # æ‰¹å¤„ç†è®¾ç½®
        batch_label = QLabel("æ‰¹å¤„ç†")
        batch_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        batch_layout = QHBoxLayout()
        
        self.batch_size_spin = QSpinBox()
        self.batch_size_spin.setRange(1, 5)
        self.batch_size_spin.setValue(1)  # é»˜è®¤ä¸º1
        self.batch_size_spin.setMinimumHeight(control_height)
        
        self.parallel_infer_check = QCheckBox("å¹¶è¡Œæ¨ç†")
        self.parallel_infer_check.setChecked(True)  # ğŸ”§ æ›´æ–°é»˜è®¤å€¼ä¸ºTrue
        
        self.split_bucket_check = QCheckBox("åˆ†æ¡¶å¤„ç†")
        self.split_bucket_check.setChecked(False)  # é»˜è®¤ç¦ç”¨
        
        batch_layout.addWidget(self.batch_size_spin)
        batch_layout.addWidget(self.parallel_infer_check)
        batch_layout.addWidget(self.split_bucket_check)
        
        # v4ç‰ˆæœ¬ç‰¹æœ‰å‚æ•°
        # é‡‡æ ·æ­¥æ•°è®¾ç½®
        sample_steps_label = QLabel("é‡‡æ ·æ­¥æ•°")
        sample_steps_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.sample_steps_spin = QSpinBox()
        self.sample_steps_spin.setRange(4, 128)
        self.sample_steps_spin.setValue(8)  # v4é»˜è®¤å€¼è°ƒæ•´ä¸º8
        self.sample_steps_spin.setSingleStep(4)
        self.sample_steps_spin.setMinimumHeight(control_height)
        sample_steps_note = QLabel("æ§åˆ¶é‡‡æ ·è´¨é‡å’Œé€Ÿåº¦ï¼Œå€¼è¶Šå¤§è´¨é‡è¶Šå¥½ä½†é€Ÿåº¦è¶Šæ…¢")
        sample_steps_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        
        # éŸ³é¢‘è¶…åˆ†è¾¨ç‡è®¾ç½®
        if_sr_label = QLabel("éŸ³é¢‘è¶…åˆ†è¾¨ç‡")
        if_sr_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.if_sr_check = QCheckBox("å¯ç”¨è¶…åˆ†è¾¨ç‡")
        self.if_sr_check.setChecked(True)  # ğŸ”§ æ›´æ–°é»˜è®¤å€¼ä¸ºTrue
        self.if_sr_check.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        if_sr_note = QLabel("æé«˜éŸ³é¢‘è´¨é‡ï¼Œä½†ä¼šå¢åŠ è®¡ç®—æ—¶é—´")
        if_sr_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        
        # è¾…åŠ©å‚è€ƒéŸ³é¢‘è®¾ç½®ï¼ˆv4ç‰¹æœ‰ï¼‰
        aux_ref_label = QLabel("è¾…åŠ©å‚è€ƒéŸ³é¢‘")
        aux_ref_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.aux_ref_check = QCheckBox("å¯ç”¨å¤šéŸ³è‰²èåˆ")
        self.aux_ref_check.setChecked(False)  # é»˜è®¤å…³é—­
        self.aux_ref_check.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        aux_ref_note = QLabel("å¯ä»¥æ·»åŠ å¤šä¸ªè¾…åŠ©å‚è€ƒéŸ³é¢‘è¿›è¡ŒéŸ³è‰²èåˆï¼ˆå»ºè®®åŒæ€§åˆ«ï¼‰")
        aux_ref_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        
        # æ·»åŠ åˆ°å¸ƒå±€
        infer_layout.addWidget(temp_label, 0, 0)
        infer_layout.addWidget(self.temp_spin, 0, 1)
        infer_layout.addWidget(topk_label, 0, 2)
        infer_layout.addWidget(self.topk_spin, 0, 3)
        infer_layout.addWidget(topp_label, 1, 0)
        infer_layout.addWidget(self.topp_spin, 1, 1)
        infer_layout.addWidget(penalty_label, 1, 2)
        infer_layout.addWidget(self.penalty_spin, 1, 3)
        infer_layout.addWidget(lang_label, 2, 0)
        infer_layout.addWidget(self.lang_combo, 2, 1)
        infer_layout.addWidget(batch_label, 2, 2)
        infer_layout.addLayout(batch_layout, 2, 3)
        
        # v4ç‰¹æœ‰å‚æ•°
        infer_layout.addWidget(sample_steps_label, 3, 0)
        infer_layout.addWidget(self.sample_steps_spin, 3, 1)
        infer_layout.addWidget(sample_steps_note, 3, 2, 1, 2)
        infer_layout.addWidget(if_sr_label, 4, 0)
        infer_layout.addWidget(self.if_sr_check, 4, 1)
        infer_layout.addWidget(if_sr_note, 4, 2, 1, 2)
        infer_layout.addWidget(aux_ref_label, 5, 0)
        infer_layout.addWidget(self.aux_ref_check, 5, 1)
        infer_layout.addWidget(aux_ref_note, 5, 2, 1, 2)
        
        infer_group.setLayout(infer_layout)
        
        # æŒ‰é’®åŒºåŸŸ
        button_layout = QHBoxLayout()
        button_layout.setSpacing(10)
        
        # æ¢å¤é»˜è®¤å€¼æŒ‰é’®
        self.reset_defaults_btn = QPushButton("æ¢å¤é»˜è®¤å€¼")
        self.reset_defaults_btn.setFixedHeight(40)
        self.reset_defaults_btn.setFixedWidth(120)
        self.reset_defaults_btn.setStyleSheet(f"font-size: {base_font_size}px; background-color: #f0f0f0; color: #333;")
        self.reset_defaults_btn.clicked.connect(self.reset_to_defaults)
        
        # ä¿å­˜æŒ‰é’®
        self.save_btn = QPushButton("ä¿å­˜é¢„è®¾")
        self.save_btn.setObjectName("generate_btn")
        self.save_btn.setFixedHeight(40)  # å›ºå®šä¿å­˜æŒ‰é’®é«˜åº¦
        self.save_btn.setFixedWidth(120)  # å›ºå®šä¿å­˜æŒ‰é’®å®½åº¦
        self.save_btn.setStyleSheet(f"font-size: {base_font_size}px;")
        
        button_layout.addWidget(self.reset_defaults_btn)
        button_layout.addWidget(self.save_btn)
        
        # æ·»åŠ æ‰€æœ‰ç»„ä»¶åˆ°ä¸»å¸ƒå±€
        layout.addLayout(nav_layout)
        layout.addWidget(presets_group)
        layout.addWidget(basic_group)
        layout.addWidget(rhythm_group)
        layout.addWidget(infer_group)
        layout.addLayout(button_layout)
    
    # ğŸ”§ ç§»é™¤resizeäº‹ä»¶å¤„ç†ï¼Œå› ä¸ºç°åœ¨ä½¿ç”¨å›ºå®šæ§ä»¶å¤§å°
    pass
    
    def select_model_path(self, input_widget: QLineEdit, model_type: str):
        """é€‰æ‹©æ¨¡å‹æ–‡ä»¶"""
        file_filter = "GPTæ¨¡å‹ (*.ckpt)" if model_type == "ckpt" else "SoVITSæ¨¡å‹ (*.pth)"
        file_name, _ = QFileDialog.getOpenFileName(
            self,
            f"é€‰æ‹©{model_type}æ¨¡å‹æ–‡ä»¶",
            "",
            file_filter
        )
        if file_name:
            input_widget.setText(file_name)
    
    def add_audio_file(self):
        """é€‰æ‹©éŸ³é¢‘æ–‡ä»¶"""
        file_name, _ = QFileDialog.getOpenFileName(
            self,
            "é€‰æ‹©éŸ³é¢‘æ–‡ä»¶",
            "",
            "éŸ³é¢‘æ–‡ä»¶ (*.wav *.mp3)"
        )
        if file_name:
            self.current_audio = file_name
            self.add_audio_btn.setText("âœ“")
            self.add_audio_btn.setStyleSheet("color: #C67A8A;")
            self.add_audio_btn.setToolTip(file_name)
            # å¼•å¯¼ç”¨æˆ·å¡«å†™åç»­ä¿¡æ¯
            self.emotion_input.setFocus()
            # åœ¨çŠ¶æ€æ æç¤ºç”¨æˆ·å¡«å†™å®Œæ•´ä¿¡æ¯
            QMessageBox.information(self, "æç¤º", "è¯·å¡«å†™æƒ…ç»ªæ ‡ç­¾å’ŒéŸ³é¢‘æ–‡æœ¬å†…å®¹ï¼Œç„¶åç‚¹å‡»'æ·»åŠ 'æŒ‰é’®")
            
            # å°è¯•è‡ªåŠ¨å¡«å……éŸ³é¢‘æ–‡æœ¬æ¡†
            try:
                # ä»éŸ³é¢‘æ–‡ä»¶åä¸­æå–æ–‡æœ¬ä½œä¸ºå‚è€ƒ
                base_name = os.path.splitext(os.path.basename(file_name))[0]
                # å¦‚æœæ–‡æœ¬æ¡†ä¸ºç©ºï¼Œæ‰å¡«å……å‚è€ƒæ–‡æœ¬
                if not self.audio_text_input.text():
                    self.audio_text_input.setText(base_name)
                    self.audio_text_input.selectAll()  # é€‰ä¸­æ–‡æœ¬ä»¥ä¾¿ç”¨æˆ·ç›´æ¥æ›¿æ¢
            except:
                pass
    
    def add_audio_tag(self):
        """æ·»åŠ éŸ³é¢‘å’Œæƒ…ç»ªæ ‡ç­¾å¯¹"""
        tag = self.emotion_input.text().strip()
        text = self.audio_text_input.text().strip()
        
        if hasattr(self, 'current_audio') and tag and text:
            # ä½¿ç”¨ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„æ–‡æœ¬å†…å®¹
            display_name = f"{os.path.basename(self.current_audio)} - {tag} - {text}"
            self.audio_tags.append((self.current_audio, tag, text))
            self.audio_list.addItem(display_name)
            
            # æ·»åŠ è°ƒè¯•è¾“å‡º
            
            # æ¸…ç©ºè¾“å…¥æ¡†
            self.emotion_input.clear()
            self.audio_text_input.clear()
            self.add_audio_btn.setText("ğŸµ")
            self.add_audio_btn.setStyleSheet("")
            delattr(self, 'current_audio')
        else:
            # æç¤ºç”¨æˆ·å¡«å†™å®Œæ•´ä¿¡æ¯
            if not hasattr(self, 'current_audio'):
                QMessageBox.warning(self, "æç¤º", "è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶")
            elif not tag:
                QMessageBox.warning(self, "æç¤º", "è¯·è¾“å…¥æƒ…ç»ª/åœºæ™¯æ ‡ç­¾")
            elif not text:
                QMessageBox.warning(self, "æç¤º", "è¯·è¾“å…¥éŸ³é¢‘æ–‡æœ¬å†…å®¹")
    
    def delete_selected_audio(self):
        """åˆ é™¤é€‰ä¸­çš„éŸ³é¢‘"""
        current_index = self.audio_list.currentIndex()
        if current_index >= 0:
            self.audio_list.removeItem(current_index)
            self.audio_tags.pop(current_index)
    
    def load_preset(self, preset_name: str):
        """åŠ è½½é¢„è®¾æ•°æ®"""
        preset_info = self.preset_manager.get_preset(preset_name)
        if not preset_info:
            return
            
        settings, audio_files = preset_info
        
        
        # å¡«å……åŸºæœ¬ä¿¡æ¯
        self.name_input.setText(preset_name)
        # ä¼˜å…ˆä½¿ç”¨model_pathï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨gpt_path
        gpt_path = settings.get('model_path', '') or settings.get('gpt_path', '')
        self.ckpt_input.setText(gpt_path)
        self.pth_input.setText(settings.get('sovits_path', ''))
        
        # æ¸…ç©ºç°æœ‰éŸ³é¢‘åˆ—è¡¨
        self.audio_list.clear()
        self.audio_tags.clear()
        
        # å¡«å……éŸ³é¢‘åˆ—è¡¨
     
        for path, emotion, text in audio_files:
            
            
            display_name = f"{os.path.basename(path)} - {emotion} - {text}"
            self.audio_tags.append((path, emotion, text))
            self.audio_list.addItem(display_name)
        
        # å¡«å……èŠ‚å¥è®¾ç½® - ğŸ”§ æ›´æ–°æ–‡æœ¬åˆ‡åˆ†é»˜è®¤å€¼
        split_method = settings.get('text_split_method', 'cut1')  # æ›´æ–°é»˜è®¤å€¼ä¸ºcut1
        index = self.split_combo.findText(split_method, Qt.MatchFlag.MatchStartsWith)
        if index >= 0:
            self.split_combo.setCurrentIndex(index)
        self.interval_spin.setValue(settings.get('fragment_interval', 0.3))
        self.speed_factor_spin.setValue(settings.get('speed_factor', 1.0))  # åŠ è½½è¯­é€Ÿè®¾ç½®
        
        # å¡«å……æ¨ç†è®¾ç½® - ğŸ”§ æ›´æ–°é»˜è®¤å€¼
        self.temp_spin.setValue(settings.get('temperature', 0.6))  # æ›´æ–°é»˜è®¤å€¼ä¸º0.6
        self.topk_spin.setValue(settings.get('top_k', 15))  # æ›´æ–°é»˜è®¤å€¼ä¸º15
        self.topp_spin.setValue(settings.get('top_p', 1.0))
        self.penalty_spin.setValue(settings.get('repetition_penalty', 1.35))  # æ›´æ–°é»˜è®¤å€¼ä¸º1.35
        
        # æ‰¹å¤„ç†è®¾ç½® - ğŸ”§ æ›´æ–°é»˜è®¤å€¼
        self.batch_size_spin.setValue(settings.get('batch_size', 1))
        self.parallel_infer_check.setChecked(settings.get('parallel_infer', True))  # æ›´æ–°é»˜è®¤å€¼ä¸ºTrue
        self.split_bucket_check.setChecked(settings.get('split_bucket', False))
        
        # v4ç‰ˆæœ¬ç‰¹æœ‰å‚æ•° - ğŸ”§ æ›´æ–°é»˜è®¤å€¼
        self.sample_steps_spin.setValue(settings.get('sample_steps', 8))  # æ›´æ–°é»˜è®¤å€¼ä¸º8
        self.if_sr_check.setChecked(settings.get('if_sr', True))  # æ›´æ–°é»˜è®¤å€¼ä¸ºTrue
        self.aux_ref_check.setChecked(settings.get('aux_ref_enabled', False))
        
        # è®¾ç½®è¯­è¨€é€‰é¡¹
        text_lang = settings.get('text_lang', 'all_zh')
        index = self.lang_combo.findText(text_lang)
        if index >= 0:
            self.lang_combo.setCurrentIndex(index)
        

    
    def save_preset(self):
        """ä¿å­˜é¢„è®¾"""
        name = self.name_input.text().strip()
        if not name:
            QMessageBox.warning(self, "æç¤º", "è¯·è¾“å…¥é¢„è®¾åç§°")
            return
            
        if not self.audio_tags:
            QMessageBox.warning(self, "æç¤º", "è¯·æ·»åŠ è‡³å°‘ä¸€ä¸ªå‚è€ƒéŸ³é¢‘")
            return
        
        # è·å–ç¬¬ä¸€ä¸ªéŸ³é¢‘çš„è·¯å¾„ã€æƒ…ç»ªå’Œæ–‡æœ¬
        first_audio_path, first_emotion, first_text = self.audio_tags[0]
        
        # æ·»åŠ è°ƒè¯•è¾“å‡º
        
        settings = {
            'model_path': self.ckpt_input.text().strip(),
            'gpt_path': self.ckpt_input.text().strip(),  # ç¡®ä¿ä¸gpt_sovits.pyå…¼å®¹
            'sovits_path': self.pth_input.text().strip(),
            'ref_audio': first_audio_path,  # å‚è€ƒéŸ³é¢‘è·¯å¾„ï¼ˆå­—ç¬¦ä¸²ï¼‰
            'ref_audio_list': [path for path, _, _ in self.audio_tags],  # å‚è€ƒéŸ³é¢‘è·¯å¾„åˆ—è¡¨
            'text_split_method': self.split_combo.currentText().split('ï¼ˆ')[0],  # æ–‡æœ¬åˆ‡åˆ†æ–¹æ³•
            'fragment_interval': self.interval_spin.value(),  # åˆ†æ®µé—´éš”
            'temperature': self.temp_spin.value(),  # æ¸©åº¦å‚æ•°
            'top_k': int(self.topk_spin.value()),  # Top-Kå‚æ•°
            'top_p': self.topp_spin.value(),  # Top-På‚æ•°
            'repetition_penalty': self.penalty_spin.value(),  # é‡å¤æƒ©ç½šå‚æ•°
            'speed_factor': self.speed_factor_spin.value(),  # è¯­é€Ÿå‚æ•°
            
            # æ·»åŠ å‚è€ƒéŸ³é¢‘çš„æ–‡æœ¬å’Œæƒ…ç»ªä¿¡æ¯ - å®Œå…¨ä¸ä¿®æ”¹ï¼Œä¿ç•™åŸå§‹æ–‡æœ¬
            'ref_text': first_text,  # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„éŸ³é¢‘æ–‡æœ¬ï¼ŒåŸæ ·ä¿å­˜
            'ref_emotion': first_emotion,  # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æƒ…ç»ªæ ‡ç­¾
            'ref_language': self.lang_combo.currentText(),  # å‚è€ƒè¯­è¨€
            
            # æ·»åŠ æ›´å¤šé«˜çº§å‚æ•°ï¼Œä»ç•Œé¢å…ƒç´ è¯»å–
            'batch_size': self.batch_size_spin.value(),
            'batch_threshold': 0.75,  # å›ºå®šå€¼
            'parallel_infer': self.parallel_infer_check.isChecked(),
            'pitch': 1.0,  # å›ºå®šå€¼
            'role': '',
            'seed': -1,  # å›ºå®šå€¼
            'split_bucket': self.split_bucket_check.isChecked(),
            'text_lang': self.lang_combo.currentText(),
            'text_language': self.lang_combo.currentText(),  # ç¡®ä¿ä¸gpt_sovits.pyå…¼å®¹
            
            # v4ç‰ˆæœ¬ç‰¹æœ‰å‚æ•°
            'sample_steps': self.sample_steps_spin.value(),  # é‡‡æ ·æ­¥æ•°
            'if_sr': self.if_sr_check.isChecked(),  # éŸ³é¢‘è¶…åˆ†è¾¨ç‡
            'aux_ref_enabled': self.aux_ref_check.isChecked(),  # å¯ç”¨è¾…åŠ©å‚è€ƒéŸ³é¢‘
        }
        
        # æ‰“å°settingså­—å…¸ä¸­çš„å…³é”®å‚æ•°
        
        # å¦‚æœæœ‰å¤šä¸ªéŸ³é¢‘ï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜æ¯ä¸ªéŸ³é¢‘çš„ä¿¡æ¯
        if len(self.audio_tags) > 1:
            settings['all_audio_info'] = [
                {'path': path, 'emotion': emotion, 'text': text} 
                for path, emotion, text in self.audio_tags
            ]
        
        # è½¬æ¢éŸ³é¢‘æ ‡ç­¾æ ¼å¼
        audio_files = [(path, emotion, text) for path, emotion, text in self.audio_tags]
        
        if self.preset_manager.add_preset(name, settings, audio_files):
            self.preset_saved = True
            QMessageBox.information(self, "æˆåŠŸ", f"é¢„è®¾ä¿å­˜æˆåŠŸ\nå‚è€ƒéŸ³é¢‘æ–‡æœ¬: {first_text}\nå‚è€ƒéŸ³é¢‘æƒ…ç»ª: {first_emotion}")
            
            # é€šçŸ¥MainWindowæ›´æ–°é¢„è®¾åˆ—è¡¨
            parent = self.window()
            if isinstance(parent, MainWindow):
                parent.load_presets()
                
                # æ ¹æ®æ¥æºé¡µé¢è¿”å›å¹¶æ›´æ–°é…ç½®
                if self.source_page == "first_segment":
                    # è·å–å½“å‰çš„ FirstSegmentCard
                    for i in range(parent.stack.count()):
                        widget = parent.stack.widget(i)
                        if isinstance(widget, QWidget) and widget.findChild(FirstSegmentCard):
                            first_segment_card = widget.findChild(FirstSegmentCard)
                            if first_segment_card:
                                # æ›´æ–°é¢„è®¾é€‰æ‹©å¹¶åŠ è½½é…ç½®
                                first_segment_card.preset_combo.setCurrentText(name)
                                first_segment_card.current_preset_settings = settings
                            break
                    parent.stack.setCurrentWidget(widget)
                else:
                    parent.show_main_page()
        else:
            QMessageBox.warning(self, "é”™è¯¯", "é¢„è®¾ä¿å­˜å¤±è´¥")
    
    def go_back(self):
        """è¿”å›ä¸Šä¸€é¡µé¢"""
        if not self.preset_saved:
            reply = QMessageBox.question(
                self, 
                "æç¤º", 
                "é¢„è®¾å°šæœªä¿å­˜ï¼Œç¡®å®šè¦è¿”å›å—ï¼Ÿ",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                QMessageBox.StandardButton.No
            )
            if reply == QMessageBox.StandardButton.No:
                return
                
        parent = self.window()
        if isinstance(parent, MainWindow):
            if self.source_page == "first_segment":
                # è·å–å½“å‰çš„ FirstSegmentCard
                for i in range(parent.stack.count()):
                    widget = parent.stack.widget(i)
                    if isinstance(widget, QWidget) and widget.findChild(FirstSegmentCard):
                        parent.stack.setCurrentWidget(widget)
                        break
            elif self.source_page == "segment":
                # è¿”å›æ®µè½å¤„ç†é¡µé¢
                parent.show_main_page()  # è¿™å°†é€šè¿‡source_page="segment"é€»è¾‘è¿”å›åˆ°æ®µè½å¤„ç†é¡µé¢
            else:
                parent.show_main_page()

    def load_presets_list(self):
        """åŠ è½½æ‰€æœ‰é¢„è®¾åˆ°åˆ—è¡¨"""
        self.presets_list.clear()
        all_presets = [preset[0] for preset in self.preset_manager.get_all_presets()]
        
        # ğŸ”§ ä½¿ç”¨é¢„è®¾æ’åºç®¡ç†å™¨è¿›è¡Œæ’åº
        sorted_presets = self.preset_order_manager.sort_presets(all_presets)
        self.presets_list.addItems(sorted_presets)
        
        # æ¸…ç†å·²åˆ é™¤çš„é¢„è®¾
        self.preset_order_manager.cleanup_deleted_presets(all_presets)
    
    def on_preset_selection_changed(self, preset_name: str):
        """å½“é¢„è®¾é€‰æ‹©æ”¹å˜æ—¶æ›´æ–°ç”·ä¸»/å¥³ä¸»å‹¾é€‰çŠ¶æ€"""
        if not preset_name:
            return
            
        # æ›´æ–°å‹¾é€‰æ¡†çŠ¶æ€ï¼Œä½†ä¸è§¦å‘ä¿¡å·
        self.male_lead_check.blockSignals(True)
        self.female_lead_check.blockSignals(True)
        
        self.male_lead_check.setChecked(self.preset_order_manager.is_male_lead(preset_name))
        self.female_lead_check.setChecked(self.preset_order_manager.is_female_lead(preset_name))
        
        self.male_lead_check.blockSignals(False)
        self.female_lead_check.blockSignals(False)
    
    def on_male_lead_changed(self, checked: bool):
        """å¤„ç†ç”·ä¸»å‹¾é€‰çŠ¶æ€æ”¹å˜"""
        preset_name = self.presets_list.currentText()
        if not preset_name:
            return
            
        if checked:
            self.preset_order_manager.set_male_lead(preset_name)
            # å–æ¶ˆå¥³ä¸»å‹¾é€‰ï¼ˆäº’æ–¥ï¼‰
            self.female_lead_check.blockSignals(True)
            self.female_lead_check.setChecked(False)
            self.female_lead_check.blockSignals(False)
        else:
            self.preset_order_manager.remove_lead_status(preset_name)
    
    def on_female_lead_changed(self, checked: bool):
        """å¤„ç†å¥³ä¸»å‹¾é€‰çŠ¶æ€æ”¹å˜"""
        preset_name = self.presets_list.currentText()
        if not preset_name:
            return
            
        if checked:
            self.preset_order_manager.set_female_lead(preset_name)
            # å–æ¶ˆç”·ä¸»å‹¾é€‰ï¼ˆäº’æ–¥ï¼‰
            self.male_lead_check.blockSignals(True)
            self.male_lead_check.setChecked(False)
            self.male_lead_check.blockSignals(False)
        else:
            self.preset_order_manager.remove_lead_status(preset_name)
    
    def edit_selected_preset(self):
        """ç¼–è¾‘é€‰ä¸­çš„é¢„è®¾"""
        preset_name = self.presets_list.currentText()
        if not preset_name:
            QMessageBox.warning(self, "æç¤º", "è¯·é€‰æ‹©è¦ç¼–è¾‘çš„é¢„è®¾")
            return
        
        # æ¸…é™¤å½“å‰è¡¨å•
        self.name_input.clear()
        self.ckpt_input.clear()
        self.pth_input.clear()
        self.audio_list.clear()
        self.audio_tags.clear()
        
        # åŠ è½½é€‰ä¸­çš„é¢„è®¾
        self.load_preset(preset_name)
    
    def delete_selected_preset(self):
        """åˆ é™¤é€‰ä¸­çš„é¢„è®¾"""
        preset_name = self.presets_list.currentText()
        if not preset_name:
            QMessageBox.warning(self, "æç¤º", "è¯·é€‰æ‹©è¦åˆ é™¤çš„é¢„è®¾")
            return
        
        reply = QMessageBox.question(
            self, 
            "ç¡®è®¤åˆ é™¤", 
            f"ç¡®å®šè¦åˆ é™¤é¢„è®¾ '{preset_name}' å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
            QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            if self.preset_manager.delete_preset(preset_name):
                QMessageBox.information(self, "æˆåŠŸ", f"é¢„è®¾ '{preset_name}' å·²åˆ é™¤")
                # é‡æ–°åŠ è½½é¢„è®¾åˆ—è¡¨
                self.load_presets_list()
                
                # æ¸…é™¤è¡¨å•
                self.name_input.clear()
                self.ckpt_input.clear()
                self.pth_input.clear()
                self.audio_list.clear()
                self.audio_tags.clear()
                
                # é€šçŸ¥MainWindowæ›´æ–°é¢„è®¾åˆ—è¡¨
                parent = self.window()
                if isinstance(parent, MainWindow):
                    parent.load_presets()
            else:
                QMessageBox.warning(self, "é”™è¯¯", f"åˆ é™¤é¢„è®¾ '{preset_name}' å¤±è´¥")
    
    def reset_to_defaults(self):
        """æ¢å¤æ‰€æœ‰å‚æ•°ä¸ºé»˜è®¤å€¼"""
        # ğŸ“‹ é»˜è®¤å‚æ•°é…ç½®
        # æ–‡æœ¬åˆ‡åˆ†=cut1ï¼Œåˆ†æ®µé—´éš”=0.3ï¼Œæ¸©åº¦=0.6ï¼ŒTop-K=15ï¼ŒTop-P=1.0ï¼Œ
        # é‡å¤æƒ©ç½š=1.35ï¼Œå¹¶è¡Œå¤„ç†=Trueï¼Œé‡‡æ ·=8ï¼ŒéŸ³é¢‘è¶…åˆ†è¾¨ç‡=True
        
        # ğŸ”§ ç›´æ¥åº”ç”¨é»˜è®¤å€¼ï¼Œæ— éœ€ç¡®è®¤å¯¹è¯æ¡†
        # æ¢å¤æ‰€æœ‰å‚æ•°ä¸ºé»˜è®¤å€¼
        self.split_combo.setCurrentIndex(1)  # cut1
        self.interval_spin.setValue(0.3)  # åˆ†æ®µé—´éš”
        self.temp_spin.setValue(0.6)  # æ¸©åº¦
        self.topk_spin.setValue(15)  # Top-K
        self.topp_spin.setValue(1.0)  # Top-P
        self.penalty_spin.setValue(1.35)  # é‡å¤æƒ©ç½š
        self.parallel_infer_check.setChecked(True)  # å¹¶è¡Œå¤„ç†
        self.sample_steps_spin.setValue(8)  # é‡‡æ ·æ­¥æ•°
        self.if_sr_check.setChecked(True)  # éŸ³é¢‘è¶…åˆ†è¾¨ç‡
        
        # å…¶ä»–å‚æ•°ä¹Ÿæ¢å¤ä¸ºåˆç†é»˜è®¤å€¼
        self.speed_factor_spin.setValue(1.0)  # è¯­é€Ÿ
        self.lang_combo.setCurrentText("all_zh")  # æ–‡æœ¬è¯­è¨€
        self.batch_size_spin.setValue(1)  # æ‰¹å¤„ç†å¤§å°
        self.split_bucket_check.setChecked(False)  # åˆ†æ¡¶å¤„ç†
        self.aux_ref_check.setChecked(False)  # è¾…åŠ©å‚è€ƒéŸ³é¢‘
        
        # ğŸ”§ å®Œå…¨é™é»˜æ‰§è¡Œï¼Œæ— ä»»ä½•æç¤º

class FirstSegmentCard(Card):
    def __init__(self, segments: List[str], preset_manager: PresetManager, preset_order_manager: PresetOrderManager = None, parent=None):
        super().__init__(parent)
        self.segments = segments
        self.preset_manager = preset_manager
        self.preset_order_manager = preset_order_manager
        self.current_segment_index = 0
        self.is_generating_preview = False
        self.preview_generated = False
        self.gpt_sovits = GPTSoVITS()
        self.player = QMediaPlayer()
        self.audio_output = QAudioOutput()
        self.player.setAudioOutput(self.audio_output)
        self.current_preset_settings = None  # æ·»åŠ å½“å‰é¢„è®¾è®¾ç½®çš„å­˜å‚¨
        self.processed_segments = self.segments.copy()  # å­˜å‚¨å¤„ç†åçš„æ–‡æœ¬
        
        # è®¾ç½®åˆå§‹éŸ³é‡å¹¶ç›‘å¬éŸ³é¢‘è®¾å¤‡å˜åŒ–
        self.current_volume = 70
        self.audio_output.setVolume(self.current_volume / 100.0)
        
        # åˆ›å»ºéŸ³é¢‘è®¾å¤‡å˜åŒ–çš„å®šæ—¶æ£€æµ‹å™¨
        self.volume_check_timer = QTimer(self)
        self.volume_check_timer.timeout.connect(self.check_system_volume)
        self.volume_check_timer.start(1000)  # æ¯ç§’æ£€æŸ¥ä¸€æ¬¡ç³»ç»ŸéŸ³é‡å˜åŒ–
        
        # æ·»åŠ æœç´¢ç›¸å…³å˜é‡
        self.search_mode = False
        self.search_results = []
        self.search_index = 0
        self.last_search_query = ""
        
        self.init_ui()
        
        # è¿æ¥æ’­æ”¾å™¨ä¿¡å·
        self.player.positionChanged.connect(self.update_position)
        self.player.durationChanged.connect(self.update_duration)
        self.preview_progress.sliderMoved.connect(self.set_position)
    
    def init_ui(self):
        layout = QVBoxLayout(self)
        layout.setSpacing(20)
        
        # é¡¶éƒ¨å¯¼èˆª
        nav_layout = QHBoxLayout()
        back_btn = QPushButton("è¿”å›")
        back_btn.clicked.connect(self.go_back)
        nav_layout.addWidget(back_btn)
        
        # æ·»åŠ æœç´¢åŠŸèƒ½
        search_layout = QHBoxLayout()
        self.search_edit = QLineEdit()
        self.search_edit.setPlaceholderText("æœç´¢æ–‡æœ¬å†…å®¹")
        self.search_edit.textChanged.connect(self.on_search_text_changed)
        self.search_btn = QPushButton("æœç´¢")
        self.search_btn.clicked.connect(self.search_text)
        self.confirm_search_btn = QPushButton("é€€å‡ºæœç´¢")
        self.confirm_search_btn.clicked.connect(self.confirm_search)
        self.confirm_search_btn.setEnabled(False)
        
        search_layout.addWidget(self.search_edit)
        search_layout.addWidget(self.search_btn)
        search_layout.addWidget(self.confirm_search_btn)
        
        nav_layout.addLayout(search_layout)
        
        # æ·»åŠ é¡µç æ˜¾ç¤º
        self.page_label = QLabel(f"å½“å‰ç¬¬ {self.current_segment_index + 1}/{len(self.segments)} æ®µ")
        nav_layout.addWidget(self.page_label, alignment=Qt.AlignmentFlag.AlignCenter)
        
        # æ·»åŠ ç¿»é¡µæŒ‰é’®
        nav_btn_layout = QHBoxLayout()
        self.prev_btn = QPushButton("ä¸Šä¸€æ®µ")
        self.prev_btn.clicked.connect(self.prev_segment)
        self.prev_btn.setEnabled(False)  # åˆå§‹æ—¶ä¸èƒ½å¾€å‰ç¿»
        
        self.next_btn = QPushButton("ä¸‹ä¸€æ®µ")
        self.next_btn.clicked.connect(self.next_segment)
        self.next_btn.setEnabled(len(self.segments) > 1)  # æœ‰å¤šæ®µæ—¶æ‰èƒ½å‘åç¿»
        
        nav_btn_layout.addWidget(self.prev_btn)
        nav_btn_layout.addWidget(self.next_btn)
        nav_layout.addLayout(nav_btn_layout)
        
        # é¢„è®¾é€‰æ‹©åŒºåŸŸ
        preset_group = QGroupBox("é¢„è®¾é€‰æ‹©")
        preset_layout = QHBoxLayout(preset_group)
        
        self.preset_combo = QComboBox()
        self.preset_combo.currentIndexChanged.connect(self.on_preset_changed)
        self.load_presets()  # åŠ è½½æ‰€æœ‰é¢„è®¾
        
        self.new_preset_btn = QPushButton("æ–°å»ºé¢„è®¾")
        self.new_preset_btn.clicked.connect(self.create_new_preset)
        
        self.edit_preset_btn = QPushButton("è°ƒæ•´é¢„è®¾")
        self.edit_preset_btn.clicked.connect(self.edit_current_preset)
        
        preset_layout.addWidget(self.preset_combo)
        preset_layout.addWidget(self.new_preset_btn)
        preset_layout.addWidget(self.edit_preset_btn)
        
        # æ–‡æœ¬ç¼–è¾‘åŒºåŸŸ
        text_group = QGroupBox("å½“å‰æ–‡æœ¬")
        text_layout = QVBoxLayout(text_group)
        self.text_edit = QTextEdit()
        self.text_edit.setReadOnly(False)  # å…è®¸ç¼–è¾‘
        self.text_edit.setMinimumHeight(150)
        text_layout.addWidget(self.text_edit)
        
        # æ–‡æœ¬æ“ä½œæŒ‰é’®åŒºåŸŸ
        text_btn_layout = QHBoxLayout()
        
        # ä¿å­˜æŒ‰é’®
        self.save_btn = QPushButton("ä¿å­˜")
        self.save_btn.clicked.connect(self.save_text)
        text_btn_layout.addWidget(self.save_btn)
        
        # å¤åˆ¶æŒ‰é’®
        self.copy_btn = QPushButton("å¤åˆ¶")
        self.copy_btn.clicked.connect(self.copy_text)
        text_btn_layout.addWidget(self.copy_btn)
        
        # æ›¿æ¢åŒºåŸŸ
        self.find_edit = QLineEdit()
        self.find_edit.setPlaceholderText("æŸ¥æ‰¾æ–‡æœ¬")
        self.replace_edit = QLineEdit()
        self.replace_edit.setPlaceholderText("æ›¿æ¢ä¸º")
        self.replace_btn = QPushButton("æ›¿æ¢")
        self.replace_btn.clicked.connect(self.replace_text)
        
        text_btn_layout.addWidget(self.find_edit)
        text_btn_layout.addWidget(self.replace_edit)
        text_btn_layout.addWidget(self.replace_btn)
        
        text_layout.addLayout(text_btn_layout)
        
        # è¯•å¬åŒºåŸŸ
        preview_group = QGroupBox("è¯•å¬")
        preview_layout = QVBoxLayout(preview_group)
        
        # è¯•å¬æŒ‰é’®å’ŒçŠ¶æ€
        preview_btn_layout = QHBoxLayout()
        self.preview_btn = QPushButton("ç”Ÿæˆè¯•å¬")
        self.preview_btn.clicked.connect(self.generate_preview)
        self.preview_status = QLabel("ğŸ”„ æœªç”Ÿæˆ")  # é»˜è®¤çŠ¶æ€
        preview_btn_layout.addWidget(self.preview_btn)
        preview_btn_layout.addWidget(self.preview_status)
        preview_btn_layout.addStretch()
        
        # è¯•å¬æ§åˆ¶
        preview_control_layout = QHBoxLayout()
        self.play_btn = QPushButton("â–¶ï¸")
        self.play_btn.setEnabled(False)
        self.play_btn.clicked.connect(self.play_preview)
        self.preview_progress = QSlider(Qt.Orientation.Horizontal)
        self.preview_progress.setEnabled(False)
        self.preview_progress.sliderMoved.connect(self.set_position)
        
        # æ·»åŠ éŸ³é‡æ§åˆ¶
        volume_layout = QHBoxLayout()
        volume_icon = QLabel("ğŸ”Š")
        self.volume_slider = QSlider(Qt.Orientation.Horizontal)
        self.volume_slider.setRange(0, 100)
        self.volume_slider.setValue(70)  # é»˜è®¤éŸ³é‡70%
        self.volume_slider.valueChanged.connect(self.set_volume)
        volume_layout.addWidget(volume_icon)
        volume_layout.addWidget(self.volume_slider)
        
        preview_control_layout.addWidget(self.play_btn)
        preview_control_layout.addWidget(self.preview_progress)
        
        preview_layout.addLayout(preview_btn_layout)
        preview_layout.addLayout(preview_control_layout)
        preview_layout.addLayout(volume_layout)  # æ·»åŠ éŸ³é‡æ§åˆ¶
        
        # ç”Ÿæˆå…¨ä¹¦æŒ‰é’®
        self.generate_all_btn = QPushButton("ç”Ÿæˆå…¨ä¹¦")
        self.generate_all_btn.setObjectName("generate_btn")
        self.generate_all_btn.clicked.connect(self.generate_all)
        
        # æ·»åŠ æ‰€æœ‰ç»„ä»¶åˆ°ä¸»å¸ƒå±€
        layout.addLayout(nav_layout)
        layout.addWidget(preset_group)
        layout.addWidget(text_group)
        layout.addWidget(preview_group)
        layout.addWidget(self.generate_all_btn, alignment=Qt.AlignmentFlag.AlignCenter)
        
        # æ˜¾ç¤ºç¬¬ä¸€æ®µæ–‡æœ¬
        self.update_text_display()
    
    def load_presets(self):
        """åŠ è½½æ‰€æœ‰é¢„è®¾"""
        self.preset_combo.clear()
        presets = self.preset_manager.get_all_presets()
        preset_names = [name for name, _, _ in presets]
        
        # ğŸ”§ ä½¿ç”¨é¢„è®¾æ’åºç®¡ç†å™¨è¿›è¡Œæ’åº
        if self.preset_order_manager:
            sorted_names = self.preset_order_manager.sort_presets(preset_names)
            for name in sorted_names:
                self.preset_combo.addItem(name)
        else:
            # åå¤‡æ–¹æ¡ˆï¼šæŒ‰åŸæ¥çš„æ–¹å¼æ·»åŠ 
            for name in preset_names:
                self.preset_combo.addItem(name)
                
        self.preset_combo.addItem("æ–°å»ºé¢„è®¾...")
    
    def set_volume(self, volume):
        """è®¾ç½®éŸ³é‡å¤§å°"""
        # è·å–ç³»ç»ŸéŸ³é‡è®¾ç½®ï¼Œç¡®ä¿ä¸ç³»ç»ŸéŸ³é‡åŒæ­¥
        system_volume = QMediaDevices.defaultAudioOutput().volume() * 100
        # ä½¿ç”¨æ»‘å—è®¾ç½®çš„éŸ³é‡æˆ–ç³»ç»ŸéŸ³é‡ï¼ˆå½“æ»‘å—è¢«ç”¨æˆ·ç§»åŠ¨æ—¶ï¼‰
        if volume != self.current_volume:  # ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´äº†æ»‘å—
            # å°†æ»‘å—çš„0-100å€¼è½¬æ¢ä¸ºQMediaPlayerçš„0.0-1.0éŸ³é‡å€¼
            volume_value = volume / 100.0
            self.audio_output.setVolume(volume_value)
            # ä¿å­˜éŸ³é‡è®¾ç½®ï¼Œä»¥ä¾¿åœ¨åˆ‡æ¢æ®µè½æˆ–é‡æ–°è¯•å¬æ—¶ä¿æŒä¸€è‡´
            self.current_volume = volume
        else:  # ç³»ç»ŸéŸ³é‡æ”¹å˜
            # æ›´æ–°æ»‘å—æ˜¾ç¤º
            self.volume_slider.setValue(int(system_volume))
            # æ›´æ–°éŸ³é¢‘è¾“å‡ºéŸ³é‡
            self.audio_output.setVolume(system_volume / 100.0)
            # ä¿å­˜å½“å‰éŸ³é‡è®¾ç½®
            self.current_volume = int(system_volume)
    
    def on_preset_changed(self, index):
        """é¢„è®¾é€‰æ‹©æ”¹å˜æ—¶çš„å¤„ç†"""
        preset_name = self.preset_combo.currentText()
        if preset_name == "æ–°å»ºé¢„è®¾...":
            self.create_new_preset()
            return
            
        # åŠ è½½é¢„è®¾æ•°æ®
        preset_info = self.preset_manager.get_preset(preset_name)
        if preset_info:
            settings, audio_files = preset_info
            # ç¡®ä¿è®¾ç½®åŒ…å«gpt_sovits.pyæ‰€éœ€çš„æ‰€æœ‰å¿…è¦å­—æ®µ
            if 'gpt_path' not in settings and 'model_path' in settings:
                settings['gpt_path'] = settings['model_path']
            if 'ref_language' not in settings:
                settings['ref_language'] = settings.get('text_lang', 'all_zh')
            self.current_preset_settings = settings  # ä¿å­˜å½“å‰é¢„è®¾è®¾ç½®
    
    def create_new_preset(self):
        """åˆ›å»ºæ–°é¢„è®¾"""
        parent = self.window()
        if isinstance(parent, MainWindow):
            parent.show_preset_setting(source_page="first_segment")
    
    def edit_current_preset(self):
        """ç¼–è¾‘å½“å‰é¢„è®¾"""
        preset_name = self.preset_combo.currentText()
        if preset_name and preset_name != "æ–°å»ºé¢„è®¾...":
            parent = self.window()
            if isinstance(parent, MainWindow):
                parent.show_preset_setting(preset_name, source_page="first_segment")
    
    def go_back(self):
        """è¿”å›ä¸»é¡µé¢"""
        parent = self.window()
        if isinstance(parent, MainWindow):
            parent.show_main_page()
    
    def update_text_display(self):
        """æ›´æ–°æ–‡æœ¬æ˜¾ç¤º"""
        self.text_edit.setText(self.processed_segments[self.current_segment_index])
        
        # æ›´æ–°é¡µç æ˜¾ç¤º
        if self.search_mode:
            current_search_index = self.search_results.index(self.current_segment_index) + 1
            self.page_label.setText(f"æœç´¢ç»“æœ: {current_search_index}/{len(self.search_results)} (ç¬¬ {self.current_segment_index + 1}/{len(self.segments)} æ®µ)")
        else:
            self.page_label.setText(f"å½“å‰ç¬¬ {self.current_segment_index + 1}/{len(self.segments)} æ®µ")
        
        # æ›´æ–°ç¿»é¡µæŒ‰é’®çŠ¶æ€
        if self.search_mode:
            current_result_index = self.search_results.index(self.current_segment_index)
            self.prev_btn.setEnabled(current_result_index > 0)
            self.next_btn.setEnabled(current_result_index < len(self.search_results) - 1)
        else:
            self.prev_btn.setEnabled(self.current_segment_index > 0)
            self.next_btn.setEnabled(self.current_segment_index < len(self.segments) - 1)
        
        # å¦‚æœåœ¨æœç´¢æ¨¡å¼ä¸‹ï¼Œé«˜äº®æœç´¢æ–‡æœ¬
        if self.search_mode:
            self.highlight_search_text()
    
    def prev_segment(self):
        """æ˜¾ç¤ºä¸Šä¸€æ®µ"""
        if self.current_segment_index > 0:
            # ä¿å­˜å½“å‰é…ç½®çŠ¶æ€
            current_preset_selections = self._save_current_preset_selections()
            global_narration_preset = getattr(self, 'global_narration_preset', None)
            global_narration_emotion = getattr(self, 'global_narration_emotion', None)
            
            # æ›´æ–°æ®µè½ç´¢å¼•
            self.current_segment_index -= 1
            
            # æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œç¡®ä¿æ­£ç¡®é‡æ–°åŠ è½½
            for i in reversed(range(self.content_layout.count())):
                widget = self.content_layout.itemAt(i).widget()
                if widget:
                    widget.deleteLater()
            
            # ä½¿ç”¨process_current_segmenté‡æ–°åˆ†æå¹¶åŠ è½½æ®µè½
            self.process_current_segment()
            
            # æ¢å¤å…¨å±€é¢„è®¾å’Œæ—ç™½é…ç½®
            self._restore_global_narration_preset(global_narration_preset, global_narration_emotion)
            
            # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            self.update_nav_buttons()
    
    def next_segment(self):
        """æ˜¾ç¤ºä¸‹ä¸€æ®µ"""
        if self.current_segment_index < len(self.segments) - 1:
            # ä¿å­˜å½“å‰é…ç½®çŠ¶æ€
            current_preset_selections = self._save_current_preset_selections()
            global_narration_preset = getattr(self, 'global_narration_preset', None)
            global_narration_emotion = getattr(self, 'global_narration_emotion', None)
            
            # æ›´æ–°æ®µè½ç´¢å¼•
            self.current_segment_index += 1
            
            # æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œç¡®ä¿æ­£ç¡®é‡æ–°åŠ è½½
            for i in reversed(range(self.content_layout.count())):
                widget = self.content_layout.itemAt(i).widget()
                if widget:
                    widget.deleteLater()
            
            # ä½¿ç”¨process_current_segmenté‡æ–°åˆ†æå¹¶åŠ è½½æ®µè½
            self.process_current_segment()
            
            # æ¢å¤å…¨å±€é¢„è®¾å’Œæ—ç™½é…ç½®
            self._restore_global_narration_preset(global_narration_preset, global_narration_emotion)
            
            # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            self.update_nav_buttons()
    
    def _save_current_preset_selections(self):
        """ä¿å­˜å½“å‰æ–‡æœ¬æ¡†çš„é¢„è®¾é€‰æ‹©çŠ¶æ€"""
        preset_selections = {}
        
        # éå†å†…å®¹å¸ƒå±€ä¸­çš„æ‰€æœ‰æ§ä»¶
        for i in range(self.content_layout.count()):
            widget = self.content_layout.itemAt(i).widget()
            # è·³è¿‡å…¨å±€æ›¿æ¢æ¡†
            if i == 0 and isinstance(widget, QFrame) and "å…¨å±€æ–‡æœ¬æ›¿æ¢" in widget.findChildren(QLabel)[0].text():
                continue
                
            if isinstance(widget, QFrame):
                # æ‰¾åˆ°æ–‡æœ¬æ¡†å’Œæ§åˆ¶é¢æ¿
                text_edit = None
                voice_combo = None
                emotion_combo = None
                
                # æŸ¥æ‰¾æ–‡æœ¬æ¡†
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    # æŸ¥æ‰¾æ–‡æœ¬æ¡†å®¹å™¨
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        for k in range(item.layout().count()):
                            sub_item = item.layout().itemAt(k).widget()
                            if isinstance(sub_item, QTextEdit):
                                text_edit = sub_item
                                break
                
                # æŸ¥æ‰¾æ§åˆ¶é¢æ¿
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        control_layout = item.layout()
                        # æŸ¥æ‰¾é¢„è®¾å’Œæƒ…ç»ªä¸‹æ‹‰æ¡†
                        found_combos = []
                        for k in range(control_layout.count()):
                            control_item = control_layout.itemAt(k).widget()
                            if isinstance(control_item, QComboBox):
                                found_combos.append(control_item)
                                
                        if len(found_combos) >= 2:
                            voice_combo = found_combos[0]
                            emotion_combo = found_combos[1]
                
                # å¦‚æœæ‰¾åˆ°äº†æ‰€æœ‰éœ€è¦çš„æ§ä»¶ï¼Œä¿å­˜é¢„è®¾é€‰æ‹©çŠ¶æ€
                if text_edit and voice_combo and emotion_combo:
                    text_edit_id = text_edit.objectName()
                    preset_selections[text_edit_id] = {
                        'preset': voice_combo.currentText(),
                        'emotion': emotion_combo.currentText(),
                        'text': text_edit.toPlainText(),
                        'is_narration': 'faf6f1' in widget.styleSheet(),
                        'has_speaker': any(isinstance(w, QLabel) and "è¯´è¯è€…" in w.text() 
                                         for w in widget.findChildren(QLabel))
                    }
        
        return preset_selections
    
    def _restore_global_narration_preset(self, global_narration_preset, global_narration_emotion):
        """æ¢å¤å…¨å±€æ—ç™½é¢„è®¾é€‰æ‹©"""
        if global_narration_preset and global_narration_emotion:
            self.global_narration_preset = global_narration_preset
            self.global_narration_emotion = global_narration_emotion
            
            # æ¢å¤æ—ç™½ä¸‹æ‹‰æ¡†çš„é€‰æ‹©
            replace_frame = self.content_layout.itemAt(0).widget()
            if replace_frame:
                # æŸ¥æ‰¾æ—ç™½é¢„è®¾ä¸‹æ‹‰æ¡†
                narration_combos = []
                for child in replace_frame.findChildren(QComboBox):
                    narration_combos.append(child)
                
                if len(narration_combos) >= 2:
                    narration_preset_combo = narration_combos[0]
                    narration_emotion_combo = narration_combos[1]
                    
                    # æ¢å¤é€‰æ‹©
                    preset_index = narration_preset_combo.findText(global_narration_preset)
                    if preset_index >= 0:
                        narration_preset_combo.setCurrentIndex(preset_index)
                        
                        # åŠ è½½æƒ…ç»ªé€‰é¡¹
                        emotions = self.preset_manager.get_preset_emotions(global_narration_preset)
                        narration_emotion_combo.clear()
                        narration_emotion_combo.addItems(emotions)
                        
                        # è®¾ç½®æƒ…ç»ª
                        emotion_index = narration_emotion_combo.findText(global_narration_emotion)
                        if emotion_index >= 0:
                            narration_emotion_combo.setCurrentIndex(emotion_index)
    
    def save_text(self):
        """ä¿å­˜å½“å‰ç¼–è¾‘çš„æ–‡æœ¬"""
        current_text = self.text_edit.toPlainText()
        self.processed_segments[self.current_segment_index] = current_text
        QMessageBox.information(self, "æç¤º", "æ–‡æœ¬å·²ä¿å­˜")
    
    def copy_text(self):
        """å¤åˆ¶å½“å‰æ®µè½æ–‡æœ¬åˆ°å‰ªè´´æ¿"""
        current_text = self.text_edit.toPlainText()
        clipboard = QApplication.clipboard()
        clipboard.setText(current_text)
        QMessageBox.information(self, "æç¤º", "æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
    
    def replace_text(self):
        """åœ¨æ‰€æœ‰æ–‡æœ¬ä¸­æ‰§è¡Œæ›¿æ¢æ“ä½œ"""
        find_text = self.find_edit.text()
        replace_text = self.replace_edit.text()
        
        if not find_text:
            QMessageBox.warning(self, "æç¤º", "è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬")
            return
        
        # è®°å½•å½“å‰ç¼–è¾‘çš„æ–‡æœ¬
        current_text = self.text_edit.toPlainText()
        self.processed_segments[self.current_segment_index] = current_text
        
        # æ‰§è¡Œæ›¿æ¢æ“ä½œ
        replace_count = 0
        for i in range(len(self.processed_segments)):
            if find_text in self.processed_segments[i]:
                self.processed_segments[i] = self.processed_segments[i].replace(find_text, replace_text)
                replace_count += self.processed_segments[i].count(replace_text)
        
        # æ›´æ–°å½“å‰æ˜¾ç¤º
        self.update_text_display()
        QMessageBox.information(self, "æ›¿æ¢å®Œæˆ", f"å…±æ›¿æ¢äº† {replace_count} å¤„æ–‡æœ¬")
    
    def generate_preview(self):
        """ç”Ÿæˆè¯•å¬éŸ³é¢‘"""
        # æ£€æŸ¥é¢„è®¾
        preset_name = self.preset_combo.currentText()
        if preset_name == "æ–°å»ºé¢„è®¾..." or not preset_name:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆé€‰æ‹©é¢„è®¾")
            return
        
        if not self.current_preset_settings:
            QMessageBox.warning(self, "é”™è¯¯", "è¯·å…ˆé€‰æ‹©é¢„è®¾")
            return
        
        # ä¿å­˜å½“å‰ç¼–è¾‘çš„æ–‡æœ¬
        current_text = self.text_edit.toPlainText()
        self.processed_segments[self.current_segment_index] = current_text
        
        # é‡ç½®æ’­æ”¾çŠ¶æ€
        self.player.stop()
        self.play_btn.setText("â–¶ï¸")
        self.play_btn.setEnabled(False)
        self.preview_progress.setEnabled(False)
        self.preview_progress.setValue(0)
        self.is_generating_preview = True
        self.preview_generated = False
        self.preview_btn.setEnabled(False)
        self.preview_status.setText("ğŸ”„ ç”Ÿæˆä¸­...")
            
        # åŠ è½½æ¨¡å‹å’Œè®¾ç½®é¢„è®¾å‚æ•°
        gpt_path = self.current_preset_settings.get('model_path', '') or self.current_preset_settings.get('gpt_path', '')
        if not self.gpt_sovits.load_models(gpt_path, self.current_preset_settings['sovits_path']):
            QMessageBox.warning(self, "é”™è¯¯", "åŠ è½½æ¨¡å‹å¤±è´¥")
            self.reset_preview_state()
            return
            
        # ç¡®ä¿è®¾ç½®åŒ…å«gpt_sovits.pyæ‰€éœ€çš„æ‰€æœ‰å¿…è¦å­—æ®µ
        preset_settings = self.current_preset_settings.copy()
        preset_settings['preset_name'] = preset_name  # æ·»åŠ é¢„è®¾åç§°
        if 'gpt_path' not in preset_settings and 'model_path' in preset_settings:
            preset_settings['gpt_path'] = preset_settings['model_path']
        if 'ref_language' not in preset_settings:
            preset_settings['ref_language'] = preset_settings.get('text_lang', 'all_zh')
            
        if not self.gpt_sovits.set_preset(preset_settings):
            QMessageBox.warning(self, "é”™è¯¯", "è®¾ç½®é¢„è®¾å¤±è´¥")
            self.reset_preview_state()
            return
        
        # è·å–å‰100å­—ï¼ˆä¿æŒå¥å­å®Œæ•´æ€§ï¼‰
        text = self.processed_segments[self.current_segment_index]
        preview_text = self.get_preview_text(text)
        
        # ç”Ÿæˆè¯•å¬éŸ³é¢‘
        logger.info("å¼€å§‹ç”Ÿæˆé¢„è§ˆéŸ³é¢‘...")
        preview_path = self.gpt_sovits.generate_preview(preview_text)
        
        if preview_path:
            self.preview_path = preview_path
            self.on_preview_generated()
            logger.info("é¢„è§ˆéŸ³é¢‘ç”ŸæˆæˆåŠŸ")
        else:
            self.reset_preview_state()
            logger.error("é¢„è§ˆéŸ³é¢‘ç”Ÿæˆå¤±è´¥")
            QMessageBox.warning(self, "é”™è¯¯", "ç”Ÿæˆè¯•å¬éŸ³é¢‘å¤±è´¥")
    
    def reset_preview_state(self):
        """é‡ç½®é¢„è§ˆçŠ¶æ€"""
        self.is_generating_preview = False
        self.preview_generated = False
        self.preview_btn.setEnabled(True)
        self.preview_status.setText("âŒ ç”Ÿæˆå¤±è´¥")
        self.play_btn.setEnabled(False)
        self.preview_progress.setEnabled(False)
        self.preview_progress.setValue(0)
    
    def on_preview_generated(self):
        """é¢„è§ˆéŸ³é¢‘ç”Ÿæˆå®Œæˆåçš„å¤„ç†"""
        self.is_generating_preview = False
        self.preview_generated = True
        self.preview_btn.setEnabled(True)
        self.play_btn.setEnabled(True)
        self.preview_progress.setEnabled(True)
        self.preview_status.setText("âœ… å·²ç”Ÿæˆ")
        
    def play_preview(self):
        """æ’­æ”¾è¯•å¬éŸ³é¢‘"""
        if not self.preview_generated or not hasattr(self, 'preview_path'):
            return
            
        try:
            current_state = self.player.playbackState()
            
            if current_state == QMediaPlayer.PlaybackState.PlayingState:
                # å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œæš‚åœ
                self.player.pause()
                self.play_btn.setText("â–¶ï¸")
            else:
                # ğŸ”§ å½»åº•ä¿®å¤æ’­æ”¾é—®é¢˜ï¼šé‡æ–°åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹
                # è¿™æ˜¯åœ¨macOSä¸Šç¡®ä¿QMediaPlayerèƒ½é‡å¤æ’­æ”¾çš„æœ€å¯é æ–¹æ³•
                try:
                    # 1. é”€æ¯å½“å‰æ’­æ”¾å™¨
                    self.player.stop()
                    self.player.setSource(QUrl())  # æ¸…ç©ºéŸ³é¢‘æº
                    
                    # 2. é‡æ–°åˆ›å»ºæ’­æ”¾å™¨å’ŒéŸ³é¢‘è¾“å‡º
                    old_volume = self.current_volume
                    del self.player
                    del self.audio_output
                    
                    self.player = QMediaPlayer()
                    self.audio_output = QAudioOutput()
                    self.player.setAudioOutput(self.audio_output)
                    
                    # 3. æ¢å¤éŸ³é‡è®¾ç½®
                    self.audio_output.setVolume(old_volume / 100.0)
                    
                    # 4. é‡æ–°è¿æ¥å¿…è¦çš„ä¿¡å·
                    self.player.positionChanged.connect(self.update_position)
                    self.player.durationChanged.connect(self.update_duration)
                    
                    # 5. è¿æ¥æ’­æ”¾å®Œæˆä¿¡å·
                    def on_media_status_changed(status):
                        if status == QMediaPlayer.MediaStatus.EndOfMedia:
                            self.play_btn.setText("â–¶ï¸")
                    
                    self.player.mediaStatusChanged.connect(on_media_status_changed)
                    
                except Exception as cleanup_error:
                    logger.warning(f"æ’­æ”¾å™¨é‡å»ºæ—¶å‡ºé”™ï¼Œå°è¯•ç®€å•é‡ç½®: {cleanup_error}")
                
                # 6. è®¾ç½®éŸ³é¢‘æºå¹¶æ’­æ”¾
                self.player.setSource(QUrl.fromLocalFile(self.preview_path))
                self.player.play()
                self.play_btn.setText("â¸")
                
                logger.info(f"å¼€å§‹æ’­æ”¾è¯•å¬éŸ³é¢‘: {self.preview_path}")
                
        except Exception as e:
            logger.error(f"æ’­æ”¾é¢„è§ˆéŸ³é¢‘æ—¶å‡ºé”™: {str(e)}")
    
    def generate_all(self):
        """ç”Ÿæˆå…¨ä¹¦éŸ³é¢‘"""
        # æ£€æŸ¥é¢„è®¾
        preset_name = self.preset_combo.currentText()
        if preset_name == "æ–°å»ºé¢„è®¾..." or not preset_name:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆé€‰æ‹©é¢„è®¾")
            return
        
        if not self.current_preset_settings:
            QMessageBox.warning(self, "é”™è¯¯", "è¯·å…ˆé€‰æ‹©é¢„è®¾")
            return
            
        # ä¿å­˜å½“å‰ç¼–è¾‘çš„æ–‡æœ¬
        current_text = self.text_edit.toPlainText()
        self.processed_segments[self.current_segment_index] = current_text
            
        # åŠ è½½æ¨¡å‹å’Œè®¾ç½®é¢„è®¾å‚æ•°
        gpt_path = self.current_preset_settings.get('model_path', '') or self.current_preset_settings.get('gpt_path', '')
        if not self.gpt_sovits.load_models(gpt_path, self.current_preset_settings['sovits_path']):
            QMessageBox.warning(self, "é”™è¯¯", "åŠ è½½æ¨¡å‹å¤±è´¥")
            return
            
        # ç¡®ä¿è®¾ç½®åŒ…å«gpt_sovits.pyæ‰€éœ€çš„æ‰€æœ‰å¿…è¦å­—æ®µ
        preset_settings = self.current_preset_settings.copy()
        preset_settings['preset_name'] = preset_name  # æ·»åŠ é¢„è®¾åç§°
        if 'gpt_path' not in preset_settings and 'model_path' in preset_settings:
            preset_settings['gpt_path'] = preset_settings['model_path']
        if 'ref_language' not in preset_settings:
            preset_settings['ref_language'] = preset_settings.get('text_lang', 'all_zh')
            
        if not self.gpt_sovits.set_preset(preset_settings):
            QMessageBox.warning(self, "é”™è¯¯", "è®¾ç½®é¢„è®¾å¤±è´¥")
            return
        
        # åˆ‡æ¢åˆ°è‡ªåŠ¨ç”Ÿæˆé¡µé¢
        parent = self.window()
        if isinstance(parent, MainWindow):
            parent.show_auto_generate_page(self.processed_segments, {
                'preset': preset_name,
                'preset_data': self.current_preset_settings
            })

    
    def get_preview_text(self, text: str, limit: int = 100) -> str:
        """è·å–é¢„è§ˆæ–‡æœ¬ï¼ˆä¿æŒå¥å­å®Œæ•´æ€§ï¼‰"""
        if len(text) <= limit:
            return text
            
        # åœ¨é™åˆ¶é•¿åº¦ä½ç½®å‘åæŸ¥æ‰¾å¥å­ç»“æŸæ ‡è®°
        end_marks = ["ã€‚", "ï¼", "ï¼Ÿ", ".", "!", "?"]
        pos = limit
        while pos < len(text):
            if text[pos] in end_marks:
                return text[:pos + 1]
            pos += 1
        
        # å¦‚æœæ‰¾ä¸åˆ°å¥å­ç»“æŸæ ‡è®°ï¼Œå°±åœ¨é™åˆ¶é•¿åº¦ä½ç½®æˆªæ–­
        return text[:limit]
    
    def update_position(self, position):
        """æ›´æ–°æ’­æ”¾è¿›åº¦"""
        self.preview_progress.setValue(position)
    
    def update_duration(self, duration):
        """æ›´æ–°éŸ³é¢‘æ€»é•¿åº¦"""
        self.preview_progress.setRange(0, duration)
    
    def set_position(self, position):
        """è®¾ç½®æ’­æ”¾ä½ç½®"""
        self.player.setPosition(position)

    def search_text(self):
        """æœç´¢æ–‡æœ¬å†…å®¹"""
        search_query = self.search_edit.text().strip()
        if not search_query:
            if self.search_mode:
                self.confirm_search()
            return
            
        # ä¿å­˜å½“å‰ç¼–è¾‘çš„æ–‡æœ¬
        current_text = self.text_edit.toPlainText()
        self.processed_segments[self.current_segment_index] = current_text
        
        # æœç´¢æ‰€æœ‰æ®µè½
        self.search_results = []
        for i, segment in enumerate(self.processed_segments):
            if search_query.lower() in segment.lower():  # ä¸åŒºåˆ†å¤§å°å†™æœç´¢
                self.search_results.append(i)
        
        if not self.search_results:
            if self.search_mode:
                self.confirm_search()
            QMessageBox.information(self, "æœç´¢ç»“æœ", "æœªæ‰¾åˆ°åŒ¹é…å†…å®¹")
            return
            
        # è¿›å…¥æœç´¢æ¨¡å¼
        self.search_mode = True
        self.last_search_query = search_query
        
        # å¦‚æœå½“å‰æ®µè½åŒ…å«æœç´¢å†…å®¹ï¼Œä¿æŒåœ¨å½“å‰æ®µè½
        if self.current_segment_index in self.search_results:
            self.search_index = self.search_results.index(self.current_segment_index)
        else:
            self.search_index = 0
            self.current_segment_index = self.search_results[0]
            
        self.confirm_search_btn.setEnabled(True)
        self.confirm_search_btn.setText(f"é€€å‡ºæœç´¢ ({len(self.search_results)}ä¸ªç»“æœ)")
        self.update_text_display()

    def on_search_text_changed(self, text):
        """å½“æœç´¢æ¡†æ–‡æœ¬æ”¹å˜æ—¶å®æ—¶æœç´¢"""
        if not text.strip():
            if self.search_mode:
                self.confirm_search()
            return
            
        if text.strip() != self.last_search_query:
            self.search_text()

    def highlight_search_text(self):
        """é«˜äº®æ˜¾ç¤ºæœç´¢æ–‡æœ¬"""
        if not self.search_mode:
            return
            
        search_query = self.search_edit.text().lower()  # è½¬æ¢ä¸ºå°å†™ä»¥è¿›è¡Œä¸åŒºåˆ†å¤§å°å†™çš„æœç´¢
        text = self.text_edit.toPlainText()
        
        cursor = self.text_edit.textCursor()
        # æ¸…é™¤ä¹‹å‰çš„æ ¼å¼
        cursor.select(cursor.Document)
        cursor.setCharFormat(QTextCharFormat())
        cursor.clearSelection()
        
        # è®¾ç½®é«˜äº®æ ¼å¼
        highlight_format = QTextCharFormat()
        highlight_format.setBackground(QColor("#FFFF00"))  # é»„è‰²èƒŒæ™¯
        
        # æŸ¥æ‰¾å¹¶é«˜äº®æ‰€æœ‰åŒ¹é…é¡¹
        text_lower = text.lower()  # è½¬æ¢ä¸ºå°å†™è¿›è¡Œæœç´¢
        start = 0
        while True:
            start = text_lower.find(search_query, start)
            if start == -1:
                break
                
            cursor.setPosition(start)
            cursor.setPosition(start + len(search_query), cursor.KeepAnchor)
            cursor.setCharFormat(highlight_format)
            
            start += len(search_query)
    
    def confirm_search(self):
        """ç¡®è®¤æœç´¢ï¼Œé€€å‡ºæœç´¢æ¨¡å¼"""
        self.search_mode = False
        self.search_results = []
        self.search_index = 0
        self.last_search_query = ""
        self.search_edit.clear()
        self.confirm_search_btn.setEnabled(False)
        self.confirm_search_btn.setText("é€€å‡ºæœç´¢")
        
        # æ¸…é™¤é«˜äº®
        cursor = self.text_edit.textCursor()
        cursor.select(cursor.Document)
        cursor.setCharFormat(QTextCharFormat())
        cursor.clearSelection()
        
        # æ›´æ–°æ˜¾ç¤º
        self.update_text_display()

    def check_system_volume(self):
        """æ£€æŸ¥ç³»ç»ŸéŸ³é‡å˜åŒ–å¹¶æ›´æ–°éŸ³é¢‘æ’­æ”¾å™¨"""
        try:
            # è·å–ç³»ç»ŸéŸ³é‡
            system_volume = int(QMediaDevices.defaultAudioOutput().volume() * 100)
            
            # å¦‚æœç³»ç»ŸéŸ³é‡ä¸å½“å‰éŸ³é‡ä¸åŒï¼Œæ›´æ–°éŸ³é‡è®¾ç½®
            if system_volume != self.current_volume:
                # æ›´æ–°æ»‘å—æ˜¾ç¤º
                self.volume_slider.setValue(system_volume)
                # æ›´æ–°éŸ³é¢‘è¾“å‡ºéŸ³é‡
                self.audio_output.setVolume(system_volume / 100.0)
                # ä¿å­˜å½“å‰éŸ³é‡è®¾ç½®
                self.current_volume = system_volume
        except Exception as e:
            # å¦‚æœè·å–ç³»ç»ŸéŸ³é‡å¤±è´¥ï¼Œåˆ™ä¸åšå¤„ç†
            pass

class AutoGenerateCard(Card):
    def __init__(self, segments: List[str], settings: dict, parent=None):
        super().__init__(parent)
        self.segments = segments
        self.preset_name = settings['preset']
        self.preset_data = settings['preset_data']
        self.current_segment_index = 0
        self.is_generating = False
        self.gpt_sovits = GPTSoVITS()
        
        # æ·»åŠ å‰ä¸€ä¸ªæ®µè½é•¿åº¦è®°å½•
        self.prev_segment_length = 0
        
        # æ·»åŠ æ–‡ä»¶åå’Œç›®å½•ç›¸å…³å±æ€§
        self.main_window = self.window()
        self.source_filename = "unknown"
        if hasattr(self.main_window, 'current_file') and self.main_window.current_file:
            self.source_filename = os.path.splitext(os.path.basename(self.main_window.current_file))[0]
        
        # è·å–ä¸»çª—å£çš„æ‰¹å¤„ç†å­—æ•°è®¾ç½®
        if isinstance(self.main_window, MainWindow):
            self.batch_size = self.main_window.batch_spin.value()
        else:
            self.batch_size = 5000  # é»˜è®¤å€¼
        
        # æ‰€æœ‰ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶è·¯å¾„åˆ—è¡¨
        self.generated_audio_files = []
        
        self.init_ui()
        
        # åŠ è½½æ¨¡å‹
        gpt_path = self.preset_data.get('model_path', '') or self.preset_data.get('gpt_path', '')
        if not self.gpt_sovits.load_models(gpt_path, self.preset_data['sovits_path']):
            QMessageBox.warning(self, "é”™è¯¯", "åŠ è½½æ¨¡å‹å¤±è´¥")
            return
            
        # è®¾ç½®é¢„è®¾å‚æ•°
        # ç¡®ä¿è®¾ç½®åŒ…å«gpt_sovits.pyæ‰€éœ€çš„æ‰€æœ‰å¿…è¦å­—æ®µ
        preset_settings = self.preset_data.copy()
        preset_settings['preset_name'] = self.preset_name  # æ·»åŠ é¢„è®¾åç§°
        if 'gpt_path' not in preset_settings and 'model_path' in preset_settings:
            preset_settings['gpt_path'] = preset_settings['model_path']
        if 'ref_language' not in preset_settings:
            preset_settings['ref_language'] = preset_settings.get('text_lang', 'all_zh')
            
        if not self.gpt_sovits.set_preset(preset_settings):
            QMessageBox.warning(self, "é”™è¯¯", "è®¾ç½®é¢„è®¾å¤±è´¥")
            return

    def init_ui(self):
        layout = QVBoxLayout(self)
        layout.setSpacing(20)
        
        # çŠ¶æ€æ˜¾ç¤º
        self.status_label = QLabel("æ­£åœ¨ç”Ÿæˆ...")
        self.status_label.setStyleSheet("font-size: 16px; font-weight: bold;")
        
        # è¿›åº¦æ¡
        self.progress = QProgressBar()
        self.progress.setRange(0, len(self.segments))
        self.progress.setValue(0)
        
        # å½“å‰å¤„ç†çš„æ–‡æœ¬é¢„è§ˆ
        preview_group = QGroupBox("å½“å‰å¤„ç†æ–‡æœ¬")
        preview_layout = QVBoxLayout(preview_group)
        self.preview_text = QTextEdit()
        self.preview_text.setReadOnly(True)
        self.preview_text.setMaximumHeight(100)
        preview_layout.addWidget(self.preview_text)
        
        # æ·»åŠ ç»„ä»¶åˆ°å¸ƒå±€
        layout.addWidget(self.status_label, alignment=Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(self.progress)
        layout.addWidget(preview_group)
        
        # å¼€å§‹ç”Ÿæˆ
        QTimer.singleShot(100, self.start_generate)
    
    def start_generate(self):
        """å¼€å§‹ç”Ÿæˆå…¨ä¹¦éŸ³é¢‘"""
        try:
            # è®¾ç½®é¢„è®¾
            preset_settings = self.preset_data.copy()
            preset_settings['preset_name'] = self.preset_name  # æ·»åŠ é¢„è®¾åç§°
            if not self.gpt_sovits.set_preset(preset_settings):
                raise Exception("è®¾ç½®é¢„è®¾å¤±è´¥")
            
            # åˆ›å»ºè¾“å‡ºç›®å½•ç»“æ„
            working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
            processed_dir = os.path.join(working_dir, f"{self.source_filename}_processed")
            
            # åˆ›å»ºaudio_segmentsç›®å½•
            self.audio_dir = os.path.join(processed_dir, "audio_segments")
            os.makedirs(self.audio_dir, exist_ok=True)
            
            # åˆ›å»ºmerged_segmentsç›®å½•
            self.merged_dir = os.path.join(processed_dir, "merged_segments")
            os.makedirs(self.merged_dir, exist_ok=True)
            
            self.process_next_segment()
            
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"å¼€å§‹ç”Ÿæˆå¤±è´¥: {str(e)}")
            self.on_generation_complete()
    
    def process_next_segment(self):
        """å¤„ç†ä¸‹ä¸€ä¸ªæ®µè½"""
        if self.current_segment_index >= len(self.segments):
            self.on_generation_complete()
            return
        
        # æ›´æ–°æ˜¾ç¤º
        current_text = self.segments[self.current_segment_index]
        # æ˜¾ç¤ºé¢„è§ˆæ–‡æœ¬ï¼ˆé™åˆ¶é•¿åº¦ä»¥ä¾¿é˜…è¯»ï¼‰
        preview_text = self.get_preview_text(current_text, 200)
        self.preview_text.setText(preview_text)
        self.progress.setValue(self.current_segment_index)
        
        # å¼ºåˆ¶åˆ·æ–°UI
        QApplication.processEvents()
        
        # è®°å½•å½“å‰æ®µè½é•¿åº¦ï¼Œä¾›ä¸‹ä¸€æ¬¡ç”Ÿæˆä½¿ç”¨
        self.prev_segment_length = len(current_text)
        
        # ç”ŸæˆéŸ³é¢‘è·¯å¾„ä½¿ç”¨å¤šäººæ¨¡å¼çš„å‘½åæ ¼å¼
        output_path = os.path.join(
            self.audio_dir,
            f"{self.source_filename}_æ®µè½{self.current_segment_index + 1}_æ–‡æœ¬æ¡†1.wav"
        )
        
        # ä½¿ç”¨QTimerå¼‚æ­¥ç”ŸæˆéŸ³é¢‘ï¼Œé¿å…é˜»å¡UI
        QTimer.singleShot(100, lambda: self.generate_current_segment(output_path))
    
    def generate_current_segment(self, output_path: str):
        """ç”Ÿæˆå½“å‰æ®µè½çš„éŸ³é¢‘"""
        try:
            # ç”ŸæˆéŸ³é¢‘
            success = self.gpt_sovits.generate_audio(
                self.segments[self.current_segment_index],
                output_path
            )
            
            if success:
                # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶åˆ°åˆ—è¡¨
                self.generated_audio_files.append(output_path)
                self.current_segment_index += 1
                
                # æ·»åŠ åŸºäºå‰ä¸€ä¸ªæ®µè½é•¿åº¦çš„å»¶è¿Ÿï¼Œç„¶åå¤„ç†ä¸‹ä¸€ä¸ªæ®µè½
                if self.current_segment_index < len(self.segments):
                    delay_ms = max(100, self.prev_segment_length // 2)  # æœ€å°‘100mså»¶è¿Ÿ
                    QTimer.singleShot(delay_ms, self.process_next_segment)
                else:
                    self.on_generation_complete()
            else:
                QMessageBox.critical(self, "é”™è¯¯", f"ç”Ÿæˆç¬¬ {self.current_segment_index + 1} æ®µå¤±è´¥")
                self.on_generation_complete()
                
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"ç”Ÿæˆç¬¬ {self.current_segment_index + 1} æ®µæ—¶å‡ºé”™: {str(e)}")
            self.on_generation_complete()
    
    def get_preview_text(self, text: str, limit: int = 200) -> str:
        """è·å–é¢„è§ˆæ–‡æœ¬ï¼ˆä¿æŒå¥å­å®Œæ•´æ€§ï¼‰"""
        if len(text) <= limit:
            return text
            
        # åœ¨é™åˆ¶é•¿åº¦ä½ç½®å‘åæŸ¥æ‰¾å¥å­ç»“æŸæ ‡è®°
        end_marks = ["ã€‚", "ï¼", "ï¼Ÿ", ".", "!", "?"]
        pos = limit
        while pos < len(text):
            if text[pos] in end_marks:
                return text[:pos + 1] + "..."
            pos += 1
            
        # å¦‚æœæ‰¾ä¸åˆ°å¥å­ç»“æŸæ ‡è®°ï¼Œç›´æ¥æˆªæ–­
        return text[:limit] + "..."
    
    def on_generation_complete(self):
        """å…¨éƒ¨ç”Ÿæˆå®Œæˆ"""
        self.status_label.setText("âœ… ç”Ÿæˆå®Œæˆï¼")
        self.progress.setValue(len(self.segments))
        
        if self.current_segment_index == len(self.segments):
            # è‡ªåŠ¨è¿›è¡ŒéŸ³é¢‘åˆå¹¶
            self.merge_segment_audio()
            QMessageBox.information(self, "ç”Ÿæˆå®Œæˆ", f"å…¨ä¹¦éŸ³é¢‘ç”Ÿæˆå®Œæˆï¼\nè¾“å‡ºç›®å½•ï¼š{self.audio_dir}\nå·²è‡ªåŠ¨åˆå¹¶éŸ³é¢‘åˆ°ï¼š{self.merged_dir}")
        else:
            QMessageBox.warning(self, "ç”Ÿæˆä¸­æ–­", f"ç”Ÿæˆåœ¨ç¬¬ {self.current_segment_index + 1} æ®µä¸­æ–­")
        
        # è¿”å›ä¸»é¡µé¢
        parent = self.window()
        if isinstance(parent, MainWindow):
            parent.show_main_page()
            
    def merge_segment_audio(self):
        """åˆå¹¶éŸ³é¢‘æ®µè½ä¸ºæ›´å¤§çš„å—"""
        try:
            # è®¡ç®—åˆå¹¶è§„åˆ™ï¼š10000/åˆ†æ‰¹å¤„ç†å­—æ•°
            segments_per_file = int(10000 / self.batch_size)
            if segments_per_file < 1:
                segments_per_file = 1
                
            self.status_label.setText("åˆå¹¶éŸ³é¢‘...")
            
            # ä½¿ç”¨pydubåˆå¹¶éŸ³é¢‘
            from pydub import AudioSegment
            
            # å¯¹ç”Ÿæˆçš„æ–‡ä»¶è¿›è¡Œæ’åº
            self.generated_audio_files.sort()
            total_files = len(self.generated_audio_files)
            
            # åˆ›å»ºä¸€ä¸ªè¿›åº¦å¯¹è¯æ¡†
            progress = QProgressDialog("æ­£åœ¨åˆå¹¶éŸ³é¢‘...", "å–æ¶ˆ", 0, total_files // segments_per_file + 1, self)
            progress.setWindowTitle("éŸ³é¢‘åˆå¹¶")
            progress.setWindowModality(Qt.WindowModality.WindowModal)
            progress.setMinimumWidth(300)
            progress.show()
            
            # æŒ‰segments_per_fileçš„æ•°é‡åˆ†ç»„åˆå¹¶
            for group_idx in range(0, total_files, segments_per_file):
                progress.setValue(group_idx // segments_per_file)
                progress.setLabelText(f"æ­£åœ¨åˆå¹¶ç»„ {group_idx // segments_per_file + 1}/{(total_files // segments_per_file) + 1}")
                
                if progress.wasCanceled():
                    break
                    
                # è·å–å½“å‰ç»„çš„æ–‡ä»¶
                group_files = self.generated_audio_files[group_idx:group_idx + segments_per_file]
                if not group_files:
                    continue
                    
                # åˆå¹¶éŸ³é¢‘
                combined = AudioSegment.empty()
                for audio_file in group_files:
                    segment = AudioSegment.from_wav(audio_file)
                    combined += segment
                
                # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶å
                output_file = os.path.join(
                    self.merged_dir,
                    f"{self.source_filename}_åˆå¹¶{group_idx // segments_per_file + 1}.wav"
                )
                
                # å¯¼å‡ºåˆå¹¶åçš„éŸ³é¢‘
                combined.export(output_file, format="wav")
                
                # å¤„ç†äº‹ä»¶ï¼Œä¿æŒUIå“åº”
                QApplication.processEvents()
                
            progress.close()
            
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"åˆå¹¶éŸ³é¢‘å¤±è´¥: {str(e)}")

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.text_processor = TextProcessor()
        self.preset_manager = PresetManager()
        self.preset_order_manager = PresetOrderManager()  # æ·»åŠ é¢„è®¾æ’åºç®¡ç†å™¨
        self.initUI()

    def initUI(self):
        self.setWindowTitle('GPT-SoVITS æ–‡æœ¬å¤„ç†')
        self.setStyleSheet(StyleSheet.MAIN_STYLE)
        
        # ğŸ”§ å›ºå®šçª—å£å¤§å°å¹¶å¢åŠ é«˜åº¦
        # åŸæ¥: 864x558, ç°åœ¨: 864x1081 (å‡å°‘0.5cmçº¦19px)
        # ä¸ºmacOSé¡¶éƒ¨èœå•æ é¢„ç•™ç©ºé—´
        fixed_width = 864
        fixed_height = 1081
        
        # è®¾ç½®å›ºå®šçª—å£å¤§å°ï¼Œç¦æ­¢è°ƒæ•´
        self.setFixedSize(fixed_width, fixed_height)
        
        # ğŸ”§ å›ºå®šå­—ä½“å¤§å°å®šä¹‰
        base_font_size = 12
        
        # è®¾ç½®çª—å£å­—ä½“ - ä½¿ç”¨å›ºå®šå­—ä½“å¤§å°
        font = QFont("SF Pro Display", base_font_size)
        self.setFont(font)

        # åˆ›å»ºä¸»çª—å£éƒ¨ä»¶å’Œæ»šåŠ¨åŒºåŸŸ
        main_widget = QWidget()
        scroll_area = QScrollArea()
        scroll_area.setWidget(main_widget)
        scroll_area.setWidgetResizable(True)
        scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        scroll_area.setStyleSheet("""
            QScrollArea {
                border: none;
                background-color: #faf6f1;  /* æŠ¤çœ¼ç±³è‰²èƒŒæ™¯ */
            }
            QScrollArea > QWidget > QWidget {
                background-color: #faf6f1;  /* ç¡®ä¿å†…å®¹åŒºåŸŸä¹Ÿæ˜¯ç±³è‰² */
            }
            QScrollBar:vertical {
                border: none;
                background: #f0f0f0;
                width: 10px;
                border-radius: 5px;
            }
            QScrollBar::handle:vertical {
                background: #C67A8A;
                border-radius: 5px;
                min-height: 20px;
            }
            QScrollBar::add-line:vertical,
            QScrollBar::sub-line:vertical {
                height: 0px;
            }
            QScrollBar::add-page:vertical,
            QScrollBar::sub-page:vertical {
                background: none;
            }
        """)
        self.setCentralWidget(scroll_area)
        
        # ä¸»å¸ƒå±€ - ä½¿ç”¨ç›¸å¯¹é—´è·
        layout = QVBoxLayout(main_widget)
        layout.setSpacing(int(self.width() * 0.012))  # é—´è·ä¸ºçª—å£å®½åº¦çš„1.2%
        layout.setContentsMargins(
            int(self.width() * 0.017),  # å·¦è¾¹è·ä¸ºçª—å£å®½åº¦çš„1.7%
            int(self.height() * 0.027),  # ä¸Šè¾¹è·ä¸ºçª—å£é«˜åº¦çš„2.7%
            int(self.width() * 0.017),   # å³è¾¹è·ä¸ºçª—å£å®½åº¦çš„1.7%
            int(self.height() * 0.027)    # ä¸‹è¾¹è·ä¸ºçª—å£é«˜åº¦çš„2.7%
        )

        # é¡¶éƒ¨æŒ‰é’®åŒºåŸŸ
        top_layout = QHBoxLayout()
        self.add_preset_btn = QPushButton('æ–°å»ºé¢„è®¾')
        # ğŸ”§ ä½¿ç”¨å›ºå®šçš„æŒ‰é’®å°ºå¯¸ï¼Œç»Ÿä¸€è®¾ä¸º32pxé«˜åº¦
        button_height = 32
        self.add_preset_btn.setFixedHeight(button_height)
        self.add_preset_btn.setMaximumWidth(120)  # é™åˆ¶æœ€å¤§å®½åº¦é¿å…è¿‡å®½
        
        # æ·»åŠ æ¨¡å‹ç¼“å­˜ç®¡ç†æŒ‰é’®
        self.cache_status_btn = QPushButton('ç¼“å­˜çŠ¶æ€')
        self.cache_status_btn.setFixedHeight(button_height)
        self.cache_status_btn.setMaximumWidth(120)
        
        self.clear_cache_btn = QPushButton('æ¸…ç©ºç¼“å­˜')
        self.clear_cache_btn.setFixedHeight(button_height) 
        self.clear_cache_btn.setMaximumWidth(120)
        
        top_layout.addWidget(self.add_preset_btn)
        top_layout.addStretch()
        top_layout.addWidget(self.cache_status_btn)
        top_layout.addWidget(self.clear_cache_btn)

        # å †å çª—å£ç”¨äºåˆ‡æ¢ç•Œé¢
        self.stack = QStackedWidget()
        
        # æ–‡æœ¬å¤„ç†é¡µé¢
        text_page = QWidget()
        text_layout = QVBoxLayout(text_page)
        text_layout.setSpacing(int(self.width() * 0.012))
        
        # æ–‡æœ¬å¤„ç†åŒºåŸŸ
        text_card = Card()
        card_layout = QVBoxLayout(text_card)
        card_layout.setSpacing(int(self.width() * 0.009))
        
        # æ–‡ä»¶é€‰æ‹©åŒºåŸŸ
        file_layout = QHBoxLayout()
        self.file_btn = QPushButton('ğŸ“„ é€‰æ‹©æ–‡ä»¶')
        self.file_btn.setMinimumHeight(int(self.height() * 0.05))
        self.file_path_label = QLabel('æœªé€‰æ‹©æ–‡ä»¶')
        self.file_path_label.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.9)}px;")
        file_layout.addWidget(self.file_btn)
        file_layout.addWidget(self.file_path_label)
        file_layout.addStretch()
        
        # æ–‡æœ¬é¢„è§ˆåŒºåŸŸ
        preview_group = QGroupBox("æ–‡æœ¬é¢„è§ˆ")
        preview_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(self.height() * 0.02)}px;
                margin-top: {int(self.height() * 0.014)}px;
            }}
        """)
        preview_layout = QVBoxLayout(preview_group)
        preview_layout.setContentsMargins(
            int(self.width() * 0.009),
            int(self.height() * 0.014),
            int(self.width() * 0.009),
            int(self.height() * 0.014)
        )
        self.preview_text = QTextEdit()
        self.preview_text.setPlaceholderText("è¿™é‡Œå°†æ˜¾ç¤ºæ–‡ä»¶å†…å®¹é¢„è§ˆ...")
        self.preview_text.setReadOnly(True)
        # é¢„è§ˆæ–‡æœ¬æ¡†é«˜åº¦è®¾ç½®ä¸ºçª—å£é«˜åº¦çš„30%
        self.preview_text.setMinimumHeight(int(self.height() * 0.3))
        preview_layout.addWidget(self.preview_text)
        
        # å¤„ç†é€‰é¡¹
        options_group = QGroupBox("å¤„ç†é€‰é¡¹")
        options_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(self.height() * 0.02)}px;
                margin-top: {int(self.height() * 0.014)}px;
            }}
        """)
        options_layout = QGridLayout(options_group)
        options_layout.setSpacing(int(self.width() * 0.009))
        options_layout.setContentsMargins(
            int(self.width() * 0.009),
            int(self.height() * 0.014),
            int(self.width() * 0.009),
            int(self.height() * 0.014)
        )
        
        # æ–‡æœ¬è½¬æ¢é€‰é¡¹
        convert_label = QLabel("æ–‡æœ¬è½¬æ¢")
        convert_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.convert_check = QCheckBox("è½¬æ¢ä¸ºtxtæ ¼å¼")
        self.convert_check.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.convert_check.setChecked(True)
        self.convert_check.setEnabled(False)
        convert_note = QLabel("epubå’Œpdfæ–‡ä»¶ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºtxtæ ¼å¼")
        convert_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        options_layout.addWidget(convert_label, 0, 0)
        options_layout.addWidget(self.convert_check, 0, 1)
        options_layout.addWidget(convert_note, 0, 2)
        
        # è‹±æ–‡å¤„ç†é€‰é¡¹
        english_label = QLabel("è‹±æ–‡å¤„ç†")
        english_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.english_check = QCheckBox("å»é™¤è‹±æ–‡å†…å®¹")
        self.english_check.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.english_check.setChecked(True)
        english_note = QLabel("å»é™¤æ‰€æœ‰è‹±æ–‡ä»¥åŠè¢«æ‹¬å·ã€å¼•å·ç­‰åŒ…å«çš„è‹±æ–‡ï¼ˆå«æ ‡ç‚¹ç¬¦å·ï¼‰")
        english_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        options_layout.addWidget(english_label, 1, 0)
        options_layout.addWidget(self.english_check, 1, 1)
        options_layout.addWidget(english_note, 1, 2)
        
        # å•æ¬¡å¤„ç†å­—æ•°
        batch_label = QLabel("å•æ¬¡å¤„ç†å­—æ•°")
        batch_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.batch_spin = QSpinBox()
        self.batch_spin.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.batch_spin.setRange(100, 1000000)  # è®¾ç½®ä¸ºéå¸¸å¤§çš„å€¼ï¼Œå®é™…ä¸Šæ²¡æœ‰ä¸Šé™
        self.batch_spin.setSingleStep(1000)
        self.batch_spin.setValue(10000)
        batch_note = QLabel("æ¯æ¬¡å¤„ç†çš„æ–‡æœ¬é•¿åº¦ï¼Œé»˜è®¤10000å­—ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´")
        batch_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        options_layout.addWidget(batch_label, 2, 0)
        options_layout.addWidget(self.batch_spin, 2, 1)
        options_layout.addWidget(batch_note, 2, 2)
        
        # å¬ä¹¦æ¨¡å¼é€‰é¡¹
        mode_label = QLabel("å¬ä¹¦æ¨¡å¼")
        mode_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        mode_widget = QWidget()
        mode_buttons_layout = QHBoxLayout(mode_widget)
        self.single_radio = QRadioButton("å•äººæœ—è¯»")
        self.multi_radio = QRadioButton("å¤šäººæœ—è¯»")
        self.single_radio.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.multi_radio.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.multi_radio.setChecked(True)  # é»˜è®¤ä¸ºå¤šäººæœ—è¯»æ¨¡å¼
        mode_buttons_layout.addWidget(self.single_radio)
        mode_buttons_layout.addWidget(self.multi_radio)
        mode_buttons_layout.addStretch()
        mode_note = QLabel("é€‰æ‹©å•äººæœ—è¯»æˆ–å¤šäººåˆ†è§’è‰²æœ—è¯»")
        mode_note.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
        options_layout.addWidget(mode_label, 3, 0)
        options_layout.addWidget(mode_widget, 3, 1)
        options_layout.addWidget(mode_note, 3, 2)
        
        # æ·»åŠ æ‰€æœ‰ç»„ä»¶åˆ°æ–‡æœ¬å¤„ç†å¸ƒå±€
        card_layout.addLayout(file_layout)
        card_layout.addWidget(preview_group)
        card_layout.addWidget(options_group)
        
        # åº•éƒ¨æŒ‰é’®
        button_layout = QHBoxLayout()
        self.process_btn = QPushButton('å¤„ç†æ–‡æœ¬')
        self.process_btn.setObjectName("generate_btn")
        self.process_btn.setMinimumHeight(int(self.height() * 0.05))
        button_layout.addStretch()
        button_layout.addWidget(self.process_btn)
        
        # æ·»åŠ æ‰€æœ‰ç»„ä»¶åˆ°æ–‡æœ¬å¤„ç†é¡µé¢
        text_layout.addWidget(text_card)
        text_layout.addLayout(button_layout)
        
        # é¢„è®¾è®¾ç½®é¡µé¢
        preset_page = QWidget()
        preset_layout = QVBoxLayout(preset_page)
        
        # æ·»åŠ é¡µé¢åˆ°å †å çª—å£
        self.stack.addWidget(text_page)
        self.stack.addWidget(preset_page)
        
        # æ·»åŠ æ‰€æœ‰ç»„ä»¶åˆ°ä¸»å¸ƒå±€
        layout.addLayout(top_layout)
        layout.addWidget(self.stack)
        
        # è¿æ¥ä¿¡å·
        self.file_btn.clicked.connect(self.select_file)
        self.process_btn.clicked.connect(self.process_text)
        self.add_preset_btn.clicked.connect(self.show_preset_setting)
        self.cache_status_btn.clicked.connect(self.show_cache_status)
        self.clear_cache_btn.clicked.connect(self.clear_model_cache)
        
        # æ·»åŠ çª—å£å¤§å°å˜åŒ–äº‹ä»¶å¤„ç†
        self.resizeEvent = self.on_resize
    
    def on_resize(self, event):
        """å¤„ç†çª—å£å¤§å°å˜åŒ–äº‹ä»¶"""
        # æ›´æ–°åŸºç¡€å­—ä½“å¤§å°
        base_font_size = max(12, int(self.width() / 72))
        
        # æ›´æ–°æ‰€æœ‰ç»„ä»¶çš„å­—ä½“å¤§å°
        for widget in self.findChildren(QLabel):
            if isinstance(widget, QLabel):
                if "note" in widget.objectName():
                    widget.setStyleSheet(f"color: #666; font-size: {int(base_font_size * 0.85)}px;")
                else:
                    widget.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        
        for widget in self.findChildren((QLineEdit, QPushButton, QComboBox, QSpinBox, QDoubleSpinBox)):
            widget.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        
        # æ›´æ–°ç»„æ¡†æ ·å¼
        for group_box in self.findChildren(QGroupBox):
            group_box.setStyleSheet(f"""
                QGroupBox {{
                    font-size: {int(base_font_size * 1.1)}px;
                    font-weight: 500;
                    padding-top: {int(self.height() * 0.02)}px;
                    margin-top: {int(self.height() * 0.014)}px;
                }}
            """)
        
        # æ›´æ–°æŒ‰é’®é«˜åº¦
        self.add_preset_btn.setMinimumHeight(int(self.height() * 0.05))
        self.process_btn.setMinimumHeight(int(self.height() * 0.05))
        self.cache_status_btn.setMinimumHeight(int(self.height() * 0.05))
        self.clear_cache_btn.setMinimumHeight(int(self.height() * 0.05))
        
        super().resizeEvent(event)
    
    def show_preset_setting(self, preset_name: str = None, source_page: str = "main"):
        """æ˜¾ç¤ºé¢„è®¾è®¾ç½®é¡µé¢"""
        self.source_page = source_page  # è®°å½•æ¥æºé¡µé¢
        
        # ğŸ”§ ä¸ºé¢„è®¾è®¾ç½®é¡µé¢æ·»åŠ æ»šåŠ¨æ”¯æŒ
        # åˆ›å»ºä¸€ä¸ªå®¹å™¨widgetåŒ…è£…PresetSettingCard
        scroll_container = QWidget()
        scroll_area = QScrollArea()
        preset_card = PresetSettingCard(self.preset_manager, self.preset_order_manager, preset_name, source_page, self)
        
        # è®¾ç½®æ»šåŠ¨åŒºåŸŸ
        scroll_area.setWidget(preset_card)
        scroll_area.setWidgetResizable(True)
        scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        scroll_area.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAsNeeded)
        scroll_area.setStyleSheet("""
            QScrollArea {
                border: none;
                background: transparent;
            }
            QScrollBar:vertical {
                background: #f0f0f0;
                width: 12px;
                border-radius: 6px;
            }
            QScrollBar::handle:vertical {
                background: #c0c0c0;
                min-height: 20px;
                border-radius: 6px;
            }
            QScrollBar::handle:vertical:hover {
                background: #a0a0a0;
            }
        """)
        
        # å°†æ»šåŠ¨åŒºåŸŸåŒ…è£…åœ¨å®¹å™¨ä¸­
        container_layout = QVBoxLayout(scroll_container)
        container_layout.setContentsMargins(0, 0, 0, 0)
        container_layout.addWidget(scroll_area)
        
        self.stack.addWidget(scroll_container)
        self.stack.setCurrentWidget(scroll_container)
    
    def show_main_page(self):
        """è¿”å›ä¸»é¡µé¢"""
        # å¦‚æœæ˜¯ä»æ®µè½å¤„ç†é¡µé¢è·³è½¬è¿‡æ¥çš„ï¼Œåˆ™è¿”å›æ®µè½å¤„ç†é¡µé¢
        if hasattr(self, 'source_page') and self.source_page == "segment":
            for i in range(self.stack.count()):
                widget = self.stack.widget(i)
                if isinstance(widget, SegmentProcessCard):
                    # å¦‚æœæ®µè½å¤„ç†å¡ç‰‡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œåˆ™æ¢å¤
                    if hasattr(widget, 'saved_segment_index'):
                        widget.current_segment_index = widget.saved_segment_index
                        # å¦‚æœæœ‰ä¿å­˜é¢„è®¾é€‰æ‹©çŠ¶æ€ï¼Œåˆ™æ¢å¤
                        if hasattr(widget, 'saved_preset_selections'):
                            # é¦–å…ˆå¤„ç†å½“å‰æ®µè½
                            widget.process_current_segment()
                            
                            # æ¢å¤å…¨å±€æ—ç™½é¢„è®¾ï¼ˆå¦‚æœæœ‰ï¼‰
                            if hasattr(widget, 'saved_global_narration_preset') and widget.saved_global_narration_preset:
                                widget._restore_global_narration_preset(
                                    widget.saved_global_narration_preset, 
                                    widget.saved_global_narration_emotion
                                )
                            
                            # æ¢å¤å„æ–‡æœ¬æ¡†çš„é¢„è®¾é€‰æ‹©
                            for i in range(widget.content_layout.count()):
                                w = widget.content_layout.itemAt(i).widget()
                                # è·³è¿‡å…¨å±€æ›¿æ¢æ¡†
                                if i == 0 and isinstance(w, QFrame) and "å…¨å±€æ–‡æœ¬æ›¿æ¢" in w.findChildren(QLabel)[0].text():
                                    continue
                                    
                                if isinstance(w, QFrame):
                                    # æ‰¾åˆ°æ–‡æœ¬æ¡†å’Œæ§åˆ¶é¢æ¿
                                    text_edit = None
                                    voice_combo = None
                                    emotion_combo = None
                                    
                                    # æŸ¥æ‰¾æ–‡æœ¬æ¡†
                                    for j in range(w.layout().count()):
                                        item = w.layout().itemAt(j).widget()
                                        # æŸ¥æ‰¾æ–‡æœ¬æ¡†å®¹å™¨
                                        if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                                            for k in range(item.layout().count()):
                                                sub_item = item.layout().itemAt(k).widget()
                                                if isinstance(sub_item, QTextEdit):
                                                    text_edit = sub_item
                                                    break
                                    
                                    # æŸ¥æ‰¾æ§åˆ¶é¢æ¿
                                    for j in range(w.layout().count()):
                                        item = w.layout().itemAt(j).widget()
                                        if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                                            control_layout = item.layout()
                                            # æŸ¥æ‰¾é¢„è®¾å’Œæƒ…ç»ªä¸‹æ‹‰æ¡†
                                            found_combos = []
                                            for k in range(control_layout.count()):
                                                control_item = control_layout.itemAt(k).widget()
                                                if isinstance(control_item, QComboBox):
                                                    found_combos.append(control_item)
                                                    
                                            if len(found_combos) >= 2:
                                                voice_combo = found_combos[0]
                                                emotion_combo = found_combos[1]
                                        
                                    # å¦‚æœæ‰¾åˆ°äº†æ‰€æœ‰éœ€è¦çš„æ§ä»¶ï¼Œå°è¯•æ¢å¤é¢„è®¾é€‰æ‹©çŠ¶æ€
                                    if text_edit and voice_combo and emotion_combo:
                                        text_edit_id = text_edit.objectName()
                                        # é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…ID
                                        if text_edit_id in widget.saved_preset_selections:
                                            # æ¢å¤é¢„è®¾é€‰æ‹©
                                            preset_info = widget.saved_preset_selections[text_edit_id]
                                            preset = preset_info['preset']
                                            preset_index = voice_combo.findText(preset)
                                            if preset_index >= 0:
                                                voice_combo.setCurrentIndex(preset_index)
                                                
                                                # æ¢å¤æƒ…ç»ªé€‰æ‹©
                                                emotion = preset_info['emotion']
                                                emotions = widget.preset_manager.get_preset_emotions(preset)
                                                emotion_combo.clear()
                                                emotion_combo.addItems(emotions)
                                                
                                                emotion_index = emotion_combo.findText(emotion)
                                                if emotion_index >= 0:
                                                    emotion_combo.setCurrentIndex(emotion_index)
                        else:
                            # æ²¡æœ‰ä¿å­˜çš„é¢„è®¾é€‰æ‹©çŠ¶æ€ï¼Œåªå¤„ç†å½“å‰æ®µè½
                            widget.process_current_segment()
                            
                        # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
                        widget.update_nav_buttons()
                    self.stack.setCurrentWidget(widget)
                    return
        
        # é»˜è®¤å›åˆ°ä¸»é¡µé¢
        self.stack.setCurrentIndex(0)
        
        # æ¢å¤é¡¶éƒ¨æŒ‰é’®çš„å¯è§æ€§
        self.add_preset_btn.setVisible(True)
        self.process_btn.setVisible(True)
        self.cache_status_btn.setVisible(True)
        self.clear_cache_btn.setVisible(True)

    def select_file(self):
        # è®¾ç½®Workingç›®å½•ä½œä¸ºé»˜è®¤ç›®å½•
        working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
        os.makedirs(working_dir, exist_ok=True)  # ç¡®ä¿Workingç›®å½•å­˜åœ¨
        
        file_name, _ = QFileDialog.getOpenFileName(
            self,
            "é€‰æ‹©æ–‡ä»¶",
            working_dir,  # å°†é»˜è®¤ç›®å½•è®¾ç½®ä¸ºWorkingç›®å½•
            "æ”¯æŒçš„æ–‡ä»¶ (*.txt *.epub *.pdf);;æ–‡æœ¬æ–‡ä»¶ (*.txt);;EPUBæ–‡ä»¶ (*.epub);;PDFæ–‡ä»¶ (*.pdf)"
        )
        if file_name:
            # è·å–åŸå§‹æ–‡ä»¶ä¿¡æ¯
            base_name = os.path.splitext(os.path.basename(file_name))[0]
            working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
            
            # ä½¿ç”¨åŸå§‹é€‰æ‹©çš„æ–‡ä»¶
            self.current_file = file_name
            self.file_path_label.setText(os.path.basename(file_name))
            self.load_file_preview(file_name)
    
    def load_file_preview(self, file_path):
        """åŠ è½½æ–‡ä»¶é¢„è§ˆ"""
        try:
            # å…ˆè½¬æ¢æ–‡ä»¶
            preview_text = self.text_processor.convert_to_txt(file_path)
            if preview_text:
                # åªæ˜¾ç¤ºå‰1000ä¸ªå­—ç¬¦
                preview = preview_text[:1000]
                if len(preview_text) > 1000:
                    preview += "\n...(æ›´å¤šå†…å®¹å·²çœç•¥)"
                self.preview_text.setText(preview)
            else:
                self.preview_text.setText("æ–‡ä»¶é¢„è§ˆå¤±è´¥ï¼šæ— æ³•è¯»å–æ–‡ä»¶å†…å®¹")
        except Exception as e:
            self.preview_text.setText(f"æ–‡ä»¶é¢„è§ˆå¤±è´¥ï¼š{str(e)}")
    
    def process_text(self):
        """å¤„ç†æ–‡æœ¬"""
        if not hasattr(self, 'current_file'):
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆé€‰æ‹©æ–‡ä»¶")
            return
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é¢„è®¾
        presets = self.preset_manager.get_all_presets()
        if not presets:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆåœ¨ä¸»é¡µé¢åˆ›å»ºè‡³å°‘ä¸€ä¸ªé¢„è®¾")
            return
        
        try:
            # è·å–å¤„ç†è®¾ç½®
            settings = {
                'remove_english': self.english_check.isChecked(),
                'batch_size': self.batch_spin.value(),
                'is_multi_speaker': self.multi_radio.isChecked()
            }
            
            # è·å–æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
            base_name = os.path.splitext(os.path.basename(self.current_file))[0]
            
            # æ£€æŸ¥Workingç›®å½•ä¸­æ˜¯å¦æœ‰å·²å¤„ç†çš„åŒåæ–‡ä»¶
            working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
            processed_dir = os.path.join(working_dir, f"{base_name}_processed")
            segments_file = os.path.join(processed_dir, "segments.txt")
            
            
            
            # æ˜¾ç¤ºè¿›åº¦æ¡
            progress = QProgressBar(self)
            progress.setWindowTitle("å¤„ç†ä¸­")
            progress.setRange(0, 100)
            progress.setValue(0)
            progress.setWindowModality(Qt.WindowModality.WindowModal)
            progress.setMinimumWidth(300)
            progress.show()
            
            # å…ˆè½¬æ¢æ–‡ä»¶
            text = self.text_processor.convert_to_txt(self.current_file)
            if not text:
                QMessageBox.warning(self, "é”™è¯¯", "æ–‡ä»¶è½¬æ¢å¤±è´¥")
                progress.hide()
                return
            
            # å¤„ç†æ–‡æœ¬
            segments = self.text_processor.process_text_with_progress(
                text, 
                settings,
                lambda p: progress.setValue(p)
            )
            

            if not segments:
                QMessageBox.warning(self, "é”™è¯¯", "æ–‡æœ¬å¤„ç†å¤±è´¥ï¼šæœªèƒ½è·å–æœ‰æ•ˆå†…å®¹")
                progress.hide()
                return
            
            # ä¿å­˜åŸå§‹æ–‡ä»¶åˆ°Workingç›®å½•
            os.makedirs(working_dir, exist_ok=True)
            original_file_path = os.path.join(working_dir, os.path.basename(self.current_file))
            if os.path.abspath(self.current_file) != os.path.abspath(original_file_path):
                shutil.copy2(self.current_file, original_file_path)
            
            # ä¿å­˜å¤„ç†ç»“æœåˆ°Workingç›®å½•
            os.makedirs(processed_dir, exist_ok=True)
            
            # ä¿å­˜åˆ†æ®µæ–‡æœ¬
            with open(segments_file, 'w', encoding='utf-8') as f:
                for i, segment in enumerate(segments, 1):
                    f.write(f"[æ®µè½ {i}]\n{segment}\n\n")
            
            # éšè—è¿›åº¦æ¡
            progress.hide()
            
            # æ ¹æ®æ¨¡å¼åˆ‡æ¢åˆ°ç›¸åº”çš„å¤„ç†é¡µé¢
            if settings['is_multi_speaker']:
                # ğŸ”§ åœ¨è¿›å…¥è§’è‰²ç»Ÿè®¡å‰è¯¢é—®ç”¨æˆ·æ˜¯å¦éœ€è¦è§’è‰²ç»Ÿè®¡
                reply = QMessageBox.question(
                    self, 
                    "è§’è‰²ç»Ÿè®¡é€‰æ‹©", 
                    "æ˜¯å¦éœ€è¦è¿›è¡Œè§’è‰²ç»Ÿè®¡ï¼Ÿ\n\n"
                    "â€¢ ç‚¹å‡»ã€Œæ˜¯ã€ï¼šè¿›å…¥è§’è‰²ç»Ÿè®¡é¡µé¢ï¼Œè‡ªåŠ¨åˆ†ææ–‡æœ¬ä¸­çš„è§’è‰²\n"
                    "â€¢ ç‚¹å‡»ã€Œå¦ã€ï¼šè·³è¿‡è§’è‰²ç»Ÿè®¡ï¼Œç›´æ¥è¿›å…¥å¤šäººå¯¹è¯å¤„ç†é¡µé¢",
                    QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                    QMessageBox.StandardButton.Yes  # é»˜è®¤é€‰æ‹©"æ˜¯"
                )
                
                if reply == QMessageBox.StandardButton.Yes:
                    # ç”¨æˆ·é€‰æ‹©è¿›è¡Œè§’è‰²ç»Ÿè®¡
                    self.show_multi_speaker_preprocess_page(segments)
                else:
                    # ç”¨æˆ·é€‰æ‹©è·³è¿‡è§’è‰²ç»Ÿè®¡ï¼Œç›´æ¥è¿›å…¥å¯¹è¯å¤„ç†é¡µé¢
                    # åˆ›å»ºç©ºçš„è§’è‰²åˆ—è¡¨ï¼Œç›´æ¥è¿›å…¥æ®µè½å¤„ç†é¡µé¢
                    self.show_segment_process_page(segments, [])
            else:
                self.show_single_speaker_page(segments)
        
        except Exception as e:
            # ç¡®ä¿è¿›åº¦æ¡è¢«å…³é—­
            if 'progress' in locals():
                progress.hide()
            QMessageBox.critical(self, "é”™è¯¯", f"å¤„ç†æ–‡æœ¬æ—¶å‡ºé”™ï¼š{str(e)}")
    
    def has_multiple_speakers(self, segments: List[str]) -> bool:
        """æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªè¯´è¯è€…"""
        speaker_set = set()
        for _, _, speaker in segments:
            if speaker:
                speaker_set.add(speaker)
        return len(speaker_set) > 1
    
    def show_single_speaker_page(self, segments: List[str]):
        """æ˜¾ç¤ºå•äººæœ—è¯»é¡µé¢"""
        single_speaker_page = QWidget()
        layout = QVBoxLayout(single_speaker_page)
        single_speaker_card = FirstSegmentCard(segments, self.preset_manager, self.preset_order_manager)
        layout.addWidget(single_speaker_card)
        
        # æ·»åŠ é¡µé¢åˆ°å †å çª—å£
        self.stack.addWidget(single_speaker_page)
        self.stack.setCurrentWidget(single_speaker_page)
        
        # éšè—é¡¶éƒ¨æŒ‰é’®
        self.add_preset_btn.setVisible(False)
        self.process_btn.setVisible(False)
        self.cache_status_btn.setVisible(False)
        self.clear_cache_btn.setVisible(False)
        
    def show_auto_generate_page(self, segments: List[str], settings: dict):
        """æ˜¾ç¤ºè‡ªåŠ¨ç”Ÿæˆé¡µé¢"""
        auto_generate_page = QWidget()
        layout = QVBoxLayout(auto_generate_page)
        auto_generate_card = AutoGenerateCard(segments, settings)
        layout.addWidget(auto_generate_card)
        
        # æ·»åŠ é¡µé¢åˆ°å †å çª—å£
        self.stack.addWidget(auto_generate_page)
        self.stack.setCurrentWidget(auto_generate_page)
        
        # éšè—é¡¶éƒ¨æŒ‰é’®
        self.add_preset_btn.setVisible(False)
        self.process_btn.setVisible(False)
        self.cache_status_btn.setVisible(False)
        self.clear_cache_btn.setVisible(False)

    def load_presets(self):
        """æ›´æ–°é¢„è®¾åˆ—è¡¨"""
        # è·å–å½“å‰æ˜¾ç¤ºçš„å¡ç‰‡
        current_widget = self.stack.currentWidget()
        
        # å¦‚æœæ˜¯FirstSegmentCardï¼Œæ›´æ–°å…¶é¢„è®¾åˆ—è¡¨
        if isinstance(current_widget, FirstSegmentCard):
            current_widget.load_presets()

    def show_multi_speaker_preprocess_page(self, segments: List[str]):
        """æ˜¾ç¤ºå¤šäººæœ—è¯»é¢„å¤„ç†é¡µé¢"""
        multi_speaker_preprocess_page = QWidget()
        layout = QVBoxLayout(multi_speaker_preprocess_page)
        
        # åˆ›å»ºå¡ç‰‡å‰å…ˆè®¾ç½®å¥½å¸ƒå±€
        multi_speaker_preprocess_page.setLayout(layout)
        
        # åˆ›å»ºå¡ç‰‡
        multi_speaker_preprocess_card = MultiSpeakerPreprocessCard(segments, self.preset_manager, self.preset_order_manager)
        layout.addWidget(multi_speaker_preprocess_card)
        
        # æ·»åŠ é¡µé¢åˆ°å †å çª—å£
        self.stack.addWidget(multi_speaker_preprocess_page)
        self.stack.setCurrentWidget(multi_speaker_preprocess_page)
        
        # éšè—é¡¶éƒ¨æŒ‰é’®
        self.add_preset_btn.setVisible(False)
        self.process_btn.setVisible(False)
        self.cache_status_btn.setVisible(False)
        self.clear_cache_btn.setVisible(False)

    def show_multi_speaker_page(self, processed_segments: List[str]):
        """æ˜¾ç¤ºå¤šäººæœ—è¯»é¡µé¢"""
        # TODO: å®ç°å¤šäººæœ—è¯»é¡µé¢
        pass

    def show_segment_process_page(self, segments: List[str], characters: List[Tuple[str, str]]):
        """æ˜¾ç¤ºåˆ†æ®µå¤„ç†é¡µé¢"""
        segment_process_page = QWidget()
        layout = QVBoxLayout(segment_process_page)
        
        segment_process_card = SegmentProcessCard(segments, characters, self.preset_manager, self.preset_order_manager)
        layout.addWidget(segment_process_card)
        
        # æ·»åŠ é¡µé¢åˆ°å †å çª—å£
        self.stack.addWidget(segment_process_page)
        self.stack.setCurrentWidget(segment_process_page)
        
        # éšè—é¡¶éƒ¨æŒ‰é’®
        self.add_preset_btn.setVisible(False)
        self.process_btn.setVisible(False)
        self.cache_status_btn.setVisible(False)
        self.clear_cache_btn.setVisible(False)
    
    def show_cache_status(self):
        """æ˜¾ç¤ºæ¨¡å‹ç¼“å­˜çŠ¶æ€"""
        try:
            cache = get_global_model_cache()
            cache_info = cache.get_cache_info()
            
            # æ„å»ºçŠ¶æ€ä¿¡æ¯
            status_text = f"""æ¨¡å‹ç¼“å­˜çŠ¶æ€ï¼š

ç¼“å­˜ç»Ÿè®¡ï¼š
â€¢ å·²ç¼“å­˜æ¨¡å‹æ•°: {cache_info['cached_models']}/{cache_info['max_models']}
â€¢ ç¼“å­˜å‘½ä¸­æ¬¡æ•°: {cache_info['cache_hits']}
â€¢ ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°: {cache_info['cache_misses']}
â€¢ ç¼“å­˜å‘½ä¸­ç‡: {cache_info['hit_rate']:.1%}

å·²ç¼“å­˜çš„æ¨¡å‹ï¼š"""
            
            if cache_info['cached_model_list']:
                for i, model_info in enumerate(cache_info['cached_model_list'], 1):
                    status_text += f"""
{i}. {model_info['key']}
   GPT: {model_info['gpt_model']}
   SoVITS: {model_info['sovits_model']}
   æœ€åä½¿ç”¨: {model_info['last_used']}"""
            else:
                status_text += "\nâ€¢ æ— å·²ç¼“å­˜çš„æ¨¡å‹"
            
            # æ·»åŠ å†…å­˜ä½¿ç”¨å»ºè®®
            status_text += f"""

å†…å­˜ä½¿ç”¨å»ºè®®ï¼š
â€¢ æ¨èæœ€å¤§ç¼“å­˜æ¨¡å‹æ•°: 3ä¸ªï¼ˆé€‚ç”¨äº16GBå†…å­˜ï¼‰
â€¢ å½“å‰è®¾ç½®: {cache_info['max_models']}ä¸ª
â€¢ æ¯ä¸ªæ¨¡å‹å¤§çº¦å ç”¨2-4GBå†…å­˜"""
            
            QMessageBox.information(self, "æ¨¡å‹ç¼“å­˜çŠ¶æ€", status_text)
            
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥: {str(e)}")
    
    def clear_model_cache(self):
        """æ¸…ç©ºæ¨¡å‹ç¼“å­˜"""
        try:
            # ç¡®è®¤æ“ä½œ
            reply = QMessageBox.question(
                self, 
                "ç¡®è®¤æ¸…ç©ºç¼“å­˜", 
                "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¨¡å‹ç¼“å­˜å—ï¼Ÿ\n\nè¿™å°†é‡Šæ”¾å†…å­˜ï¼Œä½†ä¸‹æ¬¡ä½¿ç”¨æ¨¡å‹æ—¶éœ€è¦é‡æ–°åŠ è½½ã€‚",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                QMessageBox.StandardButton.No
            )
            
            if reply == QMessageBox.StandardButton.Yes:
                cache = get_global_model_cache()
                
                # è·å–æ¸…ç©ºå‰çš„çŠ¶æ€
                before_info = cache.get_cache_info()
                
                # æ¸…ç©ºç¼“å­˜
                cache.clear_cache()
                
                # æ˜¾ç¤ºç»“æœ
                QMessageBox.information(
                    self, 
                    "ç¼“å­˜å·²æ¸…ç©º", 
                    f"å·²æˆåŠŸæ¸…ç©ºæ¨¡å‹ç¼“å­˜ï¼\n\næ¸…ç©ºå‰: {before_info['cached_models']}ä¸ªæ¨¡å‹\næ¸…ç©ºå: 0ä¸ªæ¨¡å‹\n\nå†…å­˜å·²é‡Šæ”¾ï¼Œä¸‹æ¬¡ä½¿ç”¨æ¨¡å‹æ—¶å°†é‡æ–°åŠ è½½ã€‚"
                )
                
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"æ¸…ç©ºç¼“å­˜å¤±è´¥: {str(e)}")

class MultiSpeakerPreprocessCard(Card):
    def __init__(self, segments: List[str], preset_manager: PresetManager, preset_order_manager: PresetOrderManager = None, parent=None):
        super().__init__(parent)
        self.segments = segments
        
        self.preset_manager = preset_manager
        self.preset_order_manager = preset_order_manager
        self.character_stats = {}  # å­˜å‚¨è§’è‰²ç»Ÿè®¡ä¿¡æ¯
        self.nickname_candidates = {}  # å­˜å‚¨å°åå€™é€‰
        self.surname_contexts = {}  # å­˜å‚¨å§“æ°ä¸Šä¸‹æ–‡
        self.character_preset_mapping = {}  # å­˜å‚¨è§’è‰²-é¢„è®¾æ˜ å°„
        self.preset_history = {}  # å­˜å‚¨é¢„è®¾çš„å†å²è®°å½•
        self.configured_characters = {}  # å­˜å‚¨å·²å®Œæˆé…ç½®çš„è§’è‰²ä¿¡æ¯
        self.characters = []  # å­˜å‚¨æ‰€æœ‰æ£€æµ‹åˆ°çš„è§’è‰²åˆ—è¡¨
        
        # ä»é¢„è®¾ç®¡ç†å™¨åŠ è½½å†å²é¢„è®¾ä¿¡æ¯
        self.load_preset_history()
        
        # ä¿å­˜è¿‡æ»¤è‹±æ–‡åçš„å…¨æ–‡
        self.filtered_text = "\n".join(segments)
        
        self.init_ui()
        self.analyze_text()

    def init_ui(self):
        # è®¡ç®—åŸºç¡€å­—ä½“å¤§å°å’Œæ§ä»¶é«˜åº¦
        parent_window = self.window()
        if parent_window:
            base_font_size = max(12, int(parent_window.width() / 72))
            control_height = int(parent_window.height() * 0.04)
        else:
            base_font_size = 12
            control_height = 30

        layout = QVBoxLayout(self)
        layout.setSpacing(20)
        
        # é¡¶éƒ¨å¯¼èˆª
        nav_layout = QHBoxLayout()
        back_btn = QPushButton("è¿”å›")
        back_btn.clicked.connect(self.go_back)
        back_btn.setMinimumHeight(control_height)
        back_btn.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        nav_layout.addWidget(back_btn)
        nav_layout.addStretch()
        
        # è§’è‰²ç»Ÿè®¡åŒºåŸŸ
        character_group = QGroupBox("è§’è‰²ç»Ÿè®¡")
        character_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(control_height * 0.5)}px;
                margin-top: {int(control_height * 0.35)}px;
            }}
        """)
        character_layout = QVBoxLayout(character_group)
        
        # è§’è‰²åˆ—è¡¨
        self.character_table = QTableWidget()
        self.character_table.setColumnCount(5)
        self.character_table.setHorizontalHeaderLabels(["è§’è‰²åç§°", "å‡ºç°æ¬¡æ•°", "é…éŸ³é¢„è®¾", "æ˜¯å¦å¤„ç†", "é…ç½®å®Œæˆ"])
        self.character_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.character_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.character_table.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.character_table.itemSelectionChanged.connect(self.on_character_selected)
        # ğŸ”§ è®¾ç½®åˆé€‚çš„è¡Œé«˜ï¼ˆ40pxï¼‰ä¸å…¶ä»–è¡¨æ ¼ä¿æŒä¸€è‡´
        self.character_table.verticalHeader().setDefaultSectionSize(40)
        # è®¾ç½®è¡¨æ ¼é«˜åº¦ä»¥æ˜¾ç¤ºçº¦10è¡Œå†…å®¹
        self.character_table.setMinimumHeight(int(control_height * 10))
        self.character_table.setStyleSheet(f"""
            QTableWidget {{
                font-size: {int(base_font_size * 0.9)}px;
            }}
            QHeaderView::section {{
                font-size: {int(base_font_size * 0.9)}px;
                padding: 4px;
            }}
        """)
        character_layout.addWidget(self.character_table)
        
        # è§’è‰²å¤„ç†åŒºåŸŸ
        process_group = QGroupBox("è§’è‰²å¤„ç†")
        process_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(control_height * 0.5)}px;
                margin-top: {int(control_height * 0.35)}px;
            }}
        """)
        process_layout = QVBoxLayout(process_group)
        
        # å½“å‰å¤„ç†çš„è§’è‰²ä¿¡æ¯
        current_char_layout = QGridLayout()
        
        # è§’è‰²åç§°
        self.current_char_label = QLabel("å½“å‰è§’è‰²ï¼š")
        self.current_char_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.current_char_name = QLabel("")
        self.current_char_name.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        current_char_layout.addWidget(self.current_char_label, 0, 0)
        current_char_layout.addWidget(self.current_char_name, 0, 1)
        
        # é¢„è®¾ä¿¡æ¯è¾“å…¥åŒºåŸŸ
        self.preset_info_group = QGroupBox("é¢„è®¾ä¿¡æ¯")
        self.preset_info_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(control_height * 0.5)}px;
                margin-top: {int(control_height * 0.35)}px;
            }}
        """)
        preset_info_layout = QGridLayout(self.preset_info_group)
        
        # å§“æ°è¾“å…¥
        surname_label = QLabel("å§“æ°ï¼š")
        surname_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.surname_input = QLineEdit()
        self.surname_input.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.surname_input.setMinimumHeight(control_height)
        preset_info_layout.addWidget(surname_label, 0, 0)
        preset_info_layout.addWidget(self.surname_input, 0, 1)
        
        # å§“åè¾“å…¥
        name_label = QLabel("å§“åï¼š")
        name_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.name_input = QLineEdit()
        self.name_input.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.name_input.setMinimumHeight(control_height)
        preset_info_layout.addWidget(name_label, 1, 0)
        preset_info_layout.addWidget(self.name_input, 1, 1)
        
        # å°åè¾“å…¥
        nickname_label = QLabel("å°åï¼š")
        nickname_label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.nickname_input = QLineEdit()
        self.nickname_input.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.nickname_input.setMinimumHeight(control_height)
        preset_info_layout.addWidget(nickname_label, 2, 0)
        preset_info_layout.addWidget(self.nickname_input, 2, 1)
        
        # æ·»åŠ ä¸€é”®å¡«å…¥è§’è‰²æŒ‰é’®
        self.auto_fill_btn = QPushButton("ä¸€é”®å¡«å…¥è§’è‰²")
        self.auto_fill_btn.setStyleSheet(f"""
            QPushButton {{
                font-size: {int(base_font_size * 0.9)}px;
                background-color: #E8F4F8;
                border: 1px solid #B8D4E3;
                border-radius: 4px;
                padding: 4px;
            }}
            QPushButton:hover {{
                background-color: #D0E8F2;
            }}
        """)
        self.auto_fill_btn.setMinimumHeight(control_height)
        self.auto_fill_btn.clicked.connect(self.auto_fill_character_info)
        preset_info_layout.addWidget(self.auto_fill_btn, 3, 0, 1, 2)
        
        # æ·»åŠ ä¿å­˜æŒ‰é’®
        self.save_preset_btn = QPushButton("ä¿å­˜é¢„è®¾ä¿¡æ¯")
        self.save_preset_btn.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        self.save_preset_btn.setMinimumHeight(control_height)
        self.save_preset_btn.clicked.connect(self.save_preset_info)
        preset_info_layout.addWidget(self.save_preset_btn, 4, 0, 1, 2)
        
        # æ·»åŠ é¢„è®¾ä¿¡æ¯ç»„åˆ°å¤„ç†åŒºåŸŸ
        process_layout.addLayout(current_char_layout)
        process_layout.addWidget(self.preset_info_group)
        
        # å°åè¯†åˆ«åŒºåŸŸ
        nickname_group = QGroupBox("å°åè¯†åˆ«")
        nickname_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(control_height * 0.5)}px;
                margin-top: {int(control_height * 0.35)}px;
            }}
        """)
        nickname_layout = QVBoxLayout(nickname_group)
        self.nickname_table = QTableWidget()
        self.nickname_table.setColumnCount(3)
        self.nickname_table.setHorizontalHeaderLabels(["å¯èƒ½çš„å°å", "å‡ºç°æ¬¡æ•°", "æ˜¯å¦ä½¿ç”¨"])
        self.nickname_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        # ğŸ”§ è®¾ç½®åˆé€‚çš„è¡Œé«˜ï¼ˆ40pxï¼‰
        self.nickname_table.verticalHeader().setDefaultSectionSize(40)
        # è®¾ç½®è¡¨æ ¼é«˜åº¦ä»¥æ˜¾ç¤ºçº¦10è¡Œå†…å®¹
        self.nickname_table.setMinimumHeight(int(control_height * 10))
        self.nickname_table.setStyleSheet(f"""
            QTableWidget {{
                font-size: {int(base_font_size * 0.9)}px;
            }}
            QHeaderView::section {{
                font-size: {int(base_font_size * 0.9)}px;
                padding: 4px;
            }}
        """)
        nickname_layout.addWidget(self.nickname_table)
        
        # å§“æ°å¤„ç†åŒºåŸŸ
        surname_group = QGroupBox("å§“æ°å¤„ç†")
        surname_group.setStyleSheet(f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(control_height * 0.5)}px;
                margin-top: {int(control_height * 0.35)}px;
            }}
        """)
        surname_layout = QVBoxLayout(surname_group)
        self.surname_table = QTableWidget()
        self.surname_table.setColumnCount(4)
        self.surname_table.setHorizontalHeaderLabels(["åŒ…å«å§“æ°çš„è¯", "å‡ºç°æ¬¡æ•°", "ä¸Šä¸‹æ–‡ç¤ºä¾‹", "æ˜¯å¦æ›¿æ¢"])
        self.surname_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        # ğŸ”§ è®¾ç½®åˆé€‚çš„è¡Œé«˜ï¼ˆ40pxï¼‰
        self.surname_table.verticalHeader().setDefaultSectionSize(40)
        # è®¾ç½®è¡¨æ ¼é«˜åº¦ä»¥æ˜¾ç¤ºçº¦10è¡Œå†…å®¹
        self.surname_table.setMinimumHeight(int(control_height * 10))
        self.surname_table.setStyleSheet(f"""
            QTableWidget {{
                font-size: {int(base_font_size * 0.9)}px;
            }}
            QHeaderView::section {{
                font-size: {int(base_font_size * 0.9)}px;
                padding: 4px;
            }}
        """)
        surname_layout.addWidget(self.surname_table)
        
        # å¼€å§‹å¤„ç†æŒ‰é’®
        button_layout = QHBoxLayout()
        self.process_btn = QPushButton("å¼€å§‹å¤„ç†")
        self.process_btn.setObjectName("generate_btn")
        self.process_btn.clicked.connect(self.process_characters)
        self.process_btn.setMinimumHeight(int(control_height * 1.25))
        self.process_btn.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        button_layout.addStretch()
        button_layout.addWidget(self.process_btn)
        
        # æ·»åŠ æ‰€æœ‰ç»„ä»¶åˆ°ä¸»å¸ƒå±€
        layout.addLayout(nav_layout)
        layout.addWidget(character_group)
        layout.addWidget(process_group)
        layout.addWidget(nickname_group)
        layout.addWidget(surname_group)
        layout.addLayout(button_layout)
        
        # åˆå§‹æ—¶éšè—é¢„è®¾ä¿¡æ¯è¾“å…¥åŒºåŸŸ
        self.preset_info_group.hide()
        
        # æ·»åŠ çª—å£å¤§å°å˜åŒ–äº‹ä»¶å¤„ç†
        self.resizeEvent = self.on_resize

    def on_resize(self, event):
        """å¤„ç†çª—å£å¤§å°å˜åŒ–äº‹ä»¶"""
        # æ›´æ–°åŸºç¡€å­—ä½“å¤§å°å’Œæ§ä»¶é«˜åº¦
        parent_window = self.window()
        if parent_window:
            base_font_size = max(12, int(parent_window.width() / 72))
            control_height = int(parent_window.height() * 0.04)
        else:
            base_font_size = 12
            control_height = 30
        
        # æ›´æ–°æ‰€æœ‰æ ‡ç­¾çš„å­—ä½“å¤§å°
        for label in self.findChildren(QLabel):
            label.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        
        # æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„å­—ä½“å¤§å°å’Œé«˜åº¦
        for widget in self.findChildren(QLineEdit):
            widget.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
            widget.setMinimumHeight(control_height)
        
        # æ›´æ–°æ‰€æœ‰æŒ‰é’®çš„å­—ä½“å¤§å°å’Œé«˜åº¦
        for button in self.findChildren(QPushButton):
            if button.objectName() == "generate_btn":
                button.setMinimumHeight(int(control_height * 1.25))
            else:
                button.setMinimumHeight(control_height)
            button.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        
        # æ›´æ–°æ‰€æœ‰è¡¨æ ¼çš„å­—ä½“å¤§å°
        table_style = f"""
            QTableWidget {{
                font-size: {int(base_font_size * 0.9)}px;
            }}
            QHeaderView::section {{
                font-size: {int(base_font_size * 0.9)}px;
                padding: 4px;
            }}
        """
        self.character_table.setStyleSheet(table_style)
        self.nickname_table.setStyleSheet(table_style)
        self.surname_table.setStyleSheet(table_style)
        
        # æ›´æ–°æ‰€æœ‰ç»„æ¡†çš„æ ·å¼
        group_style = f"""
            QGroupBox {{
                font-size: {int(base_font_size * 1.1)}px;
                font-weight: 500;
                padding-top: {int(control_height * 0.5)}px;
                margin-top: {int(control_height * 0.35)}px;
            }}
        """
        for group in self.findChildren(QGroupBox):
            group.setStyleSheet(group_style)
        
        # ğŸ”§ æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰æ¡†çš„æ ·å¼ - ä¿æŒä¸å…¨å±€æ ·å¼ä¸€è‡´
        for combo in self.findChildren(QComboBox):
            combo.setStyleSheet(f"""
                                 QComboBox {{
                     background-color: #faf6f1 !important;
                     border: 1px solid #d4c5b9 !important;
                     border-radius: 6px !important;
                     padding-left: 8px !important;
                     padding-right: 8px !important;
                     padding-top: 1px !important;    /* æœ€å°åŒ–å‚ç›´å†…è¾¹è· */
                     padding-bottom: 1px !important; /* æœ€å°åŒ–å‚ç›´å†…è¾¹è· */
                     height: 18px !important;
                     max-height: 18px !important;
                     min-height: 18px !important;
                     color: #4a5568 !important;
                     font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif !important;
                     font-size: {int(base_font_size * 0.9)}px !important;
                     text-align: left !important;
                     line-height: 20px !important;
                 }}
                QComboBox:hover {{
                    background-color: #f7f3ee !important;
                    border-color: #C67A8A !important;
                }}
                QComboBox:focus {{
                    border-color: #C67A8A !important;
                    outline: none !important;
                }}
                                 QComboBox::drop-down {{
                     border: none !important;
                     background: transparent !important;
                     width: 0px !important;  /* å®Œå…¨éšè—ä¸‹æ‹‰æŒ‰é’®åŒºåŸŸ */
                 }}
                 QComboBox::down-arrow {{
                     image: none !important;
                     border: none !important;
                     background: transparent !important;
                     width: 0 !important;
                     height: 0 !important;
                 }}
            """)
        
        # æ›´æ–°æ‰€æœ‰å¤é€‰æ¡†çš„å­—ä½“å¤§å°
        for checkbox in self.findChildren(QCheckBox):
            checkbox.setStyleSheet(f"font-size: {int(base_font_size * 0.9)}px;")
        
        super().resizeEvent(event)

    def update_character_table(self):
        """æ›´æ–°è§’è‰²è¡¨æ ¼"""
        try:
            # æ¸…ç©ºè¡¨æ ¼
            self.character_table.clearContents()
            self.character_table.setRowCount(0)
            
            # æ·»åŠ è§’è‰²åˆ°è¡¨æ ¼
            for i, character in enumerate(self.characters):
    
                self.character_table.insertRow(i)
                
                # è§’è‰²åç§°
                item = QTableWidgetItem(character)
                item.setFlags(item.flags() & ~Qt.ItemFlag.ItemIsEditable)  # è®¾ç½®ä¸ºåªè¯»
                self.character_table.setItem(i, 0, item)
                
                # è§’è‰²é¢‘ç‡
                freq_item = QTableWidgetItem(f"{self.char_stats[character]}")
                freq_item.setFlags(freq_item.flags() & ~Qt.ItemFlag.ItemIsEditable)  # è®¾ç½®ä¸ºåªè¯»
                self.character_table.setItem(i, 1, freq_item)
                
                                # ğŸ”§ é¢„è®¾é€‰æ‹© - ä½¿ç”¨å±…ä¸­å®¹å™¨
                preset_combo = QComboBox()
                
                # ä»é¢„è®¾ç®¡ç†å™¨è·å–æ‰€æœ‰é¢„è®¾
                all_presets = [preset[0] for preset in self.preset_manager.get_all_presets()]
        
                # ğŸ”§ ä½¿ç”¨é¢„è®¾æ’åºç®¡ç†å™¨è¿›è¡Œæ’åº
                if self.preset_order_manager:
                    sorted_presets = self.preset_order_manager.sort_presets(all_presets)
                else:
                    sorted_presets = all_presets
                
                # å…ˆæ·»åŠ æ’åºåçš„é¢„è®¾åˆ—è¡¨
                for preset_name in sorted_presets:
                    preset_combo.addItem(preset_name)
                
                # åŒæ—¶ä¹ŸåŠ è½½å†å²é¢„è®¾è®°å½•
                for preset_name in self.preset_history.keys():
                    if preset_name not in all_presets:
                        preset_combo.addItem(preset_name)
                        
                # è®¾ç½®é»˜è®¤é€‰æ‹©ï¼ˆå¦‚æœå¡èŠ™å¡åœ¨åˆ—è¡¨ä¸­åˆ™é€‰æ‹©å®ƒï¼Œå¦åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ªï¼‰
                default_index = preset_combo.findText("ğŸ”®å¡èŠ™å¡")
                if default_index == -1:  # å¦‚æœæ²¡æ‰¾åˆ°å¡èŠ™å¡ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–ç‰ˆæœ¬
                    default_index = preset_combo.findText("å¡èŠ™å¡")
                if default_index >= 0:
                    preset_combo.setCurrentIndex(default_index)
                elif preset_combo.count() > 0:
                    preset_combo.setCurrentIndex(0)  # é€‰æ‹©ç¬¬ä¸€ä¸ªé¢„è®¾
                        
                # å¦‚æœè§’è‰²å·²æœ‰é…ç½®ï¼Œé€‰æ‹©å¯¹åº”çš„é¢„è®¾
                if character in self.configured_characters:
                    preset_name = self.configured_characters[character]["preset_name"]
                    index = preset_combo.findText(preset_name)
                    if index >= 0:
                        preset_combo.setCurrentIndex(index)

                # ğŸ”§ ä¸ºä¸‹æ‹‰æ¡†åˆ›å»ºå±…ä¸­å®¹å™¨ - è°ƒæ•´å‚ç›´å¯¹é½
                preset_widget = QWidget()
                preset_widget.setObjectName("cell-widget-container")  # è®¾ç½®å¯¹è±¡åç”¨äºæ ·å¼
                preset_layout = QHBoxLayout(preset_widget)
                preset_layout.addWidget(preset_combo)
                preset_layout.setContentsMargins(4, 0, 4, 10)  # è°ƒæ•´è¾¹è·é€‚åº”40pxè¡Œé«˜
                preset_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
                preset_widget.setMaximumHeight(40)  # é™åˆ¶å®¹å™¨é«˜åº¦ä¸è¡¨æ ¼è¡Œé«˜ä¸€è‡´
                    
                self.character_table.setCellWidget(i, 2, preset_widget)
                preset_combo.currentIndexChanged.connect(lambda idx, row=i: self.on_preset_selected(row, idx))
                
                # ğŸ”§ æ˜¯å¦å¤„ç†å¤é€‰æ¡† - ä½¿ç”¨å±…ä¸­å®¹å™¨
                process_check = QCheckBox()
                process_check.setChecked(False)  # é»˜è®¤ä¸å‹¾é€‰
                
                process_widget = QWidget()
                process_widget.setObjectName("cell-widget-container")  # è®¾ç½®å¯¹è±¡åç”¨äºæ ·å¼
                process_layout = QHBoxLayout(process_widget)
                process_layout.addWidget(process_check)
                process_layout.setContentsMargins(8, 4, 8, 4)
                process_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
                
                self.character_table.setCellWidget(i, 3, process_widget)
                
                # ğŸ”§ é…ç½®å®Œæˆå¤é€‰æ¡† - ä½¿ç”¨å±…ä¸­å®¹å™¨
                config_check = QCheckBox()
                # å¦‚æœè§’è‰²å·²æœ‰é…ç½®ï¼Œå‹¾é€‰é…ç½®å®Œæˆ
                is_configured = character in self.configured_characters
                config_check.setChecked(is_configured)
                
                config_widget = QWidget()
                config_widget.setObjectName("cell-widget-container")  # è®¾ç½®å¯¹è±¡åç”¨äºæ ·å¼
                config_layout = QHBoxLayout(config_widget)
                config_layout.addWidget(config_check)
                config_layout.setContentsMargins(8, 4, 8, 4)
                config_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
                
                self.character_table.setCellWidget(i, 4, config_widget)
                
                # å…³è”ä¿¡å· - ä½¿ç”¨è§’è‰²åç§°è€Œéè¡Œç´¢å¼•ä½œä¸ºæ ‡è¯†ç¬¦
                config_check.stateChanged.connect(lambda state, char=character: self.on_config_completed(char, state))
                
            
            # è°ƒæ•´åˆ—å®½
            self.character_table.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
            self.character_table.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
            self.character_table.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeMode.Stretch)
            self.character_table.horizontalHeader().setSectionResizeMode(3, QHeaderView.ResizeMode.ResizeToContents)
            self.character_table.horizontalHeader().setSectionResizeMode(4, QHeaderView.ResizeMode.ResizeToContents)
            
            # å¦‚æœè¡¨æ ¼æœ‰æ•°æ®ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€è¡Œ
            if self.character_table.rowCount() > 0:
                self.character_table.selectRow(0)
                
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"æ›´æ–°è§’è‰²è¡¨æ ¼æ—¶å‡ºé”™ï¼š{str(e)}")

    def on_preset_selected(self, row: int, preset_index: int):
        """å½“é€‰æ‹©é¢„è®¾æ—¶çš„å¤„ç†"""
        character = self.character_table.item(row, 0).text()
        # ğŸ”§ ä»å®¹å™¨ä¸­è·å–ä¸‹æ‹‰æ¡†
        preset_widget = self.character_table.cellWidget(row, 2)
        preset_combo = preset_widget.layout().itemAt(0).widget()
        preset_name = preset_combo.currentText()
        
        # æ›´æ–°è§’è‰²-é¢„è®¾æ˜ å°„
        self.character_preset_mapping[character] = preset_name
        
        # å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¿™ä¸€è¡Œï¼Œæ›´æ–°é¢„è®¾ä¿¡æ¯æ˜¾ç¤º
        if self.character_table.currentRow() == row:
            # ä¿å­˜å½“å‰é¢„è®¾ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            current_widget = self.character_table.cellWidget(self.character_table.currentRow(), 2)
            current_combo = current_widget.layout().itemAt(0).widget()
            current_preset = current_combo.currentText()
            if current_preset != "å¡èŠ™å¡" and current_preset != preset_name:
                # åªæœ‰å½“è¾“å…¥æ¡†ä¸ä¸ºç©ºæ—¶æ‰ä¿å­˜
                if any([self.surname_input.text().strip(), 
                       self.name_input.text().strip(), 
                       self.nickname_input.text().strip()]):
                    self.preset_history[current_preset] = {
                        "surname": self.surname_input.text().strip(),
                        "name": self.name_input.text().strip(),
                        "nickname": self.nickname_input.text().strip()
                    }
            
            # æ›´æ–°æ˜¾ç¤ºæ–°é¢„è®¾çš„ä¿¡æ¯
            self.update_preset_info_display(preset_name)

    def update_preset_info_display(self, preset_name: str):
        """æ›´æ–°é¢„è®¾ä¿¡æ¯æ˜¾ç¤º"""
        # å¦‚æœæ˜¯é»˜è®¤é¢„è®¾ï¼Œéšè—è¾“å…¥æ¡†å¹¶æ¸…ç©º
        if preset_name == "å¡èŠ™å¡":
            self.preset_info_group.hide()
            self.surname_input.clear()
            self.name_input.clear()
            self.nickname_input.clear()
            return
            
        # æ˜¾ç¤ºé¢„è®¾ä¿¡æ¯è¾“å…¥åŒºåŸŸ
        self.preset_info_group.show()
            
        # ä»é¢„è®¾ç®¡ç†å™¨è·å–é¢„è®¾ä¿¡æ¯
        preset_info = self.preset_manager.get_preset(preset_name)
        if preset_info and preset_info[0].get('character_info'):
            character_info = preset_info[0]['character_info']
            self.surname_input.setText(character_info.get('surname', ''))
            self.name_input.setText(character_info.get('name', ''))
            self.nickname_input.setText(character_info.get('nickname', ''))
        else:
            # å¦‚æœé¢„è®¾ä¸­æ²¡æœ‰ä¿å­˜çš„ä¿¡æ¯ï¼Œæ¸…ç©ºè¾“å…¥æ¡†
            self.surname_input.clear()
            self.name_input.clear()
            self.nickname_input.clear()

    def process_characters(self):
        """å¤„ç†è§’è‰²æ›¿æ¢å¹¶ç”Ÿæˆæœ€ç»ˆæ–‡æœ¬"""
        try:
            # è·å–éœ€è¦å¤„ç†çš„è§’è‰²
            characters_to_process = []
            unconfigured_characters = []
            
            for i in range(self.character_table.rowCount()):
                char = self.character_table.item(i, 0).text()
                process_widget = self.character_table.cellWidget(i, 3)
                
                # ğŸ”§ ä»å®¹å™¨ä¸­è·å–å¤é€‰æ¡†
                process_check = process_widget.layout().itemAt(0).widget()
                
                # æ£€æŸ¥æ˜¯å¦å‹¾é€‰äº†"æ˜¯å¦å¤„ç†"
                if process_check.isChecked():
                    # æ£€æŸ¥æ˜¯å¦å·²é…ç½®å®Œæˆ
                    if char in self.configured_characters:
                        # ä½¿ç”¨å·²ä¿å­˜çš„é…ç½®
                        characters_to_process.append((char, self.configured_characters[char]["preset_name"]))
                    else:
                        # è®°å½•æœªé…ç½®çš„è§’è‰²
                        unconfigured_characters.append(char)
            
            # å¦‚æœæœ‰æœªé…ç½®çš„è§’è‰²ï¼Œæç¤ºç”¨æˆ·
            if unconfigured_characters:
                error_message = "ä»¥ä¸‹è§’è‰²è¢«å‹¾é€‰å¤„ç†ä½†æœªå®Œæˆé…ç½®ï¼š\n" + "\n".join(unconfigured_characters)
                QMessageBox.warning(self, "æœªå®Œæˆé…ç½®", error_message)
                return
            
            if not characters_to_process:
                # ä¸å†å¼ºåˆ¶è¦æ±‚é€‰æ‹©è§’è‰²ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬
                processed_text = self.filtered_text
                
                # å°è¯•ä»MainWindowè·å–å½“å‰å¤„ç†çš„æ–‡ä»¶å
                main_window = self.window()
                source_filename = "unknown"
                
                if hasattr(main_window, 'current_file') and main_window.current_file:
                    # ä»MainWindowè·å–å½“å‰æ–‡ä»¶è·¯å¾„
                    source_filename = os.path.splitext(os.path.basename(main_window.current_file))[0]
                
                # ä¿å­˜å¤„ç†åçš„æ–‡æœ¬åˆ°Workingç›®å½•
                working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
                processed_dir = os.path.join(working_dir, f"{source_filename}_processed")
                os.makedirs(processed_dir, exist_ok=True)
                
                # è·å–ä¸»é¡µé¢è®¾ç½®çš„åˆ†æ®µå­—æ•°
                parent = self.window()
                if isinstance(parent, MainWindow):
                    batch_size = parent.batch_spin.value()
                else:
                    batch_size = 5000  # é»˜è®¤å€¼
                
                # æŒ‰å­—æ•°åˆ†æ®µ
                processed_segments = []
                current_text = processed_text
                while current_text:
                    # æ‰¾åˆ°åˆé€‚çš„åˆ†æ®µç‚¹
                    if len(current_text) <= batch_size:
                        processed_segments.append(current_text)
                        break
                        
                    # è®¡ç®—å½“å‰æ‰¹æ¬¡çš„ç†æƒ³ç»“æŸä½ç½®
                    ideal_end = min(batch_size, len(current_text))
                    
                    # é¦–å…ˆåœ¨ç†æƒ³ä½ç½®é™„è¿‘æŸ¥æ‰¾ä¸­æ–‡å¥å·'ã€‚'å’Œä¸­æ–‡å³å¼•å·'\u201d'ç»„åˆ
                    best_break_pos = ideal_end - 1  # é»˜è®¤ä¸ºæ‰¹æ¬¡å¤§å°ä½ç½®
                    
                    # å‘åæŸ¥æ‰¾æœ€è¿‘çš„åˆé€‚æ–­ç‚¹
                    for i in range(ideal_end - 1, 0, -1):
                        if i + 1 < len(current_text) and current_text[i] == 'ã€‚' and current_text[i + 1] == '\u201d':
                            best_break_pos = i + 1  # åŒ…å«ä¸­æ–‡å¥å·å’Œå³å¼•å·
                            break
                    
                    # å¦‚æœæ²¡æ‰¾åˆ°ä¸­æ–‡å¥å·å’Œå³å¼•å·ç»„åˆï¼Œåˆ™å°è¯•åªæŸ¥æ‰¾ä¸­æ–‡å¥å·
                    if best_break_pos == ideal_end - 1:
                        for i in range(ideal_end - 1, 0, -1):
                            if current_text[i] == 'ã€‚':
                                best_break_pos = i  # åŒ…å«ä¸­æ–‡å¥å·
                                break
                    
                    # è·å–åˆ†æ®µï¼ˆåŒ…å«æ–­ç‚¹å­—ç¬¦ï¼‰
                    processed_segments.append(current_text[:best_break_pos + 1])
                    current_text = current_text[best_break_pos + 1:]
                
                # ä¿å­˜åˆ†æ®µæ–‡æœ¬
                segments_file = os.path.join(processed_dir, "segments.txt")
                with open(segments_file, 'w', encoding='utf-8') as f:
                    for i, segment in enumerate(processed_segments, 1):
                        f.write(f"[æ®µè½ {i}]\n{segment}\n\n")
                
                QMessageBox.information(self, "æˆåŠŸ", f"æ–‡æœ¬å¤„ç†å®Œæˆï¼\næœªé€‰æ‹©è§’è‰²ï¼Œå°†ä½¿ç”¨åŸå§‹æ–‡æœ¬ã€‚\nè¾“å‡ºç›®å½•ï¼š{processed_dir}")
                
                # è¿›å…¥åˆ†æ®µå¤„ç†é¡µé¢ - ä½¿ç”¨ç©ºè§’è‰²åˆ—è¡¨
                parent = self.window()
                if isinstance(parent, MainWindow):
                    parent.show_segment_process_page(processed_segments, [])
                return
            
            # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
            
            
            # åˆ›å»ºè¿›åº¦æ¡
            progress = QProgressDialog("æ­£åœ¨å¤„ç†æ–‡æœ¬...", "å–æ¶ˆ", 0, len(characters_to_process), self)
            progress.setWindowTitle("å¤„ç†ä¸­")
            progress.setWindowModality(Qt.WindowModality.WindowModal)
            progress.setMinimumWidth(300)
            progress.show()
            
            # åˆ›å»ºå¤„ç†åçš„æ–‡æœ¬å‰¯æœ¬
            processed_text = self.filtered_text
            
            # åˆ›å»ºæ›¿æ¢æ˜ å°„è¡¨
            name_replacements = {}        # è§’è‰²åæ›¿æ¢æ˜ å°„
            surname_replacements = {}     # å§“æ°è¯æ›¿æ¢æ˜ å°„
            nickname_replacements = {}    # å°åæ›¿æ¢æ˜ å°„
            
            # ä»å·²é…ç½®çš„è§’è‰²ä¿¡æ¯ä¸­æ”¶é›†æ‰€æœ‰æ›¿æ¢å†…å®¹
            for idx, (character, preset_name) in enumerate(characters_to_process):
                if progress.wasCanceled():
                    return
                    
                progress.setValue(idx)
                progress.setLabelText(f"å¤„ç†è§’è‰²ï¼š{character}")
                
                # ä»å·²ä¿å­˜çš„é…ç½®ä¸­è·å–æ›¿æ¢ä¿¡æ¯
                char_config = self.configured_characters[character]
                
                # 1. è®°å½•è§’è‰²åæ›¿æ¢
                name_replacements[character] = char_config["new_name"]
                
                # 2. è®°å½•å§“æ°ç›¸å…³è¯æ›¿æ¢
                for old_word, new_word in char_config["surname_replacements"].items():
                    surname_replacements[old_word] = (new_word, character)
                
                # 3. è®°å½•å°åæ›¿æ¢
                for old_nickname, new_nickname in char_config["nickname_replacements"].items():
                    nickname_replacements[old_nickname] = new_nickname
            
            # è°ƒè¯•è¾“å‡º
            
            
            # ç¬¬äºŒé˜¶æ®µï¼šæŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºè¿›è¡Œæ›¿æ¢
            # 1. å…ˆæ›¿æ¢è§’è‰²åï¼ˆä»æœ€é•¿åˆ°æœ€çŸ­ï¼Œé¿å…éƒ¨åˆ†åŒ¹é…é—®é¢˜ï¼‰
            progress.setLabelText(f"æ›¿æ¢è§’è‰²å...")
            sorted_characters = sorted(name_replacements.keys(), key=len, reverse=True)
            for char in sorted_characters:
                processed_text = processed_text.replace(char, name_replacements[char])
                
            # 2. å†æ›¿æ¢å§“æ°ç›¸å…³è¯ï¼ˆæŒ‰ç…§é•¿åº¦æ’åºï¼‰
            progress.setLabelText(f"æ›¿æ¢å§“æ°ç›¸å…³è¯...")
            sorted_surnames = sorted(surname_replacements.keys(), key=len, reverse=True)
            for surname in sorted_surnames:
                new_surname, _ = surname_replacements[surname]
                processed_text = processed_text.replace(surname, new_surname)
                
            # 3. æœ€åæ›¿æ¢å°åï¼ˆæŒ‰ç…§é•¿åº¦æ’åºï¼‰
            progress.setLabelText(f"æ›¿æ¢å°å...")
            sorted_nicknames = sorted(nickname_replacements.keys(), key=len, reverse=True)
            for nickname in sorted_nicknames:
                processed_text = processed_text.replace(nickname, nickname_replacements[nickname])
            
            progress.setValue(len(characters_to_process))
            
            # å°è¯•ä»MainWindowè·å–å½“å‰å¤„ç†çš„æ–‡ä»¶å
            main_window = self.window()
            source_filename = "unknown"
            
            if hasattr(main_window, 'current_file') and main_window.current_file:
                # ä»MainWindowè·å–å½“å‰æ–‡ä»¶è·¯å¾„
                source_filename = os.path.splitext(os.path.basename(main_window.current_file))[0]
            
            # ä¿å­˜å¤„ç†åçš„æ–‡æœ¬åˆ°Workingç›®å½•
            working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
            processed_dir = os.path.join(working_dir, f"{source_filename}_processed")
            os.makedirs(processed_dir, exist_ok=True)
            
            # è·å–ä¸»é¡µé¢è®¾ç½®çš„åˆ†æ®µå­—æ•°
            parent = self.window()
            if isinstance(parent, MainWindow):
                batch_size = parent.batch_spin.value()
            else:
                batch_size = 5000  # é»˜è®¤å€¼
            
            # æŒ‰å­—æ•°åˆ†æ®µ
            processed_segments = []
            current_text = processed_text
            while current_text:
                # æ‰¾åˆ°åˆé€‚çš„åˆ†æ®µç‚¹
                if len(current_text) <= batch_size:
                    processed_segments.append(current_text)
                    break
                        
                # è®¡ç®—å½“å‰æ‰¹æ¬¡çš„ç†æƒ³ç»“æŸä½ç½®
                ideal_end = min(batch_size, len(current_text))
                
                # é¦–å…ˆåœ¨ç†æƒ³ä½ç½®é™„è¿‘æŸ¥æ‰¾ä¸­æ–‡å¥å·'ã€‚'å’Œä¸­æ–‡å³å¼•å·'\u201d'ç»„åˆ
                best_break_pos = ideal_end - 1  # é»˜è®¤ä¸ºæ‰¹æ¬¡å¤§å°ä½ç½®
                
                # å‘åæŸ¥æ‰¾æœ€è¿‘çš„åˆé€‚æ–­ç‚¹
                for i in range(ideal_end - 1, 0, -1):
                    if i + 1 < len(current_text) and current_text[i] == 'ã€‚' and current_text[i + 1] == '\u201d':
                        best_break_pos = i + 1  # åŒ…å«ä¸­æ–‡å¥å·å’Œå³å¼•å·
                        break
                
                # å¦‚æœæ²¡æ‰¾åˆ°ä¸­æ–‡å¥å·å’Œå³å¼•å·ç»„åˆï¼Œåˆ™å°è¯•åªæŸ¥æ‰¾ä¸­æ–‡å¥å·
                if best_break_pos == ideal_end - 1:
                    for i in range(ideal_end - 1, 0, -1):
                        if current_text[i] == 'ã€‚':
                            best_break_pos = i  # åŒ…å«ä¸­æ–‡å¥å·
                            break
                
                # è·å–åˆ†æ®µï¼ˆåŒ…å«æ–­ç‚¹å­—ç¬¦ï¼‰
                processed_segments.append(current_text[:best_break_pos + 1])
                current_text = current_text[best_break_pos + 1:]
            
            # ä¿å­˜åˆ†æ®µæ–‡æœ¬
            segments_file = os.path.join(processed_dir, "segments.txt")
            with open(segments_file, 'w', encoding='utf-8') as f:
                for i, segment in enumerate(processed_segments, 1):
                    f.write(f"[æ®µè½ {i}]\n{segment}\n\n")
            
            QMessageBox.information(self, "æˆåŠŸ", f"æ–‡æœ¬å¤„ç†å®Œæˆï¼\nè¾“å‡ºç›®å½•ï¼š{processed_dir}")
            
            # è¿›å…¥åˆ†æ®µå¤„ç†é¡µé¢
            parent = self.window()
            if isinstance(parent, MainWindow):
                parent.show_segment_process_page(processed_segments, characters_to_process)
            
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"å¤„ç†è§’è‰²æ—¶å‡ºé”™ï¼š{str(e)}")

    def on_character_selected(self):
        """å½“é€‰æ‹©è§’è‰²æ—¶çš„å¤„ç†"""
        selected_items = self.character_table.selectedItems()
        if not selected_items:
            return
            
        row = selected_items[0].row()
        character = self.character_table.item(row, 0).text()
        self.current_char_name.setText(character)
        
        # ğŸ”§ è·å–å½“å‰é€‰ä¸­çš„é¢„è®¾ - ä»å®¹å™¨ä¸­è·å–ä¸‹æ‹‰æ¡†
        preset_widget = self.character_table.cellWidget(row, 2)
        preset_combo = preset_widget.layout().itemAt(0).widget()
        preset_name = preset_combo.currentText()
        
        # æ›´æ–°é¢„è®¾ä¿¡æ¯æ˜¾ç¤º
        self.update_preset_info_display(preset_name)
        
        # åˆ†æè¯¥è§’è‰²çš„å°åå’Œå§“æ°
        self.analyze_nicknames(character)
        
        # è·å–é¢„è®¾ä¿¡æ¯
        preset_info = None
        if preset_name:
            preset_data = self.preset_manager.get_preset(preset_name)
            if preset_data and preset_data[0].get('character_info'):
                preset_info = preset_data[0]['character_info']
        
        # ä½¿ç”¨é¢„è®¾ä¸­çš„å§“æ°ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™é»˜è®¤ä½¿ç”¨è§’è‰²åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦
        char_surname = ""
        if len(character) >= 1:
            char_surname = character[0]  # ç¬¬ä¸€ä¸ªå­—ä½œä¸ºå§“æ°

        
        if char_surname:
            self.analyze_surname_contexts(char_surname)

    def analyze_text(self):
        """åˆ†ææ–‡æœ¬ï¼Œç»Ÿè®¡2-4å­—è¯çš„å‡ºç°é¢‘ç‡ï¼Œå¹¶æ£€æµ‹å¯èƒ½çš„å®Œæ•´äººå"""
        # ä½¿ç”¨è¿‡æ»¤åçš„å…¨æ–‡
        full_text = self.filtered_text
        
        # ä½¿ç”¨jiebaåˆ†è¯
        words = jieba.lcut(full_text)
        
        # ç»Ÿè®¡2-4å­—è¯çš„é¢‘ç‡
        word_stats = {}
        
        # å…ˆå¤„ç†æ™®é€šåˆ†è¯ç»“æœ
        for word in words:
            # åªç»Ÿè®¡2-4å­—çš„è¯
            if 2 <= len(word) <= 4:
                # æ£€æŸ¥è¯æ˜¯å¦åªåŒ…å«ä¸­æ–‡å­—ç¬¦
                if all('\u4e00' <= char <= '\u9fff' for char in word):
                    word_stats[word] = word_stats.get(word, 0) + 1
        
        # å¯»æ‰¾å¯èƒ½çš„å®Œæ•´äººåï¼ˆè¿ç»­å‡ºç°çš„è¯ç»„åˆï¼‰
        for i in range(len(words) - 1):
            # æ£€æŸ¥ç›¸é‚»çš„ä¸¤ä¸ªè¯æ˜¯å¦éƒ½æ˜¯ä¸­æ–‡ä¸”é•¿åº¦åˆé€‚
            if (1 <= len(words[i]) <= 2 and 1 <= len(words[i+1]) <= 2 and
                all('\u4e00' <= char <= '\u9fff' for char in words[i]) and
                all('\u4e00' <= char <= '\u9fff' for char in words[i+1])):
                # ç»„åˆç›¸é‚»çš„ä¸¤ä¸ªè¯ï¼Œä¾‹å¦‚"å…«é‡"+"ç¥å­"="å…«é‡ç¥å­"
                combined_name = words[i] + words[i+1]
                # åªå¤„ç†2-4å­—çš„ç»„åˆå
                if 2 <= len(combined_name) <= 4:
                    # åœ¨åŸæ–‡ä¸­æœç´¢è¿™ä¸ªç»„åˆåå‡ºç°çš„æ¬¡æ•°
                    count = full_text.count(combined_name)
                    if count > 0:
                        word_stats[combined_name] = count
        
        # æŒ‰å‡ºç°é¢‘ç‡æ’åºï¼Œå–å‰1000ä½
        sorted_words = sorted(word_stats.items(), key=lambda x: x[1], reverse=True)[:1000]
        self.character_stats = dict(sorted_words)
        
        # æå–æ£€æµ‹åˆ°çš„æ‰€æœ‰è§’è‰²å
        self.characters = list(self.character_stats.keys())

        
        # åŒæ—¶åˆå§‹åŒ–è§’è‰²çš„ç»Ÿè®¡æ•°æ®
        self.char_stats = self.character_stats
        
        # æ›´æ–°è§’è‰²åˆ—è¡¨æ˜¾ç¤º
        self.update_character_table()
        
        # å¦‚æœæœ‰è§’è‰²ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
        if self.character_table.rowCount() > 0:
            self.character_table.selectRow(0)
            self.on_character_selected()

    def analyze_nicknames(self, character: str):
        """åˆ†æè§’è‰²å¯èƒ½çš„å°åï¼Œç»Ÿè®¡ï¼š
        1. äºŒå­—å è¯ï¼ˆå¦‚"éœ„éœ„"ï¼‰
        2. ä¸¤å­—è¯ä¸­åŒ…å«è§’è‰²åå…¶ä¸­ä¸€ä¸ªå­—ï¼ˆä¸è€ƒè™‘å§“æ°ï¼‰
        3. è§’è‰²é™¤å§“æ°å¤–çš„å®Œæ•´åå­—ï¼ˆå¦‚"ç‹è‹±å"ä¸­çš„"è‹±å"ï¼‰
        4. "å°"å­—åŠ å®Œæ•´åå­—ä¸­çš„å…¶ä¸­ä¸€ä¸ªå­—ï¼ˆå¦‚"å°å"ï¼‰
        """
        # æ¸…ç©ºå½“å‰è§’è‰²çš„å°åå€™é€‰åˆ—è¡¨ï¼Œè€Œä¸æ˜¯æ¸…ç©ºæ‰€æœ‰å€™é€‰
        if character in self.nickname_candidates:
            self.nickname_candidates[character] = {}
        else:
            self.nickname_candidates[character] = {}
        
        # åœ¨æ–‡æœ¬ä¸­æŸ¥æ‰¾å¯èƒ½çš„å°å
        full_text = self.filtered_text
        
        # ä½¿ç”¨jiebaåˆ†è¯
        words = jieba.lcut(full_text)
        
        # æå–è§’è‰²å§“æ°å’Œåå­—éƒ¨åˆ†
        surname = ""
        name_part = ""
        if len(character) >= 2:
            surname = character[0]  # å‡è®¾ç¬¬ä¸€ä¸ªå­—æ˜¯å§“
            name_part = character[1:]  # é™¤å§“æ°å¤–çš„éƒ¨åˆ†
        
        # æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„å°å
        for word in words:
            should_add = False
            
            # 1. å¤„ç†äºŒå­—å è¯
            if len(word) == 2 and word[0] == word[1]:
                should_add = True
                
            # 2. æ£€æŸ¥ä¸¤å­—è¯ä¸­æ˜¯å¦åŒ…å«è§’è‰²åå…¶ä¸­ä¸€ä¸ªå­—ï¼ˆä¸è€ƒè™‘å§“æ°ï¼‰
            elif len(word) == 2:
                chars_in_name = sum(1 for c in word if c in character[1:])
                if chars_in_name == 1:  # åªåŒ…å«åå­—ä¸­çš„ä¸€ä¸ªå­—
                    should_add = True
            
            # 3. æ£€æŸ¥æ˜¯å¦æ˜¯è§’è‰²é™¤å§“æ°å¤–çš„å®Œæ•´åå­—
            if len(name_part) >= 2 and word == name_part:
                should_add = True
                
            # 4. æ£€æŸ¥æ˜¯å¦æ˜¯"å°"å­—åŠ è§’è‰²åä¸­çš„ä¸€ä¸ªå­—
            if len(word) == 2 and word[0] == "å°" and word[1] in character:
                should_add = True
            
            if should_add:
                if word in self.nickname_candidates[character]:
                    self.nickname_candidates[character][word] += 1
                else:
                    self.nickname_candidates[character][word] = 1
        
        # æ›´æ–°å°åè¡¨æ ¼
        self.update_nickname_table()
    
    def update_nickname_table(self):
        """æ›´æ–°å°åè¡¨æ ¼"""
        # è·å–å½“å‰é€‰ä¸­çš„è§’è‰²
        selected_items = self.character_table.selectedItems()
        if not selected_items:
            return
            
        row = selected_items[0].row()
        character = self.character_table.item(row, 0).text()
        
        # å¦‚æœè§’è‰²æ²¡æœ‰å°åå€™é€‰åˆ—è¡¨ï¼Œåˆ™æ¸…ç©ºè¡¨æ ¼
        if character not in self.nickname_candidates:
            self.nickname_table.setRowCount(0)
            return
            
        # æŒ‰å‡ºç°é¢‘ç‡æ’åº
        sorted_nicknames = sorted(self.nickname_candidates[character].items(), key=lambda x: x[1], reverse=True)
        
        # è®¾ç½®è¡¨æ ¼è¡Œæ•°
        self.nickname_table.setRowCount(len(sorted_nicknames))
        
        # å¡«å……æ•°æ®
        for i, (nickname, count) in enumerate(sorted_nicknames):
            # å°å
            name_item = QTableWidgetItem(nickname)
            name_item.setFlags(name_item.flags() & ~Qt.ItemFlag.ItemIsEditable)
            self.nickname_table.setItem(i, 0, name_item)
            
            # å‡ºç°æ¬¡æ•°
            count_item = QTableWidgetItem(str(count))
            count_item.setFlags(count_item.flags() & ~Qt.ItemFlag.ItemIsEditable)
            self.nickname_table.setItem(i, 1, count_item)
            
            # ğŸ”§ ä½¿ç”¨å¤é€‰æ¡† - ä½¿ç”¨å±…ä¸­å®¹å™¨
            use_check = QCheckBox()
            
            use_widget = QWidget()
            use_widget.setObjectName("cell-widget-container")  # è®¾ç½®å¯¹è±¡åç”¨äºæ ·å¼
            use_layout = QHBoxLayout(use_widget)
            use_layout.addWidget(use_check)
            use_layout.setContentsMargins(8, 4, 8, 4)
            use_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
            
            self.nickname_table.setCellWidget(i, 2, use_widget)
    
    def analyze_surname_contexts(self, surname: str):
        """åˆ†æå§“æ°ç›¸å…³çš„è¯ï¼Œç›´æ¥æŸ¥æ‰¾å§“æ°åè·Ÿéšçš„å­—ç¬¦ï¼Œç»„æˆäºŒå­—è¯"""

        self.surname_contexts = {}  # æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œæ”¹ä¸ºå­—å…¸ç»“æ„{è¯: (é¢‘ç‡, ä¸Šä¸‹æ–‡)}
        
        # ç›´æ¥åœ¨æ–‡æœ¬ä¸­æŸ¥æ‰¾å§“æ°åè·Ÿéšçš„å­—ç¬¦
        full_text = self.filtered_text
        
        # éå†æ–‡æœ¬ï¼ŒæŸ¥æ‰¾å§“æ°å‡ºç°çš„ä½ç½®
        for i in range(len(full_text) - 1):
            # æ‰¾åˆ°å§“æ°
            if full_text[i] == surname:
                # è·å–å§“æ°åé¢çš„ä¸€ä¸ªå­—ç¬¦
                next_char = full_text[i + 1]
                # æ£€æŸ¥æ˜¯å¦æ˜¯ä¸­æ–‡å­—ç¬¦
                if '\u4e00' <= next_char <= '\u9fff':
                    # ç»„æˆäºŒå­—è¯
                    two_char_word = surname + next_char
                    
                    # è·å–ä¸Šä¸‹æ–‡ï¼ˆå‰åäº”ä¸ªå­—ï¼‰
                    context_start = max(0, i - 5)
                    context_end = min(len(full_text), i + 7)  # äºŒå­—è¯åŠ å‰åå…±äº”ä¸ªå­—
                    context = full_text[context_start:context_end]
                    
                    # ç»Ÿè®¡é¢‘ç‡å’Œä¿å­˜ä¸Šä¸‹æ–‡
                    if two_char_word in self.surname_contexts:
                        count, _ = self.surname_contexts[two_char_word]
                        self.surname_contexts[two_char_word] = (count + 1, context)
                    else:
                        self.surname_contexts[two_char_word] = (1, context)
        
        # æ›´æ–°å§“æ°è¡¨æ ¼
        self.update_surname_table()
    
    def update_surname_table(self):
        """æ›´æ–°å§“æ°è¡¨æ ¼"""
        # æŒ‰å‡ºç°é¢‘ç‡æ’åº
        sorted_contexts = sorted(self.surname_contexts.items(), key=lambda x: x[1][0], reverse=True)
        
        # è®¾ç½®è¡¨æ ¼åˆ—æ•°
        self.surname_table.setColumnCount(4)
        self.surname_table.setHorizontalHeaderLabels(["åŒ…å«å§“æ°çš„è¯", "å‡ºç°æ¬¡æ•°", "ä¸Šä¸‹æ–‡ç¤ºä¾‹", "æ˜¯å¦æ›¿æ¢"])
        
        # è®¾ç½®è¡¨æ ¼è¡Œæ•°
        self.surname_table.setRowCount(len(sorted_contexts))
        
        # å¡«å……æ•°æ®
        for i, (context_word, (count, context_example)) in enumerate(sorted_contexts):
            # åŒ…å«å§“æ°çš„è¯
            context_item = QTableWidgetItem(context_word)
            context_item.setFlags(context_item.flags() & ~Qt.ItemFlag.ItemIsEditable)
            self.surname_table.setItem(i, 0, context_item)
            
            # å‡ºç°æ¬¡æ•°
            count_item = QTableWidgetItem(str(count))
            count_item.setFlags(count_item.flags() & ~Qt.ItemFlag.ItemIsEditable)
            self.surname_table.setItem(i, 1, count_item)
            
            # ä¸Šä¸‹æ–‡ç¤ºä¾‹
            context_example_item = QTableWidgetItem(context_example)
            context_example_item.setFlags(context_example_item.flags() & ~Qt.ItemFlag.ItemIsEditable)
            self.surname_table.setItem(i, 2, context_example_item)
            
            # ğŸ”§ æ›¿æ¢å¤é€‰æ¡†ï¼Œé»˜è®¤é€‰ä¸­ - ä½¿ç”¨å±…ä¸­å®¹å™¨
            replace_check = QCheckBox()
            replace_check.setChecked(True)  # é»˜è®¤é€‰ä¸­
            
            replace_widget = QWidget()
            replace_widget.setObjectName("cell-widget-container")  # è®¾ç½®å¯¹è±¡åç”¨äºæ ·å¼
            replace_layout = QHBoxLayout(replace_widget)
            replace_layout.addWidget(replace_check)
            replace_layout.setContentsMargins(8, 4, 8, 4)
            replace_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
            
            self.surname_table.setCellWidget(i, 3, replace_widget)
            
        # è°ƒæ•´åˆ—å®½
        self.surname_table.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeMode.ResizeToContents)
        self.surname_table.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
        self.surname_table.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeMode.Stretch)
        self.surname_table.horizontalHeader().setSectionResizeMode(3, QHeaderView.ResizeMode.ResizeToContents)
    
    def go_back(self):
        """è¿”å›ä¸»é¡µé¢"""
        reply = QMessageBox.question(
            self,
            "ç¡®è®¤è¿”å›",
            "ç¡®å®šè¦è¿”å›ä¸»é¡µé¢å—ï¼Ÿå·²åšçš„è§’è‰²å¤„ç†å°†ä¼šä¸¢å¤±ã€‚",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
            QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            parent = self.window()
            if isinstance(parent, MainWindow):
                parent.show_main_page()

    def load_preset_history(self):
        """ä»é¢„è®¾ç®¡ç†å™¨åŠ è½½å†å²é¢„è®¾ä¿¡æ¯"""
        try:
            
            self.preset_history = {}
            
            # ä»é¢„è®¾ç®¡ç†å™¨è·å–æ‰€æœ‰é¢„è®¾
            all_presets = self.preset_manager.get_all_presets()
            
            
            for preset_name, preset_info, _ in all_presets:
                
                # æ£€æŸ¥æ˜¯å¦æœ‰character_infoå­—æ®µ
                if 'character_info' in preset_info:
                    
                    self.preset_history[preset_name] = preset_info['character_info']
                else:
                    
                    # åˆ›å»ºé»˜è®¤çš„character_info
                    character_info = {
                        'surname': preset_name[0] if preset_name else '',
                        'name': preset_name,
                        'nickname': preset_name[:2] if len(preset_name) >= 2 else preset_name
                    }
                    self.preset_history[preset_name] = character_info
                    
                    # æ›´æ–°é¢„è®¾ä¿¡æ¯ï¼Œä¿å­˜å›é¢„è®¾ç®¡ç†å™¨
                    preset_info['character_info'] = character_info
                    settings = preset_info
                    audio_files = [(audio_path, emotion, text) for audio_info in preset_info.get('all_audio_info', []) 
                                  for audio_path, emotion, text in [(audio_info.get('path', ''), 
                                                                   audio_info.get('emotion', ''), 
                                                                   audio_info.get('text', ''))]]
                    self.preset_manager.add_preset(preset_name, settings, audio_files)
        except Exception as e:
            pass

    def save_preset_info(self):
        """ä¿å­˜å½“å‰è§’è‰²çš„é¢„è®¾ä¿¡æ¯"""
        current_row = self.character_table.currentRow()
        if current_row < 0:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²")
            return
            
        # ğŸ”§ è·å–å½“å‰é¢„è®¾åç§° - ä»å®¹å™¨ä¸­è·å–ä¸‹æ‹‰æ¡†
        preset_widget = self.character_table.cellWidget(current_row, 2)
        preset_combo = preset_widget.layout().itemAt(0).widget()
        preset_name = preset_combo.currentText()
        
        if preset_name == "å¡èŠ™å¡":
            QMessageBox.warning(self, "æç¤º", 'é»˜è®¤é¢„è®¾"å¡èŠ™å¡"æ— éœ€ä¿å­˜ä¿¡æ¯')
            return
            
        # è·å–è¾“å…¥çš„é¢„è®¾ä¿¡æ¯
        surname = self.surname_input.text().strip()
        name = self.name_input.text().strip()
        nickname = self.nickname_input.text().strip()
        
        # éªŒè¯è¾“å…¥
        if not all([surname, name, nickname]):
            QMessageBox.warning(self, "æç¤º", "è¯·å¡«å†™å®Œæ•´çš„é¢„è®¾ä¿¡æ¯ï¼ˆå§“æ°ã€å§“åã€å°åï¼‰")
            return
            
        # ä¿å­˜é¢„è®¾ä¿¡æ¯åˆ°æœ¬åœ°å˜é‡
        character_info = {
            "surname": surname,
            "name": name,
            "nickname": nickname
        }
        self.preset_history[preset_name] = character_info
        
        # è·å–é¢„è®¾çš„å®Œæ•´ä¿¡æ¯å¹¶æ›´æ–°
        preset_info = self.preset_manager.get_preset(preset_name)
        if preset_info:
            settings, audio_files = preset_info
            settings['character_info'] = character_info
            # æ›´æ–°é¢„è®¾
            self.preset_manager.add_preset(preset_name, settings, audio_files)
        
        QMessageBox.information(self, "æˆåŠŸ", "é¢„è®¾ä¿¡æ¯ä¿å­˜æˆåŠŸ")

    def auto_fill_character_info(self):
        """ä¸€é”®å¡«å…¥è§’è‰²ä¿¡æ¯"""
        current_row = self.character_table.currentRow()
        if current_row < 0:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²")
            return
            
        # è·å–å½“å‰è§’è‰²åç§°
        character = self.character_table.item(current_row, 0).text()
        
        if not character:
            QMessageBox.warning(self, "æç¤º", "æ— æ³•è·å–è§’è‰²åç§°")
            return
            
        # è‡ªåŠ¨å¡«å…¥ä¿¡æ¯ï¼šå§“æ°=è§’è‰²åé¦–å­—ï¼Œå…¨å=è§’è‰²åï¼Œå°å=è§’è‰²å
        if len(character) >= 1:
            surname = character[0]  # å§“æ°ä¸ºé¦–å­—
            full_name = character    # å…¨åä¸ºè§’è‰²å
            nickname = character     # å°åä¹Ÿä¸ºè§’è‰²å
            
            # å¡«å…¥è¾“å…¥æ¡†
            self.surname_input.setText(surname)
            self.name_input.setText(full_name)
            self.nickname_input.setText(nickname)
            
            QMessageBox.information(self, "å®Œæˆ", f"å·²è‡ªåŠ¨å¡«å…¥è§’è‰²ä¿¡æ¯ï¼š\nå§“æ°ï¼š{surname}\nå…¨åï¼š{full_name}\nå°åï¼š{nickname}\n\nè¯·æ£€æŸ¥ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼Œç„¶åç‚¹å‡»ä¿å­˜ã€‚")
        else:
            QMessageBox.warning(self, "é”™è¯¯", "è§’è‰²åç§°ä¸ºç©ºï¼Œæ— æ³•è‡ªåŠ¨å¡«å…¥")

    def on_config_completed(self, character, state):
        """å¤„ç†é…ç½®å®ŒæˆçŠ¶æ€å˜åŒ–"""
        try:

            
            # ç¡®ä¿å°†Qt.CheckStateè½¬æ¢ä¸ºå¸ƒå°”å€¼
            is_checked = False
            if isinstance(state, int):
                is_checked = state == 2  # Qt.CheckState.Checkedçš„å€¼æ˜¯2
            else:
                is_checked = bool(state)
                

            
            if is_checked:  # å¦‚æœå‹¾é€‰äº†é…ç½®å®Œæˆ
                success = self.save_character_config(character)
                
                if success:
                    QMessageBox.information(self, "æˆåŠŸ", f"å·²ä¿å­˜è§’è‰² {character} çš„é…ç½®ä¿¡æ¯")
                
                if not success:  # å¦‚æœä¿å­˜å¤±è´¥ï¼Œå–æ¶ˆå‹¾é€‰
                    # æŸ¥æ‰¾è§’è‰²æ‰€åœ¨çš„è¡Œ
                    row = -1
                    for i in range(self.character_table.rowCount()):
                        if self.character_table.item(i, 0) and self.character_table.item(i, 0).text() == character:
                            row = i
                            break
                    
                    if row >= 0:
                        config_check = self.character_table.cellWidget(row, 4)
                        if config_check:
                            # æ–­å¼€ä¿¡å·è¿æ¥ï¼Œé¿å…é€’å½’è°ƒç”¨
                            try:
                                config_check.stateChanged.disconnect()
                            except:
                                pass
                            
                            config_check.setChecked(False)
                            
                            # é‡æ–°è¿æ¥ä¿¡å·
                            config_check.stateChanged.connect(lambda s, c=character: self.on_config_completed(c, s))
            else:  # å¦‚æœå–æ¶ˆå‹¾é€‰äº†é…ç½®å®Œæˆ
                # ä»å·²é…ç½®è§’è‰²ä¸­ç§»é™¤
                if character in self.configured_characters:
                    
                    del self.configured_characters[character]
                    QMessageBox.information(self, "æç¤º", f"å·²åˆ é™¤è§’è‰² {character} çš„é…ç½®ä¿¡æ¯")
            

        except Exception as e:
            pass  # å¤„ç†é…ç½®å®ŒæˆçŠ¶æ€å˜åŒ–æ—¶å‡ºé”™
    
    def save_character_config(self, character):
        """ä¿å­˜è§’è‰²é…ç½®ä¿¡æ¯åˆ°configured_characterså­—å…¸ä¸­"""
        try:

            
            # è·å–å½“å‰è§’è‰²æ‰€é€‰çš„é¢„è®¾
            preset_name = None
            char_row = -1
            
            for i in range(self.character_table.rowCount()):
                if self.character_table.item(i, 0).text() == character:
                    # ğŸ”§ ä»å®¹å™¨ä¸­è·å–ä¸‹æ‹‰æ¡†
                    preset_widget = self.character_table.cellWidget(i, 2)
                    preset_combo = preset_widget.layout().itemAt(0).widget()
                    preset_name = preset_combo.currentText()
                    char_row = i
                    break
            
            if char_row == -1:
                return False
                
            if not preset_name or preset_name == "å¡èŠ™å¡":
                QMessageBox.warning(self, "æç¤º", f"è¯·ä¸ºè§’è‰² {character} é€‰æ‹©æœ‰æ•ˆçš„é¢„è®¾")
                # å°†é…ç½®å®Œæˆå¤é€‰æ¡†è®¾ç½®ä¸ºæœªå‹¾é€‰
                if char_row >= 0:
                    # ğŸ”§ ä»å®¹å™¨ä¸­è·å–å¤é€‰æ¡†
                    config_widget = self.character_table.cellWidget(char_row, 4)
                    config_check = config_widget.layout().itemAt(0).widget()
                    config_check.setChecked(False)
                return False
            
            if preset_name not in self.preset_history:
                # ä»é¢„è®¾ç®¡ç†å™¨ä¸­è·å–é¢„è®¾ä¿¡æ¯
                preset_info = self.preset_manager.get_preset(preset_name)
                if preset_info and preset_info[0]:
                    # æ£€æŸ¥æ˜¯å¦æœ‰character_infoå­—æ®µ
                    if 'character_info' in preset_info[0]:
                        self.preset_history[preset_name] = preset_info[0]['character_info']
                    else:
                        # å°è¯•æå–å§“ã€åã€å°åä¿¡æ¯
                        char_info = {}
                        if 'ref_text' in preset_info[0]:
                            # ç®€å•æå–é¢„è®¾åçš„ç¬¬ä¸€ä¸ªå­—ä½œä¸ºå§“
                            char_info['surname'] = preset_name[0] if preset_name else ''
                            # ä½¿ç”¨æ•´ä¸ªé¢„è®¾åä½œä¸ºå
                            char_info['name'] = preset_name
                            # å°åå¯ä»¥æ˜¯é¢„è®¾åçš„å‰ä¸¤ä¸ªå­—
                            char_info['nickname'] = preset_name[:2] if len(preset_name) >= 2 else preset_name
                            self.preset_history[preset_name] = char_info
                        else:
                            QMessageBox.warning(self, "æç¤º", f"è¯·å…ˆä¸ºé¢„è®¾ {preset_name} å¡«å†™å®Œæ•´çš„ä¿¡æ¯")
                            if char_row >= 0:
                                # ğŸ”§ ä»å®¹å™¨ä¸­è·å–å¤é€‰æ¡†
                                config_widget = self.character_table.cellWidget(char_row, 4)
                                config_check = config_widget.layout().itemAt(0).widget()
                                config_check.setChecked(False)
                            return False
                else:
                    QMessageBox.warning(self, "æç¤º", f"è¯·å…ˆä¸ºé¢„è®¾ {preset_name} å¡«å†™å®Œæ•´çš„ä¿¡æ¯")
                    # å°†é…ç½®å®Œæˆå¤é€‰æ¡†è®¾ç½®ä¸ºæœªå‹¾é€‰
                    if char_row >= 0:
                        # ğŸ”§ ä»å®¹å™¨ä¸­è·å–å¤é€‰æ¡†
                        config_widget = self.character_table.cellWidget(char_row, 4)
                        config_check = config_widget.layout().itemAt(0).widget()
                        config_check.setChecked(False)
                    return False
            
            # è·å–é¢„è®¾ä¿¡æ¯
            preset_info = self.preset_history[preset_name]
            
            # å¿…éœ€çš„é¢„è®¾å­—æ®µæ£€æŸ¥
            required_fields = ['surname', 'name', 'nickname']
            missing_fields = [field for field in required_fields if field not in preset_info or not preset_info[field]]
            if missing_fields:
                QMessageBox.warning(self, "æç¤º", f"é¢„è®¾ {preset_name} ç¼ºå°‘å¿…éœ€çš„ä¿¡æ¯: {', '.join(missing_fields)}")
                # å°†é…ç½®å®Œæˆå¤é€‰æ¡†è®¾ç½®ä¸ºæœªå‹¾é€‰
                if char_row >= 0:
                    config_check = self.character_table.cellWidget(char_row, 4)
                    config_check.setChecked(False)
                return False
            
            # ä¿å­˜å½“å‰é€‰ä¸­è¡Œï¼Œä»¥ä¾¿åé¢æ¢å¤
            current_row = self.character_table.currentRow()
            
            # é€‰ä¸­è¯¥è§’è‰²çš„è¡Œï¼Œä»¥ä¾¿æ˜¾ç¤ºå…¶ç›¸å…³ä¿¡æ¯
            self.character_table.selectRow(char_row)
            
            # ç­‰å¾…äº‹ä»¶å¾ªç¯å¤„ç†é€‰æ‹©å˜æ›´
            QApplication.processEvents()
            
            # æ”¶é›†å§“æ°ç›¸å…³è¯æ›¿æ¢
            surname_replacements = {}
            
            # è·å–é¢„è®¾ä¿¡æ¯ä¸­çš„å§“æ°
            preset_surname = preset_info.get("surname", "")
            
            # è·å–å½“å‰å¤„ç†çš„å§“æ°ï¼ˆå¦‚æœä½¿ç”¨äº†analyze_surname_contextsæ–¹æ³•ï¼Œå°±ç”¨é‚£ä¸ªå§“æ°ï¼‰
            current_surname = ""
            
            # å°è¯•ä»surname_tableä¸­è¯†åˆ«å½“å‰ä½¿ç”¨çš„å§“æ°
            if self.surname_table.rowCount() > 0:
                first_word = self.surname_table.item(0, 0).text()
                if first_word and len(first_word) > 0:
                    current_surname = first_word[0]  # å§“æ°è¯çš„ç¬¬ä¸€ä¸ªå­—ç¬¦
            
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™é»˜è®¤ä½¿ç”¨è§’è‰²åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦
            if not current_surname and len(character) > 0:
                current_surname = character[0]
                
            # ç¡®ä¿æœ‰é¢„è®¾å§“æ°
            if not preset_surname:
                pass  # é¢„è®¾æœªè®¾ç½®å§“æ°ï¼Œä¸è¿›è¡Œå§“æ°æ›¿æ¢
            
            try:
                
                for i in range(self.surname_table.rowCount()):
                    if i >= self.surname_table.rowCount():
                        break
                    
                    try:
                        word_item = self.surname_table.item(i, 0)
                        if not word_item:
                            
                            continue
                            
                        word = word_item.text()
                        replace_check = self.surname_table.cellWidget(i, 3)
                        
                        if not replace_check:
                            
                            continue
                            
                        # ç¡®ä¿è¿™ä¸ªå§“æ°è¯å±äºå½“å‰å¤„ç†çš„è§’è‰²
                        is_checked = replace_check.isChecked()
                        starts_with_surname = word.startswith(current_surname)
                        
                        
                        if is_checked and starts_with_surname and preset_surname and preset_surname != current_surname:
                            # å°†ä»¥å½“å‰å§“æ°å¼€å¤´çš„è¯æ›¿æ¢ä¸ºä»¥é¢„è®¾å§“æ°å¼€å¤´çš„è¯
                            new_word = preset_surname + word[1:]
                            surname_replacements[word] = new_word
                            
                    except Exception as e:
                        pass  # å¤„ç†å•è¡Œé”™è¯¯
            except Exception as e:
                pass  # æ”¶é›†å§“æ°ç›¸å…³è¯æ›¿æ¢æ—¶å‡ºé”™
                
            # æ”¶é›†å°åæ›¿æ¢
            nickname_replacements = {}
            
            try:
                
                for i in range(self.nickname_table.rowCount()):
                    if i >= self.nickname_table.rowCount():
                        break
                        
                    try:
                        nickname_item = self.nickname_table.item(i, 0)
                        if not nickname_item:
                            continue
                            
                        nickname = nickname_item.text()
                        use_check = self.nickname_table.cellWidget(i, 2)
                        
                        if not use_check:
                            continue
                        
                        is_checked = use_check.isChecked()
                        
                        if is_checked:
                            nickname_replacements[nickname] = preset_info["nickname"]
                            
                    except Exception as e:
                        pass  # å¤„ç†å•è¡Œé”™è¯¯
            except Exception as e:
                pass  # æ”¶é›†å°åæ›¿æ¢æ—¶å‡ºé”™
            
            # å­˜å‚¨é…ç½®ä¿¡æ¯
            self.configured_characters[character] = {
                "preset_name": preset_name,
                "new_name": preset_info["name"],
                "surname_replacements": surname_replacements,
                "nickname_replacements": nickname_replacements
            }
            
            # æ¢å¤åŸå§‹é€‰ä¸­è¡Œ
            if current_row >= 0:
                self.character_table.selectRow(current_row)
            
            return True
            
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"ä¿å­˜è§’è‰²é…ç½®æ—¶å‡ºé”™ï¼š{str(e)}")
            return False

class SegmentProcessCard(Card):
    def __init__(self, segments: List[str], characters: List[Tuple[str, str]], preset_manager: PresetManager, preset_order_manager: PresetOrderManager = None, parent=None):
        super().__init__(parent)
        self.segments = segments
        self.characters = {char: preset for char, preset in characters}
        self.preset_manager = preset_manager
        self.preset_order_manager = preset_order_manager
        self.current_segment_index = 0
        self.global_narration_preset = "ğŸ”®å¡èŠ™å¡"  # åˆå§‹åŒ–å…¨å±€æ—ç™½é¢„è®¾ä¸ºå¡èŠ™å¡
        self.global_narration_emotion = "å¹³é™"  # åˆå§‹åŒ–å…¨å±€æ—ç™½æƒ…ç»ª
        

       
        
        # ä»ä¸»çª—å£è·å–åˆ†æ®µå¤§å°
        parent_window = self.window()
        if isinstance(parent_window, MainWindow):
            self.batch_size = parent_window.batch_spin.value()
        else:
            self.batch_size = 5000  # é»˜è®¤å€¼
        
        # åˆå§‹åŒ–GPT-SoVITSå®ä¾‹
        self.gpt_sovits = GPTSoVITS()
        
        # åˆå§‹åŒ–å…¶ä»–å±æ€§
        self.segment_audio_states = {}  # å­˜å‚¨æ¯ä¸ªæ–‡æœ¬æ¡†çš„éŸ³é¢‘ç”ŸæˆçŠ¶æ€ {text_edit_id: (is_generated, audio_path)}
        self.player = QMediaPlayer()
        self.audio_output = QAudioOutput()
        self.player.setAudioOutput(self.audio_output)
        # è®¾ç½®é»˜è®¤éŸ³é‡
        self.current_volume = 70
        self.audio_output.setVolume(self.current_volume / 100.0)
        
        self.init_ui()
        self.process_current_segment()

    def _is_selector_widget(self, widget):
        """æ£€æŸ¥widgetæ˜¯å¦æ˜¯é€‰æ‹©å™¨ç»„ä»¶ï¼ˆQComboBoxæˆ–SwipeSelectorï¼‰"""
        return isinstance(widget, (QComboBox, SwipeSelector))

    def load_preset_emotion_history(self):
        """ä»é¢„è®¾ç®¡ç†å™¨åŠ è½½æƒ…ç»ªå†å²"""
        for preset_name, preset_info, _ in self.preset_manager.get_all_presets():
            if preset_info.get('emotion_history'):
                self.preset_emotion_history[preset_name] = preset_info['emotion_history']
    
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        layout = QVBoxLayout(self)
        layout.setSpacing(10)
        
        # å¯¼èˆªæŒ‰é’®å’ŒåŠŸèƒ½æŒ‰é’®
        nav_layout = QHBoxLayout()
        self.prev_btn = QPushButton("ä¸Šä¸€æ®µ")
        self.next_btn = QPushButton("ä¸‹ä¸€æ®µ")
        self.prev_btn.clicked.connect(self.prev_segment)
        self.next_btn.clicked.connect(self.next_segment)
        nav_layout.addWidget(self.prev_btn)
        self.segment_label = QLabel(f"ç¬¬ {self.current_segment_index + 1}/{len(self.segments)} æ®µ")
        nav_layout.addWidget(self.segment_label)
        nav_layout.addWidget(self.next_btn)
        
        # æ·»åŠ é¢„è®¾ç®¡ç†å’Œä¸€é”®ç”ŸæˆæŒ‰é’®
        preset_btn = QPushButton("é¢„è®¾ç®¡ç†")
        preset_btn.setStyleSheet("""
            QPushButton {
                background-color: #C67A8A;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B56A7A;
            }
        """)
        preset_btn.clicked.connect(self.show_preset_management)
        
        generate_all_btn = QPushButton("ä¸€é”®ç”Ÿæˆæ‰€æœ‰")
        generate_all_btn.setStyleSheet("""
            QPushButton {
                background-color: #C67A8A;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B56A7A;
            }
        """)
        generate_all_btn.clicked.connect(self.generate_all_audio)
        
        nav_layout.addStretch()
        nav_layout.addWidget(preset_btn)
        nav_layout.addWidget(generate_all_btn)
        
        # åˆ›å»ºæ»šåŠ¨åŒºåŸŸ
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        # ä¿æŒæ°´å¹³æ»šåŠ¨æ¡å§‹ç»ˆå…³é—­
        scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        # ä¿æŒå‚ç›´æ»šåŠ¨æ¡ï¼Œä½¿å…¶èƒ½å¤Ÿæ»šåŠ¨æŸ¥çœ‹æ‰€æœ‰æ–‡æœ¬æ¡†
        scroll_area.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAsNeeded)
        scroll_area.setStyleSheet("""
            QScrollArea {
                border: none;
                background-color: #faf6f1;
            }
            QScrollArea > QWidget > QWidget {
                background-color: #faf6f1;
            }
            QScrollBar:vertical {
                border: none;
                background: #f0f0f0;
                width: 10px;
                border-radius: 5px;
            }
            QScrollBar::handle:vertical {
                background: #C67A8A;
                border-radius: 5px;
                min-height: 20px;
            }
            QScrollBar::add-line:vertical,
            QScrollBar::sub-line:vertical {
                height: 0px;
            }
            QScrollBar::add-page:vertical,
            QScrollBar::sub-page:vertical {
                background: none;
            }
        """)
        
        # åˆ›å»ºå†…å®¹å®¹å™¨
        self.content_widget = QWidget()
        self.content_layout = QVBoxLayout(self.content_widget)
        self.content_layout.setSpacing(10)
        self.content_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        scroll_area.setWidget(self.content_widget)
        
        # æ·»åŠ ç»„ä»¶åˆ°ä¸»å¸ƒå±€
        layout.addLayout(nav_layout)
        layout.addWidget(scroll_area)
        
        # åº•éƒ¨å¯¼èˆªæŒ‰é’® - æ·»åŠ è¿™ä¸ªæ–°çš„éƒ¨åˆ†
        bottom_nav_layout = QHBoxLayout()
        self.bottom_prev_btn = QPushButton("ä¸Šä¸€æ®µ")
        self.bottom_next_btn = QPushButton("ä¸‹ä¸€æ®µ")
        self.bottom_prev_btn.clicked.connect(self.prev_segment)
        self.bottom_next_btn.clicked.connect(self.next_segment)
        bottom_nav_layout.addWidget(self.bottom_prev_btn)
        self.bottom_segment_label = QLabel(f"ç¬¬ {self.current_segment_index + 1}/{len(self.segments)} æ®µ")
        bottom_nav_layout.addWidget(self.bottom_segment_label)
        bottom_nav_layout.addWidget(self.bottom_next_btn)
        bottom_nav_layout.addStretch()
        
        # æ·»åŠ åˆå¹¶å½“å‰æ®µè½éŸ³é¢‘æŒ‰é’®
        merge_audio_btn = QPushButton("åˆå¹¶æœ¬æ®µè½éŸ³é¢‘")
        merge_audio_btn.setStyleSheet("""
            QPushButton {
                background-color: #C67A8A;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B56A7A;
            }
        """)
        merge_audio_btn.clicked.connect(self.merge_segment_audio)
        bottom_nav_layout.addWidget(merge_audio_btn)
        
        # æ·»åŠ åº•éƒ¨ä¸€é”®ç”Ÿæˆæ‰€æœ‰æŒ‰é’®
        bottom_generate_all_btn = QPushButton("ä¸€é”®ç”Ÿæˆæ‰€æœ‰")
        bottom_generate_all_btn.setStyleSheet("""
            QPushButton {
                background-color: #C67A8A;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B56A7A;
            }
        """)
        bottom_generate_all_btn.clicked.connect(self.generate_all_audio)
        bottom_nav_layout.addWidget(bottom_generate_all_btn)
        
        layout.addLayout(bottom_nav_layout)
        
        # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        self.update_nav_buttons()
    
    def process_current_segment(self):
        """å¤„ç†å½“å‰æ®µè½ï¼Œåˆ›å»ºUIç»„ä»¶"""
        # æ¸…ç©ºç°æœ‰å†…å®¹
        for i in reversed(range(self.content_layout.count())):
            widget = self.content_layout.itemAt(i).widget()
            if widget:
                widget.deleteLater()
        
        # æ·»åŠ å…¨å±€æ›¿æ¢åŠŸèƒ½
        replace_frame = QFrame()
        replace_frame.setStyleSheet("""
            QFrame {
                border: 1px solid #d4c5b9;
                border-radius: 8px;
                background-color: #ffffff;
                padding: 10px;
                margin: 5px;
            }
        """)
        replace_layout = QVBoxLayout(replace_frame)
        
        replace_header = QLabel("å…¨å±€æ–‡æœ¬æ›¿æ¢")
        replace_header.setStyleSheet("""
            font-size: 14px;
            font-weight: bold;
            color: #C67A8A;
        """)
        replace_layout.addWidget(replace_header)
        
        replace_input_layout = QHBoxLayout()
        search_label = QLabel("æŸ¥æ‰¾:")
        search_input = QLineEdit()
        replace_label = QLabel("æ›¿æ¢ä¸º:")
        replace_input = QLineEdit()
        replace_button = QPushButton("å…¨å±€æ›¿æ¢")
        replace_button.setStyleSheet("""
            QPushButton {
                background-color: #C67A8A;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B56A7A;
            }
        """)
        
        replace_input_layout.addWidget(search_label)
        replace_input_layout.addWidget(search_input)
        replace_input_layout.addWidget(replace_label)
        replace_input_layout.addWidget(replace_input)
        replace_input_layout.addWidget(replace_button)

        # æ·»åŠ æ›¿æ¢å†å²ä¸‹æ‹‰æ¡†
        history_layout = QHBoxLayout()
        history_label = QLabel("æ›¿æ¢å†å²:")
        history_combo = QComboBox()
        self.update_replace_history_combo(history_combo)
        apply_history_button = QPushButton("åº”ç”¨")
        remove_history_button = QPushButton("åˆ é™¤")
        apply_all_history_button = QPushButton("åº”ç”¨æ‰€æœ‰å†å²æ›¿æ¢")
        
        apply_history_button.setStyleSheet("""
            QPushButton {
                background-color: #C67A8A;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B56A7A;
            }
        """)
        
        remove_history_button.setStyleSheet("""
            QPushButton {
                background-color: #C67A8A;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B56A7A;
            }
        """)
        
        apply_all_history_button.setStyleSheet("""
            QPushButton {
                background-color: #C5D8EC;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B5C8DC;
            }
        """)
        
        history_layout.addWidget(history_label)
        history_layout.addWidget(history_combo)
        history_layout.addWidget(apply_history_button)
        history_layout.addWidget(remove_history_button)
        history_layout.addWidget(apply_all_history_button)
        
        # å…¨å±€æ—ç™½é¢„è®¾é€‰æ‹©
        narration_layout = QHBoxLayout()
        narration_label = QLabel("æ—ç™½å…¨å±€é¢„è®¾:")
        narration_combo = SwipeSelector()
        all_presets = [preset[0] for preset in self.preset_manager.get_all_presets()]
        
        # ğŸ”§ ä½¿ç”¨é¢„è®¾æ’åºç®¡ç†å™¨è¿›è¡Œæ’åº
        if self.preset_order_manager:
            sorted_presets = self.preset_order_manager.sort_presets(all_presets)
            narration_combo.addItems(sorted_presets)
        else:
            narration_combo.addItems(all_presets)
        
        # å…¨å±€æ—ç™½æƒ…ç»ªé€‰æ‹©
        narration_emotion_label = QLabel("æ—ç™½æƒ…ç»ª:")
        narration_emotion_combo = SwipeSelector()
        # åˆå§‹åŒ–æƒ…ç»ªé€‰æ‹©ï¼ˆä¼šåœ¨é¢„è®¾æ”¹å˜æ—¶æ›´æ–°ï¼‰
        if all_presets:
            emotions = self.preset_manager.get_preset_emotions(all_presets[0])
            narration_emotion_combo.addItems(emotions)
        
        # å¦‚æœä¹‹å‰ä¿å­˜è¿‡æ—ç™½é¢„è®¾ï¼Œåˆ™è®¾ç½®ä¸ºä¸Šæ¬¡é€‰æ‹©çš„å€¼
        if hasattr(self, 'global_narration_preset') and self.global_narration_preset in all_presets:
            index = narration_combo.findText(self.global_narration_preset)
            if index >= 0:
                narration_combo.setCurrentIndex(index)
                # åŠ è½½å¯¹åº”çš„æƒ…ç»ªé€‰é¡¹
                emotions = self.preset_manager.get_preset_emotions(self.global_narration_preset)
                narration_emotion_combo.clear()
                narration_emotion_combo.addItems(emotions)
                # è®¾ç½®ä¸Šæ¬¡é€‰æ‹©çš„æƒ…ç»ª
                if hasattr(self, 'global_narration_emotion') and self.global_narration_emotion in emotions:
                    emo_index = narration_emotion_combo.findText(self.global_narration_emotion)
                    if emo_index >= 0:
                        narration_emotion_combo.setCurrentIndex(emo_index)
        
        narration_apply = QPushButton("åº”ç”¨æ—ç™½é¢„è®¾")
        narration_apply.setStyleSheet("""
            QPushButton {
                background-color: #C67A8A;
                color: white;
                border: none;
            }
            QPushButton:hover {
                background-color: #B56A7A;
            }
        """)
        
        narration_layout.addWidget(narration_label)
        narration_layout.addWidget(narration_combo)
        narration_layout.addWidget(narration_emotion_label)
        narration_layout.addWidget(narration_emotion_combo)
        narration_layout.addWidget(narration_apply)
        narration_layout.addStretch()
        
        replace_layout.addLayout(replace_input_layout)
        replace_layout.addLayout(history_layout)
        replace_layout.addLayout(narration_layout)
        
        # è¿æ¥ä¿¡å·
        replace_button.clicked.connect(lambda: self.global_replace(search_input.text(), replace_input.text()))
        narration_combo.currentTextChanged.connect(lambda text: self.on_narration_preset_changed(text, narration_emotion_combo))
        narration_combo.currentTextChanged.connect(self.save_narration_preset)
        narration_emotion_combo.currentTextChanged.connect(self.save_narration_emotion)
        narration_apply.clicked.connect(lambda: self.apply_narration_preset(narration_combo.currentText(), narration_emotion_combo.currentText()))
        
        # è¿æ¥æ›¿æ¢å†å²ç›¸å…³ä¿¡å·
        history_combo.currentIndexChanged.connect(lambda: self.on_history_selected(history_combo, search_input, replace_input))
        apply_history_button.clicked.connect(lambda: self.apply_selected_history(history_combo))
        remove_history_button.clicked.connect(lambda: self.remove_selected_history(history_combo))
        apply_all_history_button.clicked.connect(self.apply_all_history)
        
        self.content_layout.addWidget(replace_frame)
        
        # è·å–å½“å‰æ®µè½æ–‡æœ¬
        
        text = self.segments[self.current_segment_index]
        
        
        # åˆ†ææ–‡æœ¬ï¼Œè·å–æ—ç™½å’Œå¯¹è¯
        segments = self.analyze_text_segments(text)
        
        # è·å–å…¨å±€æ—ç™½é¢„è®¾å’Œæƒ…ç»ªï¼ˆå¦‚æœæœ‰ï¼‰
        global_narration_preset = getattr(self, 'global_narration_preset', None)
        global_narration_emotion = getattr(self, 'global_narration_emotion', None)
        
        # å¤„ç†æ¯ä¸ªåˆ†æ®µ
        for segment_id, (segment_type, content, speaker) in enumerate(segments):
            # åˆ›å»ºåˆ†æ®µå®¹å™¨
            segment_frame = QFrame()
            segment_frame.setStyleSheet(f"""
                QFrame {{
                    border: 1px solid #d4c5b9;
                    border-radius: 8px;
                    background-color: {('#faf6f1' if segment_type == 'narration' else '#ffffff')};
                    padding: 10px;
                    margin: 5px;
                }}
            """)
            segment_layout = QVBoxLayout(segment_frame)
            segment_layout.setSpacing(10)
            
            # å¦‚æœæ˜¯å¯¹è¯ï¼Œæ·»åŠ è¯´è¯è€…æ ‡ç­¾
            if segment_type == "dialogue" and speaker:
                speaker_label = QLabel(f"è¯´è¯è€…ï¼š{speaker}")
                speaker_label.setStyleSheet("""
                    color: #C67A8A;
                    font-weight: bold;
                    margin-bottom: 4px;
                """)
                segment_layout.addWidget(speaker_label)
            
            # åˆ›å»ºæ–‡æœ¬ç¼–è¾‘åŒºåŸŸå’ŒæŒ‰é’®
            text_container = QWidget()
            text_container_layout = QHBoxLayout(text_container)
            text_container_layout.setContentsMargins(0, 0, 0, 0)
            
            text_edit = QTextEdit()
            # ç§»é™¤å‚ç›´æ»šåŠ¨æ¡è®¾ç½®ï¼Œä»…è®¾ç½®æ°´å¹³æ»šåŠ¨æ¡ä¸ºéšè—
            text_edit.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
            text_edit.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
            text_edit.setText(content)
            text_edit.setStyleSheet(f"""
                QTextEdit {{
                    border: 1px solid #e0e0e0;
                    border-radius: 4px;
                    padding: 8px;
                    background-color: {('#faf6f1' if segment_type == 'narration' else '#ffffff')};
                }}
            """)
            
            # è®¾ç½®æ–‡æœ¬æ¡†ID
            text_edit_id = f"{self.current_segment_index}_{segment_id}"
            text_edit.setObjectName(text_edit_id)
            
            # è®¾ç½®å¤§å°ç­–ç•¥ï¼Œå…è®¸å‚ç›´æ–¹å‘è‡ªåŠ¨è°ƒæ•´
            text_edit.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Fixed)
            
            # è®¡ç®—åˆå§‹é«˜åº¦
            document = text_edit.document()
            document.setTextWidth(text_edit.viewport().width())
            text_height = int(document.size().height() + 20)
            text_edit.setFixedHeight(text_height)
            
            # æ·»åŠ æ–‡æœ¬æ”¹å˜äº‹ä»¶å¤„ç†
            text_edit.textChanged.connect(lambda te=text_edit: self.adjust_text_height(te))
            
            # æ·»åŠ æ–‡æœ¬æ¡†åºå·æ ‡ç­¾
            sequence_label = QLabel(f"{segment_id + 1}/{len(segments)}")
            sequence_label.setStyleSheet("""
                QLabel {
                    color: #C67A8A;
                    font-weight: bold;
                    font-size: 12px;
                    margin: 2px;
                }
            """)
            
            # æ·»åŠ æŒ‰é’®å®¹å™¨
            button_container = QVBoxLayout()
            button_container.setSpacing(5)
            
            # æ·»åŠ åºå·æ ‡ç­¾åˆ°æŒ‰é’®å®¹å™¨é¡¶éƒ¨
            button_container.addWidget(sequence_label)
            
            # æ·»åŠ å¤åˆ¶æŒ‰é’®
            copy_btn = QPushButton("å¤åˆ¶")
            copy_btn.setStyleSheet("""
                QPushButton {
                    background-color: #C67A8A;
                    color: white;
                    border: none;
                    padding: 5px;
                    max-width: 60px;
                    border-radius: 4px;
                }
                QPushButton:hover {
                    background-color: #B56A7A;
                }
            """)
            copy_btn.clicked.connect(lambda _, te=text_edit: self.copy_text_content(te))
            
            # æ·»åŠ å‰ªåˆ‡æŒ‰é’®
            cut_btn = QPushButton("å‰ªåˆ‡")
            cut_btn.setStyleSheet("""
                QPushButton {
                    background-color: #C67A8A;
                    color: white;
                    border: none;
                    padding: 5px;
                    max-width: 60px;
                    border-radius: 4px;
                }
                QPushButton:hover {
                    background-color: #B56A7A;
                }
            """)
            cut_btn.clicked.connect(lambda _, te=text_edit: self.cut_text_content(te))
            
            # æ·»åŠ åˆ é™¤æŒ‰é’®
            delete_btn = QPushButton("åˆ é™¤")
            delete_btn.setStyleSheet("""
                QPushButton {
                    background-color: #C67A8A;
                    color: white;
                    border: none;
                    padding: 5px;
                    max-width: 60px;
                    border-radius: 4px;
                }
                QPushButton:hover {
                    background-color: #B56A7A;
                }
            """)
            delete_btn.clicked.connect(lambda _, te=text_edit: self.delete_text_content(te))
            
            # æ·»åŠ ä¿å­˜æŒ‰é’®
            save_btn = QPushButton("ä¿å­˜")
            save_btn.setStyleSheet("""
                QPushButton {
                    background-color: #C5D8EC;
                    color: white;
                    border: none;
                    padding: 5px;
                    max-width: 60px;
                    border-radius: 4px;
                }
                QPushButton:hover {
                    background-color: #B5C8DC;
                }
            """)
            save_btn.clicked.connect(lambda _, te=text_edit: self.save_text_content(te))
            
            # æ·»åŠ ç²˜è´´æŒ‰é’®
            paste_btn = QPushButton("ç²˜è´´")
            paste_btn.setStyleSheet("""
                QPushButton {
                    background-color: #C5D8EC;
                    color: white;
                    border: none;
                    padding: 5px;
                    max-width: 60px;
                    border-radius: 4px;
                }
                QPushButton:hover {
                    background-color: #B5C8DC;
                }
            """)
            paste_btn.clicked.connect(lambda _, te=text_edit: self.paste_text_content(te))
            
            # æ·»åŠ æŒ‰é’®åˆ°æŒ‰é’®å®¹å™¨
            button_container.addWidget(copy_btn)
            button_container.addWidget(cut_btn)
            button_container.addWidget(delete_btn)
            button_container.addWidget(save_btn)
            button_container.addWidget(paste_btn)
            button_container.addStretch()
            
            # ä¿®æ”¹å¸ƒå±€é¡ºåºï¼šå…ˆæ·»åŠ æŒ‰é’®å®¹å™¨ï¼Œç„¶åæ·»åŠ æ–‡æœ¬æ¡†
            text_container_layout.addLayout(button_container)
            text_container_layout.addWidget(text_edit)
            
            # åˆ›å»ºæ§åˆ¶é¢æ¿
            control_panel = QWidget()
            control_layout = QHBoxLayout(control_panel)
            control_layout.setSpacing(10)
            
            # é…éŸ³é€‰æ‹©
            voice_combo = SwipeSelector()
            all_presets = [preset[0] for preset in self.preset_manager.get_all_presets()]
            
            # ğŸ”§ ä½¿ç”¨é¢„è®¾æ’åºç®¡ç†å™¨è¿›è¡Œæ’åº
            if self.preset_order_manager:
                sorted_presets = self.preset_order_manager.sort_presets(all_presets)
                voice_combo.addItems(sorted_presets)
            else:
                voice_combo.addItems(all_presets)
            
            # æƒ…ç»ªé€‰æ‹©
            emotion_combo = SwipeSelector()
            if segment_type == "dialogue" and speaker in self.characters:
                # å¯¹è¯æ®µè½ï¼šæ ¹æ®è¯´è¯è€…è®¾ç½®é…éŸ³
                preset = self.characters[speaker]
                index = voice_combo.findText(preset)
                if index >= 0:
                    voice_combo.setCurrentIndex(index)
                # ä»é¢„è®¾åŠ è½½æƒ…ç»ªé€‰é¡¹
                emotions = self.preset_manager.get_preset_emotions(preset)
                emotion_combo.addItems(emotions)
                if emotions:
                    emotion_combo.setCurrentIndex(0)
            else:
                # æ—ç™½æ®µè½æˆ–æœªè¯†åˆ«åˆ°è¯´è¯è€…çš„å¯¹è¯æ®µè½ï¼šä¼˜å…ˆä½¿ç”¨å…¨å±€æ—ç™½é¢„è®¾
                if global_narration_preset:
                    # ä½¿ç”¨å…¨å±€æ—ç™½é¢„è®¾
                    index = voice_combo.findText(global_narration_preset)
                    if index >= 0:
                        voice_combo.setCurrentIndex(index)
                    # åŠ è½½æƒ…ç»ªé€‰é¡¹
                    emotions = self.preset_manager.get_preset_emotions(global_narration_preset)
                    emotion_combo.addItems(emotions)
                    # è®¾ç½®å…¨å±€æ—ç™½æƒ…ç»ª
                    if global_narration_emotion and global_narration_emotion in emotions:
                        emotion_index = emotion_combo.findText(global_narration_emotion)
                        if emotion_index >= 0:
                            emotion_combo.setCurrentIndex(emotion_index)
                        else:
                            # å¦‚æœæ²¡æœ‰åŒ¹é…çš„æƒ…ç»ªï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
                            if emotions:
                                emotion_combo.setCurrentIndex(0)
                    else:
                        # å¦‚æœæ²¡æœ‰å…¨å±€æƒ…ç»ªï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
                        if emotions:
                            emotion_combo.setCurrentIndex(0)
                else:
                    # æ—ç™½æ®µè½ä½†æ²¡æœ‰å…¨å±€é¢„è®¾ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªé¢„è®¾
                    if all_presets:
                        voice_combo.setCurrentIndex(0)
                        emotions = self.preset_manager.get_preset_emotions(all_presets[0])
                        emotion_combo.addItems(emotions)
                        if emotions:
                            emotion_combo.setCurrentIndex(0)
            
            # ç”Ÿæˆå’Œè¯•å¬æŒ‰é’®
            generate_btn = QPushButton("ç”Ÿæˆ")
            generate_btn.setObjectName("generate_btn")
            generate_btn.setStyleSheet("""
                QPushButton#generate_btn {
                    background-color: #C67A8A;
                    color: white;
                    border: none;
                }
                QPushButton#generate_btn:hover {
                    background-color: #B56A7A;
                }
                QPushButton#generate_btn:disabled {
                    background-color: #ffffff;
                    color: #4a5568;
                    border: 1px solid #d4c5b9;
                }
            """)
            
            regenerate_btn = QPushButton("é‡æ–°ç”Ÿæˆ")
            regenerate_btn.setObjectName("regenerate_btn")
            regenerate_btn.setEnabled(False)
            regenerate_btn.setStyleSheet("""
                QPushButton#regenerate_btn {
                    background-color: #ffffff;
                    color: #4a5568;
                    border: 1px solid #d4c5b9;
                }
                QPushButton#regenerate_btn:enabled {
                    background-color: #C67A8A;
                    color: white;
                    border: none;
                }
                QPushButton#regenerate_btn:enabled:hover {
                    background-color: #B56A7A;
                }
            """)
            
            preview_btn = QPushButton("è¯•å¬")
            preview_btn.setEnabled(True)  # é»˜è®¤å¯ç”¨è¯•å¬æŒ‰é’®
            preview_btn.setStyleSheet("""
                QPushButton {
                    background-color: #ffffff;
                    color: #4a5568;
                    border: 1px solid #d4c5b9;
                }
                QPushButton:enabled {
                    background-color: #C67A8A;
                    color: white;
                    border: none;
                }
                QPushButton:enabled:hover {
                    background-color: #B56A7A;
                }
            """)
            
            # çŠ¶æ€æ ‡ç­¾
            status_label = QLabel("ğŸ”„")  # åˆå§‹çŠ¶æ€ï¼šå‡†å¤‡ä¸­
            status_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            status_label.setStyleSheet("""
                QLabel {
                    font-size: 18px;
                    min-width: 30px;
                }
            """)
            
            # è¿æ¥ä¿¡å·
            voice_combo.currentTextChanged.connect(
                lambda text, ec=emotion_combo: self.on_voice_changed(text, ec))
            generate_btn.clicked.connect(
                lambda _, te=text_edit, vc=voice_combo, ec=emotion_combo, gb=generate_btn, rb=regenerate_btn, pb=preview_btn, sl=status_label:
                self.generate_audio(te, vc.currentText(), ec.currentText(), gb, rb, pb, sl, is_regenerate=False))
            regenerate_btn.clicked.connect(
                lambda _, te=text_edit, vc=voice_combo, ec=emotion_combo, gb=generate_btn, rb=regenerate_btn, pb=preview_btn, sl=status_label:
                self.generate_audio(te, vc.currentText(), ec.currentText(), gb, rb, pb, sl, is_regenerate=True))
            preview_btn.clicked.connect(
                lambda _, te=text_edit: self.preview_audio(te))
            
            # æ·»åŠ æ§ä»¶åˆ°æ§åˆ¶é¢æ¿
            control_layout.addWidget(QLabel("é…éŸ³:"))
            control_layout.addWidget(voice_combo)
            control_layout.addWidget(QLabel("æƒ…ç»ª:"))
            control_layout.addWidget(emotion_combo)
            control_layout.addWidget(generate_btn)
            control_layout.addWidget(regenerate_btn)
            control_layout.addWidget(preview_btn)
            control_layout.addWidget(status_label)
            control_layout.addStretch()
            
            # æ·»åŠ ç»„ä»¶åˆ°åˆ†æ®µå®¹å™¨
            segment_layout.addWidget(text_container)
            segment_layout.addWidget(control_panel)
            
            # æ·»åŠ åˆ†æ®µå®¹å™¨åˆ°å†…å®¹å¸ƒå±€
            self.content_layout.addWidget(segment_frame)
    
    def adjust_text_height(self, text_edit: QTextEdit):
        """è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦ä»¥é€‚åº”å†…å®¹"""
        # è®¡ç®—æ–°çš„é«˜åº¦
        document = text_edit.document()
        document.setTextWidth(text_edit.viewport().width())
        # å¢åŠ é¢å¤–çš„è¾¹è·ç¡®ä¿æ‰€æœ‰å†…å®¹å¯è§
        new_height = int(document.size().height() + 30)
        text_edit.setFixedHeight(new_height)
    
    
    
    def on_voice_changed(self, preset_name: str, emotion_combo: QComboBox):
        """å½“é¢„è®¾é€‰æ‹©æ”¹å˜æ—¶ï¼Œæ›´æ–°æƒ…ç»ªé€‰é¡¹"""
        emotions = self.preset_manager.get_preset_emotions(preset_name)
        emotion_combo.clear()
        emotion_combo.addItems(emotions)
        if emotions:
            emotion_combo.setCurrentIndex(0)
    
    def on_default_changed(self, state: int, preset_name: str, emotion: str):
        """å½“é»˜è®¤é€‰é¡¹æ”¹å˜æ—¶çš„å¤„ç†"""
        # ä¸å†éœ€è¦è¿™ä¸ªæ–¹æ³•ï¼Œä½†ä¸ºäº†é¿å…æŠ¥é”™ï¼Œä¿ç•™ä¸€ä¸ªç©ºå®ç°
        pass
    
    def generate_audio(self, text_edit: QTextEdit, preset_name: str, emotion: str,
                       generate_btn: QPushButton, regenerate_btn: QPushButton, preview_btn: QPushButton, 
                       status_label: QLabel, is_regenerate: bool = False):
        """ç”ŸæˆéŸ³é¢‘"""
        try:
            # è·å–æ–‡æœ¬å†…å®¹å¹¶æ£€æŸ¥æ˜¯å¦ä¸ºç©º
            text = text_edit.toPlainText().strip()
            if not text:
                status_label.setText("â“")  # éœ€è¦æ–‡æœ¬
                generate_btn.setEnabled(True)
                regenerate_btn.setEnabled(False)
                # ä¸å†ç¦ç”¨è¯•å¬æŒ‰é’®ï¼Œè®©ç”¨æˆ·éšæ—¶å¯ä»¥å°è¯•è¯•å¬
                return
                
            # æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­
            status_label.setText("â³")  # å¤„ç†ä¸­
            QApplication.processEvents()  # ç«‹å³æ›´æ–°UI
            
            # è·å–é¢„è®¾ä¿¡æ¯
            preset_info = self.preset_manager.get_preset(preset_name)
            if not preset_info:
                status_label.setText("âŒ")  # é”™è¯¯
                return
                
            settings, audio_files = preset_info
            
            # åŠ è½½æ¨¡å‹
            gpt_path = settings.get('model_path', '') or settings.get('gpt_path', '')
            if not self.gpt_sovits.load_models(gpt_path, settings['sovits_path']):
                status_label.setText("âŒ")  # é”™è¯¯
                return
                
            # è®¾ç½®é¢„è®¾å‚æ•°ï¼Œå¹¶æ·»åŠ æƒ…ç»ªå‚æ•°
            settings['ref_emotion'] = emotion  # ç¡®ä¿ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æƒ…ç»ª
            settings['preset_name'] = preset_name  # æ·»åŠ é¢„è®¾åç§°
            
            # ç¡®ä¿è®¾ç½®åŒ…å«gpt_sovits.pyæ‰€éœ€çš„æ‰€æœ‰å¿…è¦å­—æ®µ
            if 'gpt_path' not in settings and 'model_path' in settings:
                settings['gpt_path'] = settings['model_path']
            if 'ref_language' not in settings:
                settings['ref_language'] = settings.get('text_lang', 'all_zh')
            
            if not self.gpt_sovits.set_preset(settings):
                status_label.setText("âŒ")  # é”™è¯¯
                return
            
            # å°è¯•ä»MainWindowè·å–å½“å‰å¤„ç†çš„æ–‡ä»¶å
            main_window = self.window()
            source_filename = "unknown"
            
            if hasattr(main_window, 'current_file') and main_window.current_file:
                # ä»MainWindowè·å–å½“å‰æ–‡ä»¶è·¯å¾„
                source_filename = os.path.splitext(os.path.basename(main_window.current_file))[0]
            
            # åˆ›å»ºéŸ³é¢‘ç›®å½•
            working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
            processed_dir = os.path.join(working_dir, f"{source_filename}_processed")
            audio_dir = os.path.join(processed_dir, "audio_segments")
            os.makedirs(audio_dir, exist_ok=True)
            
            # ç”ŸæˆéŸ³é¢‘æ–‡ä»¶åï¼ŒåŒ…å«åŸæ–‡ä»¶åã€æ®µè½å’Œæ¡†åºå·
            text_edit_id = text_edit.objectName()
            segment_index, box_index = map(int, text_edit_id.split('_'))
            audio_filename = f"{source_filename}_æ®µè½{segment_index+1:04d}_æ–‡æœ¬æ¡†{box_index+1:02d}.wav"
            audio_path = os.path.join(audio_dir, audio_filename)
            
            # é‡è¦ï¼šå…ˆåœæ­¢æ’­æ”¾å™¨ï¼Œç¡®ä¿ä¸ä¼šé˜»æ­¢æ–‡ä»¶æ›¿æ¢
            try:
                self.player.stop()
            except:
                pass
                
            # æ£€æŸ¥å¹¶åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶
            old_pattern = re.compile(rf'^.*_æ®µè½{segment_index+1:04d}_æ–‡æœ¬æ¡†{box_index+1:02d}.*\.wav$')
            for file in os.listdir(audio_dir):
                if old_pattern.match(file):
                    try:
                        old_file_path = os.path.join(audio_dir, file)
                        os.remove(old_file_path)
                    except Exception as e:
                        pass  # æ— æ³•åˆ é™¤æ—§æ–‡ä»¶
            
            # è®°å½•å¼€å§‹ç”Ÿæˆè¯­éŸ³çš„ä¿¡æ¯ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
            
            
            
            # ç”ŸæˆéŸ³é¢‘ï¼ˆä¸æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†ï¼‰å¹¶æ˜ç¡®ä¼ é€’æƒ…ç»ªå‚æ•°
            success = self.gpt_sovits.generate_audio(text, audio_path, emotion=emotion)
            
            if success:
                # å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç¡®å®å­˜åœ¨
                if os.path.exists(audio_path):
        
                    
                    # å¦‚æœæ˜¯é‡æ–°ç”Ÿæˆï¼Œå°è¯•é‡ç½®æ’­æ”¾å™¨çŠ¶æ€
                    if is_regenerate:
                        try:
                            # é‡ç½®æ’­æ”¾å™¨ä»¥æ¸…é™¤å¯èƒ½çš„ç¼“å­˜
        
                            self.player.stop()
                            # åˆ›å»ºæ–°çš„æ’­æ”¾å™¨å®ä¾‹
                            del self.player
                            del self.audio_output
                            
                            self.player = QMediaPlayer()
                            self.audio_output = QAudioOutput()
                            self.player.setAudioOutput(self.audio_output)
                            
                            # æ¢å¤éŸ³é‡è®¾ç½®
                            self.audio_output.setVolume(self.current_volume / 100.0)
                        except Exception as e:
                            pass  # é‡ç½®æ’­æ”¾å™¨æ—¶å‡ºé”™ï¼Œä¸å½±å“ç”Ÿæˆç»“æœ
                    
                    # ä¿å­˜éŸ³é¢‘çŠ¶æ€
                    self.segment_audio_states[text_edit_id] = (True, audio_path)
                    
                    # å¼ºåˆ¶æ›´æ–°çŠ¶æ€æ ‡ç­¾ä¸ºæˆåŠŸ
                    status_label.setText("ğŸŒ·")  # æˆåŠŸ
                    QApplication.processEvents()  # ç«‹å³æ›´æ–°UI
                    
                    # æ›´æ–°æŒ‰é’®çŠ¶æ€
                    generate_btn.setEnabled(False)
                    regenerate_btn.setEnabled(True)
                    preview_btn.setEnabled(True)
                    
                    # å¦‚æœæ˜¯é‡æ–°ç”Ÿæˆï¼Œæ›´æ–°çŠ¶æ€emojiå’ŒæŒ‰é’®çŠ¶æ€
                    if is_regenerate:
    
                        status_label.setText("ğŸ¥³")  # ç¡®ä¿çŠ¶æ€ä¸ºæˆåŠŸ
                        preview_btn.setEnabled(True)  # ç¡®ä¿è¯•å¬æŒ‰é’®å¯ç”¨
                    
                else:
                    pass  # éŸ³é¢‘ç”ŸæˆæˆåŠŸä½†æ–‡ä»¶ä¸å­˜åœ¨
                    status_label.setText("âš ï¸")  # è­¦å‘Š
                    QMessageBox.warning(self, "è­¦å‘Š", "éŸ³é¢‘ç”ŸæˆæˆåŠŸä½†æ–‡ä»¶ä¸å­˜åœ¨")
            else:
                # æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥
                status_label.setText("âŒ")  # é”™è¯¯

                
        except Exception as e:
            # æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥
            status_label.setText("âŒ")  # é”™è¯¯
    
    def preview_audio(self, text_edit: QTextEdit):
        """é¢„è§ˆéŸ³é¢‘"""
        try:
            text_edit_id = text_edit.objectName()

            
            # è·å–éŸ³é¢‘æ–‡ä»¶è·¯å¾„
            audio_path = None
            
            # é¦–å…ˆå°è¯•ä»segment_audio_statesè·å–è·¯å¾„
            if text_edit_id in self.segment_audio_states:
                is_generated, saved_path = self.segment_audio_states[text_edit_id]
                if is_generated and saved_path:
                    audio_path = saved_path
            
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°è·¯å¾„æˆ–æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°æ„å»ºè·¯å¾„
            if not audio_path or not os.path.exists(audio_path):
                
                # å°è¯•ä»MainWindowè·å–å½“å‰å¤„ç†çš„æ–‡ä»¶å
                main_window = self.window()
                source_filename = "unknown"
                
                if hasattr(main_window, 'current_file') and main_window.current_file:
                    # ä»MainWindowè·å–å½“å‰æ–‡ä»¶è·¯å¾„
                    source_filename = os.path.splitext(os.path.basename(main_window.current_file))[0]
                
                # æ„å»ºéŸ³é¢‘ç›®å½•è·¯å¾„
                working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
                processed_dir = os.path.join(working_dir, f"{source_filename}_processed")
                audio_dir = os.path.join(processed_dir, "audio_segments")
                
                # ä»æ–‡æœ¬æ¡†IDè§£ææ®µè½å’Œæ¡†åºå·
                segment_index, box_index = map(int, text_edit_id.split('_'))
                audio_filename = f"{source_filename}_æ®µè½{segment_index+1:04d}_æ–‡æœ¬æ¡†{box_index+1:02d}.wav"
                constructed_path = os.path.join(audio_dir, audio_filename)
                
                # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                if os.path.exists(constructed_path):
                    audio_path = constructed_path
                    # æ›´æ–°ç¼“å­˜çŠ¶æ€
                    self.segment_audio_states[text_edit_id] = (True, constructed_path)
            
            # å¦‚æœæ‰¾åˆ°æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ï¼Œæ’­æ”¾å®ƒ
            if audio_path and os.path.exists(audio_path):
                # ğŸ”§ å½»åº•ä¿®å¤å¤šäººæœ—è¯»æ¨¡å¼æ’­æ”¾é—®é¢˜ï¼šé‡æ–°åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹
                try:
                    # 1. é”€æ¯å½“å‰æ’­æ”¾å™¨
                    self.player.stop()
                    self.player.setSource(QUrl())  # æ¸…ç©ºéŸ³é¢‘æº
                    
                    # 2. é‡æ–°åˆ›å»ºæ’­æ”¾å™¨å’ŒéŸ³é¢‘è¾“å‡º
                    old_volume = self.current_volume
                    del self.player
                    del self.audio_output
                    
                    self.player = QMediaPlayer()
                    self.audio_output = QAudioOutput()
                    self.player.setAudioOutput(self.audio_output)
                    
                    # 3. æ¢å¤éŸ³é‡è®¾ç½®
                    self.audio_output.setVolume(old_volume / 100.0)
                    
                except Exception as cleanup_error:
                    logger.warning(f"å¤šäººæ¨¡å¼æ’­æ”¾å™¨é‡å»ºæ—¶å‡ºé”™: {cleanup_error}")
                
                # 4. è®¾ç½®éŸ³é¢‘æºå¹¶æ’­æ”¾
                self.player.setSource(QUrl.fromLocalFile(audio_path))
                self.player.play()
                
                logger.info(f"å¼€å§‹æ’­æ”¾éŸ³é¢‘: {audio_path}")
            else:
                QMessageBox.warning(self, "æç¤º", "éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·ç”ŸæˆéŸ³é¢‘")
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"æ’­æ”¾éŸ³é¢‘æ—¶å‡ºé”™ï¼š{str(e)}")
            logger.error(f"æ’­æ”¾éŸ³é¢‘æ—¶å‡ºé”™: {str(e)}")
    
    def update_nav_buttons(self):
        """æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€"""
        self.prev_btn.setEnabled(self.current_segment_index > 0)
        self.next_btn.setEnabled(self.current_segment_index < len(self.segments) - 1)
        self.segment_label.setText(f"ç¬¬ {self.current_segment_index + 1}/{len(self.segments)} æ®µ")
        
        # æ›´æ–°åº•éƒ¨å¯¼èˆªæŒ‰é’®
        self.bottom_prev_btn.setEnabled(self.current_segment_index > 0)
        self.bottom_next_btn.setEnabled(self.current_segment_index < len(self.segments) - 1)
        self.bottom_segment_label.setText(f"ç¬¬ {self.current_segment_index + 1}/{len(self.segments)} æ®µ")
    
    def prev_segment(self):
        """æ˜¾ç¤ºä¸Šä¸€æ®µ"""
        if self.current_segment_index > 0:
            # ä¿å­˜å½“å‰é…ç½®çŠ¶æ€
            current_preset_selections = self._save_current_preset_selections()
            global_narration_preset = getattr(self, 'global_narration_preset', None)
            global_narration_emotion = getattr(self, 'global_narration_emotion', None)
            
            # æ›´æ–°æ®µè½ç´¢å¼•
            self.current_segment_index -= 1
            
            # æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œç¡®ä¿æ­£ç¡®é‡æ–°åŠ è½½
            for i in reversed(range(self.content_layout.count())):
                widget = self.content_layout.itemAt(i).widget()
                if widget:
                    widget.deleteLater()
            
            # ä½¿ç”¨process_current_segmenté‡æ–°åˆ†æå¹¶åŠ è½½æ®µè½
            self.process_current_segment()
            
            # æ¢å¤å…¨å±€é¢„è®¾å’Œæ—ç™½é…ç½®
            self._restore_global_narration_preset(global_narration_preset, global_narration_emotion)
            
            # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            self.update_nav_buttons()
    
    def next_segment(self):
        """æ˜¾ç¤ºä¸‹ä¸€æ®µ"""
        if self.current_segment_index < len(self.segments) - 1:
            # ä¿å­˜å½“å‰é…ç½®çŠ¶æ€
            current_preset_selections = self._save_current_preset_selections()
            global_narration_preset = getattr(self, 'global_narration_preset', None)
            global_narration_emotion = getattr(self, 'global_narration_emotion', None)
            
            # æ›´æ–°æ®µè½ç´¢å¼•
            self.current_segment_index += 1
            
            # æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œç¡®ä¿æ­£ç¡®é‡æ–°åŠ è½½
            for i in reversed(range(self.content_layout.count())):
                widget = self.content_layout.itemAt(i).widget()
                if widget:
                    widget.deleteLater()
            
            # ä½¿ç”¨process_current_segmenté‡æ–°åˆ†æå¹¶åŠ è½½æ®µè½
            self.process_current_segment()
            
            # æ¢å¤å…¨å±€é¢„è®¾å’Œæ—ç™½é…ç½®
            self._restore_global_narration_preset(global_narration_preset, global_narration_emotion)
            
            # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            self.update_nav_buttons()
    
    def _save_current_preset_selections(self):
        """ä¿å­˜å½“å‰æ–‡æœ¬æ¡†çš„é¢„è®¾é€‰æ‹©çŠ¶æ€"""
        preset_selections = {}
        
        # éå†å†…å®¹å¸ƒå±€ä¸­çš„æ‰€æœ‰æ§ä»¶
        for i in range(self.content_layout.count()):
            widget = self.content_layout.itemAt(i).widget()
            # è·³è¿‡å…¨å±€æ›¿æ¢æ¡†
            if i == 0 and isinstance(widget, QFrame) and "å…¨å±€æ–‡æœ¬æ›¿æ¢" in widget.findChildren(QLabel)[0].text():
                continue
                
            if isinstance(widget, QFrame):
                # æ‰¾åˆ°æ–‡æœ¬æ¡†å’Œæ§åˆ¶é¢æ¿
                text_edit = None
                voice_combo = None
                emotion_combo = None
                
                # æŸ¥æ‰¾æ–‡æœ¬æ¡†
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    # æŸ¥æ‰¾æ–‡æœ¬æ¡†å®¹å™¨
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        for k in range(item.layout().count()):
                            sub_item = item.layout().itemAt(k).widget()
                            if isinstance(sub_item, QTextEdit):
                                text_edit = sub_item
                                break
                
                # æŸ¥æ‰¾æ§åˆ¶é¢æ¿
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        control_layout = item.layout()
                        # æŸ¥æ‰¾é¢„è®¾å’Œæƒ…ç»ªä¸‹æ‹‰æ¡†
                        found_combos = []
                        for k in range(control_layout.count()):
                            control_item = control_layout.itemAt(k).widget()
                            if isinstance(control_item, QComboBox):
                                found_combos.append(control_item)
                                
                        if len(found_combos) >= 2:
                            voice_combo = found_combos[0]
                            emotion_combo = found_combos[1]
                
                # å¦‚æœæ‰¾åˆ°äº†æ‰€æœ‰éœ€è¦çš„æ§ä»¶ï¼Œä¿å­˜é¢„è®¾é€‰æ‹©çŠ¶æ€
                if text_edit and voice_combo and emotion_combo:
                    text_edit_id = text_edit.objectName()
                    preset_selections[text_edit_id] = {
                        'preset': voice_combo.currentText(),
                        'emotion': emotion_combo.currentText(),
                        'text': text_edit.toPlainText(),
                        'is_narration': 'faf6f1' in widget.styleSheet(),
                        'has_speaker': any(isinstance(w, QLabel) and "è¯´è¯è€…" in w.text() 
                                         for w in widget.findChildren(QLabel))
                    }
        
        return preset_selections
    
    def _restore_global_narration_preset(self, global_narration_preset, global_narration_emotion):
        """æ¢å¤å…¨å±€æ—ç™½é¢„è®¾é€‰æ‹©"""
        if global_narration_preset and global_narration_emotion:
            self.global_narration_preset = global_narration_preset
            self.global_narration_emotion = global_narration_emotion
            
            # æ¢å¤æ—ç™½ä¸‹æ‹‰æ¡†çš„é€‰æ‹©
            replace_frame = self.content_layout.itemAt(0).widget()
            if replace_frame:
                # æŸ¥æ‰¾æ—ç™½é¢„è®¾ä¸‹æ‹‰æ¡†
                narration_combos = []
                for child in replace_frame.findChildren(QComboBox):
                    narration_combos.append(child)
                
                if len(narration_combos) >= 2:
                    narration_preset_combo = narration_combos[0]
                    narration_emotion_combo = narration_combos[1]
                    
                    # æ¢å¤é€‰æ‹©
                    preset_index = narration_preset_combo.findText(global_narration_preset)
                    if preset_index >= 0:
                        narration_preset_combo.setCurrentIndex(preset_index)
                        
                        # åŠ è½½æƒ…ç»ªé€‰é¡¹
                        emotions = self.preset_manager.get_preset_emotions(global_narration_preset)
                        narration_emotion_combo.clear()
                        narration_emotion_combo.addItems(emotions)
                        
                        # è®¾ç½®æƒ…ç»ª
                        emotion_index = narration_emotion_combo.findText(global_narration_emotion)
                        if emotion_index >= 0:
                            narration_emotion_combo.setCurrentIndex(emotion_index)
    
    def global_replace(self, search_text: str, replace_text: str):
        """å…¨å±€æ›¿æ¢æ–‡æœ¬"""
        if not search_text:
            QMessageBox.warning(self, "æç¤º", "è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬")
            return
            
        # ä¿å­˜å½“å‰é…ç½®çŠ¶æ€
        current_preset_selections = self._save_current_preset_selections()
        global_narration_preset = getattr(self, 'global_narration_preset', None)
        global_narration_emotion = getattr(self, 'global_narration_emotion', None)
        
        # æ›¿æ¢æ‰€æœ‰æ®µè½ä¸­çš„æ–‡æœ¬
        replace_count = 0
        for i in range(len(self.segments)):
            if search_text in self.segments[i]:
                self.segments[i] = self.segments[i].replace(search_text, replace_text)
                replace_count += self.segments[i].count(replace_text)
        
        # å°†æ›¿æ¢è®°å½•æ·»åŠ åˆ°å†å²ä¸­
        replace_history_manager.add_replace_record(search_text, replace_text)
        
        # æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œç¡®ä¿æ­£ç¡®é‡æ–°åŠ è½½
        for i in reversed(range(self.content_layout.count())):
            widget = self.content_layout.itemAt(i).widget()
            if widget:
                widget.deleteLater()
        
        # é‡æ–°å¤„ç†å½“å‰æ®µè½ï¼Œè¿™å°†ä½¿ç”¨analyze_text_segmentsé‡æ–°è¯†åˆ«å¯¹è¯
        self.process_current_segment()
        
        # æ¢å¤å…¨å±€é¢„è®¾å’Œæ—ç™½é…ç½®
        self._restore_global_narration_preset(global_narration_preset, global_narration_emotion)
        
        # æ¢å¤å„æ–‡æœ¬æ¡†çš„é¢„è®¾é€‰æ‹©
        # æ³¨æ„ï¼šå› ä¸ºæ–‡æœ¬åˆ†æ®µå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦æ ¹æ®æ–‡æœ¬æ¡†IDè¿›è¡ŒåŒ¹é…
        for i in range(self.content_layout.count()):
            widget = self.content_layout.itemAt(i).widget()
            # è·³è¿‡å…¨å±€æ›¿æ¢æ¡†
            if i == 0 and isinstance(widget, QFrame) and "å…¨å±€æ–‡æœ¬æ›¿æ¢" in widget.findChildren(QLabel)[0].text():
                continue
                
            if isinstance(widget, QFrame):
                # æ‰¾åˆ°æ–‡æœ¬æ¡†å’Œæ§åˆ¶é¢æ¿
                text_edit = None
                voice_combo = None
                emotion_combo = None
                
                # æŸ¥æ‰¾æ–‡æœ¬æ¡†
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    # æŸ¥æ‰¾æ–‡æœ¬æ¡†å®¹å™¨
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        for k in range(item.layout().count()):
                            sub_item = item.layout().itemAt(k).widget()
                            if isinstance(sub_item, QTextEdit):
                                text_edit = sub_item
                                break
                
                # æŸ¥æ‰¾æ§åˆ¶é¢æ¿
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        control_layout = item.layout()
                        # æŸ¥æ‰¾é¢„è®¾å’Œæƒ…ç»ªä¸‹æ‹‰æ¡†
                        found_combos = []
                        for k in range(control_layout.count()):
                            control_item = control_layout.itemAt(k).widget()
                            if isinstance(control_item, QComboBox):
                                found_combos.append(control_item)
                                
                        if len(found_combos) >= 2:
                            voice_combo = found_combos[0]
                            emotion_combo = found_combos[1]
                
                # å¦‚æœæ‰¾åˆ°äº†æ‰€æœ‰éœ€è¦çš„æ§ä»¶ï¼Œå°è¯•æ¢å¤é¢„è®¾é€‰æ‹©çŠ¶æ€
                if text_edit and voice_combo and emotion_combo:
                    text_edit_id = text_edit.objectName()
                    # é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…ID
                    if text_edit_id in current_preset_selections:
                        # æ¢å¤é¢„è®¾é€‰æ‹©
                        preset_info = current_preset_selections[text_edit_id]
                        preset = preset_info['preset']
                        preset_index = voice_combo.findText(preset)
                        if preset_index >= 0:
                            voice_combo.setCurrentIndex(preset_index)
                            
                            # æ¢å¤æƒ…ç»ªé€‰æ‹©
                            emotion = preset_info['emotion']
                            emotions = self.preset_manager.get_preset_emotions(preset)
                            emotion_combo.clear()
                            emotion_combo.addItems(emotions)
                            
                            emotion_index = emotion_combo.findText(emotion)
                            if emotion_index >= 0:
                                emotion_combo.setCurrentIndex(emotion_index)
                    else:
                        # å¦‚æœä¸èƒ½ç²¾ç¡®åŒ¹é…IDï¼Œå°è¯•æ ¹æ®æ®µè½ç±»å‹å¯»æ‰¾åŒ¹é…çš„é¢„è®¾
                        segment_frame = widget
                        is_narration = 'faf6f1' in segment_frame.styleSheet()
                        has_speaker_label = any(isinstance(w, QLabel) and "è¯´è¯è€…" in w.text() 
                                               for w in segment_frame.findChildren(QLabel))
                        
                        # å¯¹äºæ—ç™½æ®µè½ï¼Œåº”ç”¨å…¨å±€æ—ç™½é¢„è®¾ï¼ˆå¦‚æœæœ‰ï¼‰
                        if is_narration and not has_speaker_label and global_narration_preset:
                            preset_index = voice_combo.findText(global_narration_preset)
                            if preset_index >= 0:
                                voice_combo.setCurrentIndex(preset_index)
                                
                                # è®¾ç½®æƒ…ç»ª
                                emotions = self.preset_manager.get_preset_emotions(global_narration_preset)
                                emotion_combo.clear()
                                emotion_combo.addItems(emotions)
                                
                                if global_narration_emotion and global_narration_emotion in emotions:
                                    emotion_index = emotion_combo.findText(global_narration_emotion)
                                    if emotion_index >= 0:
                                        emotion_combo.setCurrentIndex(emotion_index)
                        
                        # å¯¹äºå¯¹è¯æ®µè½ï¼ŒæŸ¥æ‰¾ä¸è§’è‰²åŒ¹é…çš„é¢„è®¾
                        if has_speaker_label:
                            speaker_label = next((w for w in segment_frame.findChildren(QLabel) 
                                                if "è¯´è¯è€…" in w.text()), None)
                            if speaker_label:
                                speaker_name = speaker_label.text().replace("è¯´è¯è€…ï¼š", "")
                                # æ ¹æ®è¯´è¯è€…æ‰¾åˆ°å¯¹åº”çš„é¢„è®¾
                                for character, preset_name in self.characters.items():
                                    if character == speaker_name:
                                        preset_index = voice_combo.findText(preset_name)
                                        if preset_index >= 0:
                                            voice_combo.setCurrentIndex(preset_index)
                                            
                                            # è®¾ç½®ç¬¬ä¸€ä¸ªæƒ…ç»ªï¼ˆå¦‚æœæœ‰ï¼‰
                                            emotions = self.preset_manager.get_preset_emotions(preset_name)
                                            emotion_combo.clear()
                                            emotion_combo.addItems(emotions)
                                            
                                            if emotions:
                                                emotion_combo.setCurrentIndex(0)
                                        break
        
        QMessageBox.information(self, "æˆåŠŸ", f"å·²å…¨å±€æ›¿æ¢ {search_text} ä¸º {replace_text}ï¼Œå…±æ›¿æ¢äº† {replace_count} å¤„æ–‡æœ¬")
    
    def copy_text_content(self, text_edit: QTextEdit):
        """å¤åˆ¶æ–‡æœ¬æ¡†å†…å®¹åˆ°å‰ªè´´æ¿"""
        text = text_edit.toPlainText()
        clipboard = QApplication.clipboard()
        clipboard.setText(text)
        QMessageBox.information(self, "æç¤º", "æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
    
    def cut_text_content(self, text_edit: QTextEdit):
        """å‰ªåˆ‡æ–‡æœ¬æ¡†å†…å®¹åˆ°å‰ªè´´æ¿"""
        text = text_edit.toPlainText()
        clipboard = QApplication.clipboard()
        clipboard.setText(text)
        text_edit.clear()
        QMessageBox.information(self, "æç¤º", "æ–‡æœ¬å·²å‰ªåˆ‡åˆ°å‰ªè´´æ¿")
    
    def delete_text_content(self, text_edit: QTextEdit):
        """åˆ é™¤æ–‡æœ¬æ¡†å†…å®¹"""
        # ç›´æ¥æ¸…é™¤æ–‡æœ¬å†…å®¹
        text_edit.clear()
        
        # è§†è§‰åé¦ˆ
        button = self.sender()
        if button:
            original_style = button.styleSheet()
            button.setStyleSheet("""
                QPushButton {
                    background-color: #C5D8EC;
                    color: white;
                    border: none;
                    padding: 5px;
                    max-width: 60px;
                    border-radius: 4px;
                }
            """)
            QTimer.singleShot(500, lambda: button.setStyleSheet(original_style))
    
    def save_text_content(self, text_edit: QTextEdit):
        """ä¿å­˜æ–‡æœ¬æ¡†å†…å®¹åˆ°processedæ–‡ä»¶ï¼Œæ›´æ–°segments.txtæ–‡ä»¶"""
        try:
            # è·å–å½“å‰æ–‡æœ¬
            new_text = text_edit.toPlainText()
            
            # è·å–å½“å‰æ–‡æœ¬æ¡†IDï¼Œè§£æå‡ºæ®µè½å’Œæ¡†åºå·
            text_edit_id = text_edit.objectName()
            parts = text_edit_id.split('_')
            if len(parts) >= 2:
                segment_index = int(parts[0])
                
                # æ‰¾å‡ºå½“å‰æ®µè½çš„æ‰€æœ‰æ–‡æœ¬æ¡†å†…å®¹
                segment_text_edits = []
                
                # éå†å½“å‰å¸ƒå±€ä¸­çš„æ‰€æœ‰æ¡†ï¼Œæ‰¾å‡ºå±äºå½“å‰æ®µè½çš„æ–‡æœ¬æ¡†
                for i in range(1, self.content_layout.count()):  # è·³è¿‡ç¬¬0ä¸ªå…¨å±€æ›¿æ¢æ¡†
                    widget = self.content_layout.itemAt(i).widget()
                    if isinstance(widget, QFrame):
                        # æŸ¥æ‰¾æ–‡æœ¬æ¡†
                        for j in range(widget.layout().count()):
                            item = widget.layout().itemAt(j).widget()
                            if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                                for k in range(item.layout().count()):
                                    sub_item = item.layout().itemAt(k).widget()
                                    if isinstance(sub_item, QTextEdit):
                                        item_id = sub_item.objectName()
                                        if item_id.startswith(f"{segment_index}_"):
                                            segment_text_edits.append((item_id, sub_item.toPlainText()))
                
                # æŒ‰IDæ’åºï¼Œç¡®ä¿æ–‡æœ¬æ¡†é¡ºåºæ­£ç¡®
                segment_text_edits.sort(key=lambda x: x[0])
                
                # å°†è¿™ä¸ªæ®µè½çš„æ‰€æœ‰æ–‡æœ¬æ¡†å†…å®¹åˆå¹¶æˆå®Œæ•´çš„æ®µè½æ–‡æœ¬
                combined_text = ''.join([text for _, text in segment_text_edits])
                
                # æ›´æ–°å†…å­˜ä¸­çš„segmentsæ•°ç»„
        
                
                
                # æŸ¥æ‰¾processedæ–‡ä»¶å¤¹å’Œsegments.txtæ–‡ä»¶
                main_window = self.window()
                source_filename = "unknown"
                
                if hasattr(main_window, 'current_file') and main_window.current_file:
                    # ä»MainWindowè·å–å½“å‰æ–‡ä»¶è·¯å¾„
                    source_filename = os.path.splitext(os.path.basename(main_window.current_file))[0]
                
                working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
                processed_dir = os.path.join(working_dir, f"{source_filename}_processed")
                segments_file = os.path.join(processed_dir, "segments.txt")
                
                # å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¯»å–ç°æœ‰å†…å®¹ï¼Œç„¶åæ›´æ–°å¯¹åº”æ®µè½
                if os.path.exists(segments_file):
                    # è¯»å–æ–‡ä»¶å†…å®¹
                    with open(segments_file, 'r', encoding='utf-8') as f:
                        lines = f.readlines()
                    
                    # æ‰¾åˆ°å¯¹åº”æ®µè½çš„å¼€å§‹å’Œç»“æŸè¡Œ
                    start_line = -1
                    end_line = -1
                    current_segment = -1
                    
                    for i, line in enumerate(lines):
                        if line.startswith(f"[æ®µè½ {segment_index + 1}]"):
                            start_line = i
                            current_segment = segment_index
                        elif current_segment == segment_index and line.startswith("[æ®µè½ "):
                            end_line = i
                            break
                    
                    # å¦‚æœæ‰¾åˆ°äº†ç»“æŸè¡Œï¼Œåˆ™æ›´æ–°å†…å®¹
                    if start_line != -1:
                        if end_line == -1:  # å¦‚æœæ˜¯æœ€åä¸€æ®µï¼Œç»“æŸè¡Œæ˜¯æ–‡ä»¶æœ«å°¾
                            end_line = len(lines)
                        
                        # æ›¿æ¢æ®µè½å†…å®¹
                        new_content = [f"[æ®µè½ {segment_index + 1}]\n", combined_text + "\n\n"]
                        lines[start_line:end_line] = new_content
                        
                        # å†™å›æ–‡ä»¶
                        with open(segments_file, 'w', encoding='utf-8') as f:
                            f.writelines(lines)
                        
                        QMessageBox.information(self, "æˆåŠŸ", f"å·²ä¿å­˜æ®µè½ {segment_index + 1} çš„æ›´æ”¹åˆ°æ–‡ä»¶")
                    else:
                        QMessageBox.warning(self, "é”™è¯¯", f"æœªæ‰¾åˆ°æ®µè½ {segment_index + 1} åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®")
                else:
                    QMessageBox.warning(self, "é”™è¯¯", f"æ‰¾ä¸åˆ°å¤„ç†æ–‡ä»¶ï¼š{segments_file}")
            else:
                QMessageBox.warning(self, "é”™è¯¯", "æ— æ³•è§£ææ–‡æœ¬æ¡†ID")
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"ä¿å­˜æ–‡æœ¬æ—¶å‡ºé”™ï¼š{str(e)}")
    
    def paste_text_content(self, text_edit: QTextEdit):
        """å°†å‰ªè´´æ¿å†…å®¹é™„åŠ åˆ°æ–‡æœ¬æ¡†æœ«å°¾"""
        try:
            # è·å–å‰ªè´´æ¿å†…å®¹
            clipboard = QApplication.clipboard()
            text = clipboard.text()
            
            if not text:
                QMessageBox.information(self, "æç¤º", "å‰ªè´´æ¿ä¸ºç©º")
                return
            
            # è·å–å½“å‰æ–‡æœ¬æ¡†å†…å®¹
            current_text = text_edit.toPlainText()
            
            # é™„åŠ å‰ªè´´æ¿å†…å®¹åˆ°æ–‡æœ¬æ¡†æœ«å°¾
            text_edit.setText(current_text + text)
            
            # å°†å…‰æ ‡ç§»åˆ°æœ«å°¾
            cursor = text_edit.textCursor()
            cursor.movePosition(QTextCursor.MoveOperation.End)
            text_edit.setTextCursor(cursor)
            
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"ç²˜è´´æ–‡æœ¬æ—¶å‡ºé”™ï¼š{str(e)}")
    
    def show_preset_management(self):
        """æ˜¾ç¤ºé¢„è®¾ç®¡ç†é¡µé¢"""
        # ä¿å­˜å½“å‰æ®µè½ç´¢å¼•ï¼Œä»¥ä¾¿è¿”å›æ—¶æ¢å¤
        self.saved_segment_index = self.current_segment_index
        
        # ä¿å­˜å½“å‰æ–‡æœ¬æ¡†çš„æ‰€æœ‰é¢„è®¾å’Œæƒ…ç»ªé€‰æ‹©çŠ¶æ€
        self.saved_preset_selections = self._save_current_preset_selections()
        
        # ä¿å­˜å…¨å±€æ—ç™½é¢„è®¾ï¼ˆå¦‚æœæœ‰ï¼‰
        self.saved_global_narration_preset = getattr(self, 'global_narration_preset', None)
        self.saved_global_narration_emotion = getattr(self, 'global_narration_emotion', None)
        
        # è·å–ä¸»çª—å£
        main_window = self.window()
        if isinstance(main_window, MainWindow):
            # è®¾ç½®ä¸€ä¸ªæ ‡è¯†ï¼Œè¡¨ç¤ºæ˜¯ä»æ®µè½é¡µé¢è·³è½¬è¿‡æ¥çš„
            self.is_from_segment_process = True
            # è°ƒç”¨ä¸»çª—å£çš„é¢„è®¾ç®¡ç†æ–¹æ³•
            main_window.show_preset_setting(source_page="segment")
    
    def generate_all_audio(self):
        """ä¸€é”®ç”Ÿæˆæ‰€æœ‰æ–‡æœ¬æ¡†çš„éŸ³é¢‘"""
        # æ”¶é›†æ‰€æœ‰éœ€è¦ç”Ÿæˆçš„æ–‡æœ¬æ¡†ä¿¡æ¯
        text_boxes = []
        
        # éå†å†…å®¹å¸ƒå±€ä¸­çš„æ‰€æœ‰æ–‡æœ¬æ¡†
        for i in range(self.content_layout.count()):
            widget = self.content_layout.itemAt(i).widget()
            # è·³è¿‡å…¨å±€æ›¿æ¢æ¡†
            if i == 0 and isinstance(widget, QFrame) and "å…¨å±€æ–‡æœ¬æ›¿æ¢" in widget.findChildren(QLabel)[0].text():
                continue
                
            if isinstance(widget, QFrame):
                # æ‰¾åˆ°æ–‡æœ¬æ¡†å’Œæ§åˆ¶é¢æ¿
                text_edit = None
                voice_combo = None
                emotion_combo = None
                generate_btn = None
                regenerate_btn = None
                preview_btn = None
                status_label = None
                
                # æŸ¥æ‰¾æ–‡æœ¬æ¡†
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    # æŸ¥æ‰¾æ–‡æœ¬æ¡†å®¹å™¨
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        for k in range(item.layout().count()):
                            sub_item = item.layout().itemAt(k).widget()
                            if isinstance(sub_item, QTextEdit):
                                text_edit = sub_item
                                break
                
                # æŸ¥æ‰¾æ§åˆ¶é¢æ¿
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        control_layout = item.layout()
                        # æŸ¥æ‰¾æ§ä»¶
                        for k in range(control_layout.count()):
                            control_item = control_layout.itemAt(k).widget()
                            if isinstance(control_item, QComboBox):
                                if voice_combo is None:
                                    voice_combo = control_item
                                elif emotion_combo is None:
                                    emotion_combo = control_item
                            elif isinstance(control_item, QPushButton):
                                if "ç”Ÿæˆ" == control_item.text():
                                    generate_btn = control_item
                                elif "é‡æ–°ç”Ÿæˆ" == control_item.text():
                                    regenerate_btn = control_item
                                elif "è¯•å¬" == control_item.text():
                                    preview_btn = control_item
                            elif isinstance(control_item, QLabel) and control_item.text() in ["ğŸ”„", "â³", "ğŸŒ·", "ğŸ¥³","âŒ", "â“"]:
                                status_label = control_item
                
                # å¦‚æœæ‰¾åˆ°äº†æ‰€æœ‰éœ€è¦çš„æ§ä»¶ï¼Œå¹¶ä¸”æ–‡æœ¬æ¡†éç©º
                if text_edit and voice_combo and emotion_combo and text_edit.toPlainText().strip():
                    text_boxes.append((text_edit, voice_combo, emotion_combo, generate_btn, regenerate_btn, preview_btn, status_label))
        
        if not text_boxes:
            QMessageBox.information(self, "æç¤º", "æ²¡æœ‰æ‰¾åˆ°éœ€è¦ç”Ÿæˆçš„æ–‡æœ¬")
            return
        
        # åˆ›å»ºè¿›åº¦å¯¹è¯æ¡†
        progress = QProgressDialog("æ­£åœ¨ç”ŸæˆéŸ³é¢‘...", "å–æ¶ˆ", 0, len(text_boxes), self)
        progress.setWindowTitle("æ‰¹é‡ç”Ÿæˆ")
        progress.setWindowModality(Qt.WindowModality.WindowModal)
        progress.setMinimumWidth(300)
        progress.show()
        
        # æ–°å¢å˜é‡è®°å½•å‰ä¸€ä¸ªæ–‡æœ¬æ¡†å­—æ•°
        prev_char_count = 0
        
        # ç”Ÿæˆæ¯ä¸ªæ–‡æœ¬æ¡†çš„éŸ³é¢‘
        for i, (text_edit, voice_combo, emotion_combo, generate_btn, regenerate_btn, preview_btn, status_label) in enumerate(text_boxes):
            # æ›´æ–°è¿›åº¦
            progress.setValue(i)
            progress.setLabelText(f"æ­£åœ¨ç”Ÿæˆ {i+1}/{len(text_boxes)}")
            
            # æ·»åŠ ç­‰å¾…é€»è¾‘ï¼ˆä»ç¬¬äºŒä¸ªæ–‡æœ¬æ¡†å¼€å§‹ï¼‰
            if i > 0:
                time.sleep(prev_char_count/2)  # ä½¿ç”¨å‰ä¸€ä¸ªæ–‡æœ¬æ¡†çš„å­—æ•°ä½œä¸ºç­‰å¾…ç§’æ•°
            
            # å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œåˆ™ä¸­æ–­
            if progress.wasCanceled():
                break
            
            # ç”ŸæˆéŸ³é¢‘
            preset_name = voice_combo.currentText()
            emotion = emotion_combo.currentText()
            self.generate_audio(text_edit, preset_name, emotion, generate_btn, regenerate_btn, preview_btn, status_label)
            
            # è®°å½•å½“å‰æ–‡æœ¬æ¡†å­—æ•°ä¾›ä¸‹ä¸€ä¸ªå¾ªç¯ä½¿ç”¨
            prev_char_count = len(text_edit.toPlainText().strip())
            
            # å¤„ç†äº‹ä»¶ï¼Œä¿æŒUIå“åº”
            QApplication.processEvents()
        
        # å…³é—­è¿›åº¦å¯¹è¯æ¡†
        progress.close()
        
        # æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        QMessageBox.information(self, "å®Œæˆ", "æ‰€æœ‰éŸ³é¢‘ç”Ÿæˆå®Œæˆï¼")
    
    def merge_segment_audio(self):
        """åˆå¹¶å½“å‰æ®µè½æ‰€æœ‰éŸ³é¢‘"""
        # è·å–åŸå§‹æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åå’Œè·¯å¾„ï¼‰
        # å°è¯•ä»MainWindowè·å–å½“å‰å¤„ç†çš„æ–‡ä»¶å
        main_window = self.window()
        source_filename = "segment"
        
        if hasattr(main_window, 'current_file') and main_window.current_file:
            # ä»MainWindowè·å–å½“å‰æ–‡ä»¶è·¯å¾„
            source_filename = os.path.splitext(os.path.basename(main_window.current_file))[0]
        
        # åˆ›å»ºWorkingç›®å½•ä¸­çš„ä¿å­˜è·¯å¾„
        working_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "Working")
        processed_dir = os.path.join(working_dir, f"{source_filename}_processed")
        audio_dir = os.path.join(processed_dir, "audio_segments")
        
        # æ£€æŸ¥éŸ³é¢‘ç›®å½•æ˜¯å¦å­˜åœ¨
        if not os.path.exists(audio_dir):
            QMessageBox.warning(self, "è­¦å‘Š", "éŸ³é¢‘ç›®å½•ä¸å­˜åœ¨")
            return
        
        # è·å–å½“å‰æ®µè½æ‰€æœ‰éç©ºæ–‡æœ¬æ¡†
        text_boxes = []
        text_box_contents = {}
        
        # éå†å†…å®¹å¸ƒå±€ä¸­çš„æ‰€æœ‰æ–‡æœ¬æ¡†
        for i in range(self.content_layout.count()):
            widget = self.content_layout.itemAt(i).widget()
            # è·³è¿‡å…¨å±€æ›¿æ¢æ¡†
            if i == 0 and isinstance(widget, QFrame) and "å…¨å±€æ–‡æœ¬æ›¿æ¢" in widget.findChildren(QLabel)[0].text():
                continue
                
            if isinstance(widget, QFrame):
                # æŸ¥æ‰¾æ–‡æœ¬æ¡†
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    # æŸ¥æ‰¾æ–‡æœ¬æ¡†å®¹å™¨
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        for k in range(item.layout().count()):
                            sub_item = item.layout().itemAt(k).widget()
                            if isinstance(sub_item, QTextEdit):
                                text_edit = sub_item
                                text_content = text_edit.toPlainText().strip()
                                if text_content:  # åªå¤„ç†éç©ºæ–‡æœ¬æ¡†
                                    text_edit_id = text_edit.objectName()
                                    try:
                                        _, box_idx = map(int, text_edit_id.split('_'))
                                        text_boxes.append(box_idx)
                                        text_box_contents[box_idx] = text_content
                                    except Exception as e:
                                        pass  # è§£ææ–‡æœ¬æ¡†IDå‡ºé”™
                                break
        
        if not text_boxes:
            QMessageBox.warning(self, "è­¦å‘Š", "æ®µè½ä¸­æ²¡æœ‰éç©ºæ–‡æœ¬æ¡†")
            return
        
        text_boxes = [i + 1 for i in text_boxes]

        
            
        # ç›´æ¥ä»éŸ³é¢‘ç›®å½•æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…å½“å‰æ®µè½çš„éŸ³é¢‘æ–‡ä»¶
        audio_files = []
        found_audio_box_indices = set()
        
        # åˆ›å»ºåŒ¹é…å½“å‰æ®µè½çš„æ­£åˆ™è¡¨è¾¾å¼
        import re
        # æ®µè½åºå·å¯èƒ½æ˜¯å¤šä½æ•°ï¼Œå‰é¢å¯èƒ½æœ‰0å¡«å……
        segment_pattern = rf"{re.escape(source_filename)}_æ®µè½0*{self.current_segment_index + 1}_æ–‡æœ¬æ¡†(\d+)\.wav"
        segment_regex = re.compile(segment_pattern)
        

        
        # éå†éŸ³é¢‘ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
        for filename in os.listdir(audio_dir):
            match = segment_regex.match(filename)
            if match:
                try:
                    # æå–æ–‡æœ¬æ¡†åºå·
                    box_idx = int(match.group(1))
                    audio_path = os.path.join(audio_dir, filename)
                    audio_files.append((box_idx, audio_path))
                    found_audio_box_indices.add(box_idx)
                except Exception as e:
                    continue  # æ— æ³•è§£ææ–‡ä»¶å
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°éŸ³é¢‘æ–‡ä»¶ï¼Œå°è¯•ä»self.segment_audio_statesè·å–ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼‰
        if not audio_files:
            
            for text_edit_id, (is_generated, audio_path) in self.segment_audio_states.items():
                segment_idx, box_idx = map(int, text_edit_id.split('_'))
                if segment_idx == self.current_segment_index and is_generated and os.path.exists(audio_path):
                    audio_files.append((box_idx, audio_path))
                    found_audio_box_indices.add(box_idx)
        
        if not audio_files:
            QMessageBox.warning(self, "è­¦å‘Š", "æ²¡æœ‰æ‰¾åˆ°å¯åˆå¹¶çš„éŸ³é¢‘æ–‡ä»¶")
            return
        
        # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰éç©ºæ–‡æœ¬æ¡†éƒ½æœ‰å¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶
        missing_boxes = []
        for box_idx in text_boxes:
            if box_idx not in found_audio_box_indices:
                missing_boxes.append(box_idx)
        
        
        if missing_boxes:
            missing_details = []
            for box_idx in missing_boxes:
                # æˆªå–å‰30ä¸ªå­—ç¬¦åŠ çœç•¥å·ï¼Œä½œä¸ºå†…å®¹é¢„è§ˆ
                content_preview = text_box_contents[box_idx-1][:30]
                if len(text_box_contents[box_idx-1]) > 30:
                    content_preview += "..."
                missing_details.append(f"æ–‡æœ¬æ¡†{box_idx}: {content_preview}")
                
            missing_info = "\n".join(missing_details)
            
            reply = QMessageBox.question(
                self,
                "éŸ³é¢‘æ–‡ä»¶ä¸å®Œæ•´",
                f"ä»¥ä¸‹{len(missing_boxes)}ä¸ªæ–‡æœ¬æ¡†æ²¡æœ‰å¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶:\n{missing_info}\n\næ˜¯å¦ä»è¦ç»§ç»­åˆå¹¶?",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                QMessageBox.StandardButton.No
            )
            
            if reply == QMessageBox.StandardButton.No:
                return
        
        # æŒ‰ç…§æ¡†åºå·æ’åº
        audio_files.sort()

        
        # åˆ›å»ºæ®µè½åˆå¹¶éŸ³é¢‘ç›®å½•
        merged_segments_dir = os.path.join(processed_dir, "merged_segments")
        os.makedirs(merged_segments_dir, exist_ok=True)
        
        # ç”Ÿæˆåˆå¹¶éŸ³é¢‘çš„æ–‡ä»¶å
        output_file = os.path.join(merged_segments_dir, f"{source_filename}_æ®µè½{self.current_segment_index + 1}.wav")
        
        try:
            # ä½¿ç”¨å¤–éƒ¨å‘½ä»¤åˆå¹¶éŸ³é¢‘
            from pydub import AudioSegment
            
            # åˆå¹¶éŸ³é¢‘
            combined = AudioSegment.empty()
            for _, audio_path in audio_files:
                segment = AudioSegment.from_wav(audio_path)
                combined += segment
            
            # å¯¼å‡ºåˆå¹¶åçš„éŸ³é¢‘ï¼ˆè‡ªåŠ¨è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶ï¼‰
            combined.export(output_file, format="wav")
            
            QMessageBox.information(self, "æˆåŠŸ", f"éŸ³é¢‘å·²åˆå¹¶å¹¶ä¿å­˜ä¸º:\n{output_file}")
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"åˆå¹¶éŸ³é¢‘å¤±è´¥: {str(e)}")
    
    def analyze_text_segments(self, text: str) -> List[Tuple[str, str, Optional[str]]]:
        """
        åˆ†ææ–‡æœ¬ï¼Œå°†å…¶åˆ†å‰²ä¸ºæ—ç™½å’Œå¯¹è¯æ®µè½
        è¿”å›æ ¼å¼ï¼šList of (segment_type, content, speaker)
            segment_type: "narration" æˆ– "dialogue"
            content: æ®µè½å†…å®¹
            speaker: è¯´è¯è€…ï¼ˆå¯¹è¯æ—¶ï¼‰æˆ– Noneï¼ˆæ—ç™½æ—¶ï¼‰
        """
        
        
        # ç»Ÿä¸€æ–‡æœ¬ç¼–ç å’Œå¼•å·
        
        # ç¡®ä¿æ–‡æœ¬æ˜¯UTF-8ç¼–ç 
        if not isinstance(text, str):
            text = text.decode('utf-8')
        
        # ä¿®æ”¹åçš„å¯¹è¯è¯†åˆ«ç®—æ³•
        
        segments = []
        last_end = 0
        
        # æŸ¥æ‰¾æ‰€æœ‰ä¸­æ–‡å·¦å¼•å·"\u201c"å’Œä¸­æ–‡å³å¼•å·"\u201d"çš„ä½ç½®
        left_quotes = []
        right_quotes = []
        
        for i, char in enumerate(text):
            if char == '\u201c':  # ä¸­æ–‡å·¦å¼•å·
                left_quotes.append(i)
            elif char == '\u201d':  # ä¸­æ–‡å³å¼•å·
                right_quotes.append(i)
        
        
        
        # æ ‡ç‚¹ç¬¦å·åˆ—è¡¨
        punctuation_marks = "ï¼Œã€‚ï¼ï¼Ÿâ€¦ï½ï¼Œ~,.!?"
        
        dialogue_count = 0
        narration_count = 0
        
        i = 0  # å·¦å¼•å·ç´¢å¼•
        j = 0  # å³å¼•å·ç´¢å¼•
        
        # åŒ¹é…å·¦å³å¼•å·å¯¹
        while i < len(left_quotes) and j < len(right_quotes):
            start_quote_pos = left_quotes[i]
            
            # æ‰¾åˆ°ä¸‹ä¸€ä¸ªåœ¨å·¦å¼•å·ä¹‹åçš„å³å¼•å·
            while j < len(right_quotes) and right_quotes[j] <= start_quote_pos:
                j += 1
                
            if j >= len(right_quotes):
                break  # æ²¡æœ‰æ›´å¤šå³å¼•å·
                
            end_quote_pos = right_quotes[j]
            
            # æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼šå³å¼•å·çš„å·¦è¾¹ä¸€ä¸ªå­—ç¬¦å¿…é¡»æ˜¯æŒ‡å®šçš„æ ‡ç‚¹ç¬¦å·
            is_valid_dialogue = False
            if end_quote_pos > 1 and end_quote_pos - 1 < len(text):
                last_char_before_right_quote = text[end_quote_pos - 1]
                is_valid_dialogue = last_char_before_right_quote in punctuation_marks
            
            
            
            # æå–æ½œåœ¨çš„å¯¹è¯å†…å®¹ï¼ˆä¸åŒ…æ‹¬å¼•å·ï¼‰
            dialogue_content = text[start_quote_pos + 1:end_quote_pos]
            
            
            # å¦‚æœå†…å®¹åˆæ³•ï¼ˆå³å¼•å·å‰æ˜¯æ ‡ç‚¹ç¬¦å·ï¼‰ï¼Œåˆ™è§†ä¸ºå¯¹è¯
            if is_valid_dialogue:
                # å¦‚æœå¯¹è¯å‰æœ‰å†…å®¹ï¼Œæ·»åŠ ä¸ºæ—ç™½
                if start_quote_pos > last_end:
                    narration = text[last_end:start_quote_pos].strip()
                    if narration:
                        narration_count += 1
                        
                        
                        # è·å–æ—ç™½çš„æœ€å150å­—ç¬¦
                        narration_last_chars = narration[-150:] if len(narration) > 150 else narration
                        
                        
                        
                        segments.append(("narration", narration, None))
                
                # åˆ†æå¯¹è¯ä¸Šä¸‹æ–‡ï¼ŒæŸ¥æ‰¾è¯´è¯è€…
                context_start = max(0, start_quote_pos - 150)  # å‘å‰æŸ¥æ‰¾150ä¸ªå­—ç¬¦
                context_end = start_quote_pos
                context = text[context_start:context_end]
                
                # æŸ¥æ‰¾è¯´è¯è€…
                speaker = None
                closest_match_position = -1  # è®°å½•æœ€è¿‘åŒ¹é…çš„ä½ç½®
                closest_speaker = None       # æœ€è¿‘çš„è¯´è¯è€…
                
                
                for char, preset in self.characters.items():
                    
                    # è·å–é¢„è®¾ä¿¡æ¯
                    preset_info = self.preset_manager.get_preset(preset)
                    if preset_info and preset_info[0].get('character_info'):
                        char_info = preset_info[0]['character_info']
                        # æå–å§“æ°ï¼ˆåº”ä½¿ç”¨é¢„è®¾ä¸­çš„å§“æ°ï¼‰
                        full_name = char_info.get('name', '')
                        surname = char_info.get('surname', '')
                        if not surname and full_name:
                            surname = full_name[:1]  # å¦‚æœæ²¡æœ‰é¢„è®¾å§“æ°ï¼Œä½¿ç”¨åå­—çš„ç¬¬ä¸€ä¸ªå­—ç¬¦
                        
                        # æ£€æŸ¥å§“åã€å°åã€å§“æ°æ˜¯å¦åœ¨ä¸Šä¸‹æ–‡ä¸­
                        name_patterns = [
                            char,  # åŸå
                            full_name,  # é¢„è®¾å§“å
                            char_info.get('nickname', ''),  # é¢„è®¾å°å
                            surname  # å§“æ°
                        ]
                        
                        
                        # æŸ¥æ‰¾æ¯ä¸ªæ¨¡å¼æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼ˆç¦»å¯¹è¯æœ€è¿‘ï¼‰
                        for pattern in name_patterns:
                            if pattern and pattern in context:
                                # æ‰¾åˆ°è¿™ä¸ªæ¨¡å¼æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®
                                last_pos = context.rfind(pattern)
                                if last_pos > closest_match_position:
                                    closest_match_position = last_pos
                                    closest_speaker = char
                                    
                
                # ä½¿ç”¨æ‰¾åˆ°çš„æœ€è¿‘è¯´è¯è€…
                if closest_speaker:
                    speaker = closest_speaker
                    
            
                
                # è·å–å¯¹è¯çš„æœ€å150å­—ç¬¦
                dialogue_last_chars = dialogue_content[-150:] if len(dialogue_content) > 150 else dialogue_content
                dialogue_count += 1
                
                
                
                # æ·»åŠ å¯¹è¯æ®µè½
                segments.append(("dialogue", dialogue_content, speaker))
                last_end = end_quote_pos + 1
            else:
                # å°†è¿™ä¸ªä¸ç¬¦åˆè¦æ±‚çš„å¯¹è¯è§†ä¸ºæ™®é€šæ–‡æœ¬çš„ä¸€éƒ¨åˆ†ï¼Œä¸åšç‰¹åˆ«å¤„ç†
                pass
            
            # ç§»åˆ°ä¸‹ä¸€ä¸ªå·¦å¼•å·
            i += 1
            # å³å¼•å·å·²ç»ç”¨è¿‡ï¼Œä¹Ÿç§»åˆ°ä¸‹ä¸€ä¸ª
            j += 1
        
        # å¦‚æœæœ€åè¿˜æœ‰å†…å®¹ï¼Œæ·»åŠ ä¸ºæ—ç™½
        if last_end < len(text):
            narration = text[last_end:].strip()
            if narration:
                narration_count += 1
        
                
                # è·å–æ—ç™½çš„æœ€å150å­—ç¬¦
                narration_last_chars = narration[-150:] if len(narration) > 150 else narration
                
                
                
                segments.append(("narration", narration, None))
        
        
        
        # æœ€ç»ˆæ®µè½è¯¦ç»†ä¿¡æ¯
        for i, (type_, content, speaker) in enumerate(segments, 1):
            # è·å–æ®µè½çš„æœ€å150å­—ç¬¦
            segment_last_chars = content[-150:] if len(content) > 150 else content
            
            
        

        
        return segments

    def save_narration_preset(self, preset_name: str):
        """ä¿å­˜é€‰æ‹©çš„æ—ç™½é¢„è®¾"""
        self.global_narration_preset = preset_name
    
    def save_narration_emotion(self, emotion: str):
        """ä¿å­˜é€‰æ‹©çš„æ—ç™½æƒ…ç»ª"""
        self.global_narration_emotion = emotion
    
    def on_narration_preset_changed(self, preset_name: str, emotion_combo: QComboBox):
        """å½“æ—ç™½é¢„è®¾é€‰æ‹©æ”¹å˜æ—¶ï¼Œæ›´æ–°æƒ…ç»ªé€‰é¡¹"""
        emotions = self.preset_manager.get_preset_emotions(preset_name)
        emotion_combo.clear()
        emotion_combo.addItems(emotions)
        if emotions:
            emotion_combo.setCurrentIndex(0)
    
    def apply_narration_preset(self, preset_name: str, emotion: str):
        """åº”ç”¨æ—ç™½é¢„è®¾åˆ°æ‰€æœ‰æ—ç™½æ®µè½å’Œæ²¡æœ‰è¯†åˆ«åˆ°è¯´è¯è€…çš„å¯¹è¯æ®µè½"""
        if not preset_name:
            QMessageBox.warning(self, "æç¤º", "è¯·é€‰æ‹©æ—ç™½é¢„è®¾")
            return
            
        # æŸ¥æ‰¾å½“å‰æ®µè½ä¸­æ‰€æœ‰æ—ç™½æ–‡æœ¬æ¡†å’Œæ²¡æœ‰è¯†åˆ«åˆ°è¯´è¯è€…çš„å¯¹è¯æ®µè½
        updated_segments = 0
        
        # ä»ç¬¬1ä¸ªwidgetå¼€å§‹éå†ï¼Œè·³è¿‡ç¬¬0ä¸ªwidgetï¼ˆå…¨å±€æ›¿æ¢æ¡†ï¼‰
        for i in range(1, self.content_layout.count()):
            widget = self.content_layout.itemAt(i).widget()
            if isinstance(widget, QFrame):
                # æŸ¥æ‰¾åœ¨è¯¥æ¡†æ¶å†…çš„ç¬¬ä¸€ä¸ªQTextEditï¼Œæ£€æŸ¥å®ƒæ˜¯å¦æ˜¯æ—ç™½ç±»å‹
                text_edit = None
                for j in range(widget.layout().count()):
                    item = widget.layout().itemAt(j).widget()
                    if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                        for k in range(item.layout().count()):
                            sub_item = item.layout().itemAt(k).widget()
                            if isinstance(sub_item, QTextEdit):
                                text_edit = sub_item
                                break
                        if text_edit:
                            break
                
                # æ£€æŸ¥è¿™ä¸ªæ–‡æœ¬æ¡†æ˜¯å¦å¯¹åº”çš„æ˜¯æ—ç™½æ®µè½æˆ–æ²¡æœ‰è¯†åˆ«åˆ°è¯´è¯è€…çš„å¯¹è¯æ®µè½
                if text_edit and hasattr(text_edit, "objectName"):
                    text_edit_id = text_edit.objectName()
                    segment_idx, box_idx = map(int, text_edit_id.split('_'))
                    
                    # è·å–è¯¥æ®µè½çš„ç±»å‹å’Œè¯´è¯è€…
                    segments = self.analyze_text_segments(self.segments[self.current_segment_index])
                    if box_idx < len(segments) and (
                        segments[box_idx][0] == "narration" or  # æ—ç™½æ®µè½
                        (segments[box_idx][0] == "dialogue" and segments[box_idx][2] is None)  # æ²¡æœ‰è¯†åˆ«åˆ°è¯´è¯è€…çš„å¯¹è¯æ®µè½
                    ):
                        # è¿™æ˜¯éœ€è¦åº”ç”¨å…¨å±€æ—ç™½é¢„è®¾çš„æ®µè½
                        updated_segments += 1
                        
                        # æŸ¥æ‰¾æ§åˆ¶é¢æ¿
                        control_panel = None
                        for j in range(widget.layout().count()):
                            item = widget.layout().itemAt(j).widget()
                            if isinstance(item, QWidget) and item.layout() and isinstance(item.layout(), QHBoxLayout):
                                # æ£€æŸ¥æ˜¯å¦åŒ…å«é…éŸ³å’Œæƒ…ç»ªä¸‹æ‹‰æ¡†
                                has_voice_combo = False
                                has_emotion_combo = False
                                for k in range(item.layout().count()):
                                    sub_item = item.layout().itemAt(k).widget()
                                    if isinstance(sub_item, QLabel) and "é…éŸ³" in sub_item.text():
                                        has_voice_combo = True
                                    if isinstance(sub_item, QLabel) and "æƒ…ç»ª" in sub_item.text():
                                        has_emotion_combo = True
                                
                                if has_voice_combo and has_emotion_combo:
                                    control_panel = item
                                    break
                
                        if control_panel:
                            # è®¾ç½®é¢„è®¾
                            preset_combo = None
                            emotion_combo = None
                            
                            # æŸ¥æ‰¾é¢„è®¾å’Œæƒ…ç»ªä¸‹æ‹‰æ¡†
                            for j in range(control_panel.layout().count()):
                                item = control_panel.layout().itemAt(j).widget()
                                if isinstance(item, QComboBox):
                                    if not preset_combo:
                                        preset_combo = item  # ç¬¬ä¸€ä¸ªä¸‹æ‹‰æ¡†æ˜¯é¢„è®¾
                                    else:
                                        emotion_combo = item  # ç¬¬äºŒä¸ªä¸‹æ‹‰æ¡†æ˜¯æƒ…ç»ª
                                        break
                            
                            # åº”ç”¨é¢„è®¾å’Œæƒ…ç»ª
                            if preset_combo:
                                index = preset_combo.findText(preset_name)
                                if index >= 0:
                                    preset_combo.setCurrentIndex(index)
                                    segment_type = "æ—ç™½" if segments[box_idx][0] == "narration" else "æ— è¯´è¯è€…å¯¹è¯"
                        
                            
                            # åº”ç”¨æƒ…ç»ªï¼ˆå¦‚æœæ‰¾åˆ°äº†æƒ…ç»ªä¸‹æ‹‰æ¡†ä¸”æœ‰å¯¹åº”çš„æƒ…ç»ªé€‰é¡¹ï¼‰
                            if emotion_combo:
                                index = emotion_combo.findText(emotion)
                                if index >= 0:
                                    emotion_combo.setCurrentIndex(index)
                                    
        
        if updated_segments > 0:
            QMessageBox.information(self, "æˆåŠŸ", f"å·²å°†å…¨å±€é¢„è®¾åº”ç”¨åˆ° {updated_segments} ä¸ªæ®µè½ï¼ˆåŒ…æ‹¬æ—ç™½å’Œæœªè¯†åˆ«è¯´è¯è€…çš„å¯¹è¯ï¼‰")
        else:
            QMessageBox.information(self, "æç¤º", "å½“å‰æ®µè½ä¸­æ²¡æœ‰æ‰¾åˆ°æ—ç™½æ®µè½æˆ–æœªè¯†åˆ«è¯´è¯è€…çš„å¯¹è¯æ®µè½")
    
    def cut_text_content(self, text_edit: QTextEdit):
        """å‰ªåˆ‡æ–‡æœ¬æ¡†å†…å®¹åˆ°å‰ªè´´æ¿"""
        text = text_edit.toPlainText()
        clipboard = QApplication.clipboard()
        clipboard.setText(text)
        text_edit.clear()
        
        # è§†è§‰åé¦ˆ
        button = self.sender()
        if button:
            original_style = button.styleSheet()
            button.setStyleSheet("""
                QPushButton {
                    background-color: #C5D8EC;
                    color: white;
                    border: none;
                    padding: 5px;
                    max-width: 60px;
                    border-radius: 4px;
                }
            """)
            QTimer.singleShot(500, lambda: button.setStyleSheet(original_style))
            
    def delete_text_content(self, text_edit: QTextEdit):
        """åˆ é™¤æ–‡æœ¬æ¡†å†…å®¹"""
        # ç›´æ¥æ¸…é™¤æ–‡æœ¬å†…å®¹
        text_edit.clear()
        
        # è§†è§‰åé¦ˆ
        button = self.sender()
        if button:
            original_style = button.styleSheet()
            button.setStyleSheet("""
                QPushButton {
                    background-color: #C5D8EC;
                    color: white;
                    border: none;
                    padding: 5px;
                    max-width: 60px;
                    border-radius: 4px;
                }
            """)
            QTimer.singleShot(500, lambda: button.setStyleSheet(original_style))

    def set_position(self, position):
        """è®¾ç½®æ’­æ”¾ä½ç½®"""
        self.player.setPosition(position)
        
    def set_volume(self, volume):
        """è®¾ç½®éŸ³é‡å¤§å°"""
        # è·å–ç³»ç»ŸéŸ³é‡è®¾ç½®ï¼Œç¡®ä¿ä¸ç³»ç»ŸéŸ³é‡åŒæ­¥
        system_volume = QMediaDevices.defaultAudioOutput().volume() * 100
        # ä½¿ç”¨æ»‘å—è®¾ç½®çš„éŸ³é‡æˆ–ç³»ç»ŸéŸ³é‡ï¼ˆå½“æ»‘å—è¢«ç”¨æˆ·ç§»åŠ¨æ—¶ï¼‰
        if volume != self.current_volume:  # ç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´äº†æ»‘å—
            # å°†æ»‘å—çš„0-100å€¼è½¬æ¢ä¸ºQMediaPlayerçš„0.0-1.0éŸ³é‡å€¼
            volume_value = volume / 100.0
            self.audio_output.setVolume(volume_value)
            # ä¿å­˜éŸ³é‡è®¾ç½®ï¼Œä»¥ä¾¿åœ¨åˆ‡æ¢æ®µè½æˆ–é‡æ–°è¯•å¬æ—¶ä¿æŒä¸€è‡´
            self.current_volume = volume
        else:  # ç³»ç»ŸéŸ³é‡æ”¹å˜
            # æ›´æ–°æ»‘å—æ˜¾ç¤º
            self.volume_slider.setValue(int(system_volume))
            # æ›´æ–°éŸ³é¢‘è¾“å‡ºéŸ³é‡
            self.audio_output.setVolume(system_volume / 100.0)
            # ä¿å­˜å½“å‰éŸ³é‡è®¾ç½®
            self.current_volume = int(system_volume)

    def update_replace_history_combo(self, combo: QComboBox):
        """æ›´æ–°æ›¿æ¢å†å²ä¸‹æ‹‰æ¡†"""
        combo.clear()
        
        # è·å–æ‰€æœ‰æ›¿æ¢å†å²
        history = replace_history_manager.get_all_history()
        
        if not history:
            combo.addItem("æ— æ›¿æ¢å†å²")
            return
            
        # æ·»åŠ å†å²è®°å½•åˆ°ä¸‹æ‹‰æ¡†
        for search_text, replace_text in history.items():
            combo.addItem(f"{search_text} â†’ {replace_text}", userData=(search_text, replace_text))
    
    def on_history_selected(self, combo: QComboBox, search_input: QLineEdit, replace_input: QLineEdit):
        """å½“å†å²è®°å½•è¢«é€‰ä¸­æ—¶ï¼Œæ›´æ–°è¾“å…¥æ¡†"""
        if combo.currentData() is None:
            return
            
        search_text, replace_text = combo.currentData()
        search_input.setText(search_text)
        replace_input.setText(replace_text)
    
    def apply_selected_history(self, combo: QComboBox):
        """åº”ç”¨é€‰ä¸­çš„å†å²æ›¿æ¢"""
        if combo.currentData() is None:
            return
            
        search_text, replace_text = combo.currentData()
        self.global_replace(search_text, replace_text)
    
    def remove_selected_history(self, combo: QComboBox):
        """åˆ é™¤é€‰ä¸­çš„å†å²æ›¿æ¢"""
        if combo.currentData() is None:
            return
            
        search_text, replace_text = combo.currentData()
        
        # ç¡®è®¤å¯¹è¯æ¡†
        reply = QMessageBox.question(
            self, 
            "ç¡®è®¤åˆ é™¤", 
            f"ç¡®å®šè¦åˆ é™¤æ›¿æ¢è§„åˆ™ '{search_text} â†’ {replace_text}' å—ï¼Ÿ",
            QMessageBox.Yes | QMessageBox.No, 
            QMessageBox.No
        )
        
        if reply == QMessageBox.Yes:
            replace_history_manager.delete_replace_record(search_text)
            self.update_replace_history_combo(combo)
    
    def apply_all_history(self):
        """åº”ç”¨æ‰€æœ‰å†å²æ›¿æ¢"""
        # ä¿å­˜å½“å‰é…ç½®çŠ¶æ€
        current_preset_selections = self._save_current_preset_selections()
        global_narration_preset = getattr(self, 'global_narration_preset', None)
        global_narration_emotion = getattr(self, 'global_narration_emotion', None)
        
        # æ›¿æ¢æ‰€æœ‰æ®µè½ä¸­çš„æ–‡æœ¬
        for i in range(len(self.segments)):
            self.segments[i] = replace_history_manager.apply_all_replacements(self.segments[i])
        
        # æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œç¡®ä¿æ­£ç¡®é‡æ–°åŠ è½½
        for i in reversed(range(self.content_layout.count())):
            widget = self.content_layout.itemAt(i).widget()
            if widget:
                widget.deleteLater()
        
        # é‡æ–°å¤„ç†å½“å‰æ®µè½ï¼Œè¿™å°†ä½¿ç”¨analyze_text_segmentsé‡æ–°è¯†åˆ«å¯¹è¯
        self.process_current_segment()
        
        # æ¢å¤å…¨å±€é¢„è®¾å’Œæ—ç™½é…ç½®
        self._restore_global_narration_preset(global_narration_preset, global_narration_emotion)
        
        QMessageBox.information(self, "æˆåŠŸ", "å·²åº”ç”¨æ‰€æœ‰å†å²æ›¿æ¢è§„åˆ™")

if __name__ == '__main__':
    app = QApplication(sys.argv)
    app.setStyle('Fusion')  # ä½¿ç”¨Fusioné£æ ¼è·å¾—æ›´ç°ä»£çš„å¤–è§‚
    
    # å¼ºåˆ¶ä½¿ç”¨æµ…è‰²ä¸»é¢˜
    palette = QPalette()
    palette.setColor(QPalette.ColorRole.Window, QColor("#ffffff"))
    palette.setColor(QPalette.ColorRole.WindowText, QColor("#4a5568"))
    palette.setColor(QPalette.ColorRole.Base, QColor("#ffffff"))
    palette.setColor(QPalette.ColorRole.AlternateBase, QColor("#f7f7f7"))
    palette.setColor(QPalette.ColorRole.Text, QColor("#4a5568"))
    palette.setColor(QPalette.ColorRole.Button, QColor("#ffffff"))
    palette.setColor(QPalette.ColorRole.ButtonText, QColor("#4a5568"))
    palette.setColor(QPalette.ColorRole.Highlight, QColor("#C5D8EC"))
    palette.setColor(QPalette.ColorRole.HighlightedText, QColor("#4a5568"))
    app.setPalette(palette)
    
    window = MainWindow()
    window.show()
    
    sys.exit(app.exec()) 